<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Laravel å¯¹å…³è”è¡¨çš„ä¸€äº›æ“ä½œ</title>
    <url>/b22c03d9.html</url>
    <content><![CDATA[<p>Laravel ä¸ºå¼€å‘è€…æä¾›äº†çµæ´»ä¸”ä¼˜é›…çš„ model å±‚ã€‚ä¸è¿‡ï¼Œå› ä¸ºæ–¹æ³•å¤ªå¤šï¼Œæœ‰æ—¶æ€»æ˜¯å¿˜è®°ä¸€äº›æœ‰ç”¨çš„æ–¹æ³•ã€‚è¿™é‡Œå°±ä¸€å¯¹å¤šæ¨¡å‹å…³è”çš„ä¸­å¯¹å…³è”è¡¨çš„ä¸€ä¸ªæ–¹æ³• with çš„ç”¨æ³•åšä¸€ä¸ªè®°å½•</p>
<p>åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œç»å¸¸ä¼šæœ‰è¿™æ ·çš„åœºæ™¯ï¼Œä¸€ä¸ªç”¨æˆ·ä¸Šä¼ æœ‰å¤šä¸ªå›¾ç‰‡ï¼Œè€Œå›¾ç‰‡åªå½’å±äºä¸€ä¸ªç”¨æˆ·ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸€å¯¹å¤šå…³è”ï¼Œå‡è®¾ç”¨æˆ·è¡¨ users å’Œ å›¾ç‰‡è¡¨ imagesã€‚images è¡¨ä¸­æœ‰ä¸€ä¸ªuser_id å­—æ®µç”¨æ¥æ ‡è®°å›¾ç‰‡æ‰€å±çš„ç”¨æˆ·ã€‚</p>
<a id="more"></a>

<p>åœ¨ users æ¨¡å‹ä¸­åˆ›å»ºå…³è”ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…³è”å›¾ç‰‡è¡¨</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">images</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;ï»¿</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(Images::class, <span class="string">&#x27;user_id&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶è®¿é—®é›†åˆä¸­çš„ images å±æ€§å°±å¯ä»¥è®¿é—®åˆ°æ‰€æœ‰å±äºæ­¤ç”¨æˆ·çš„å›¾ç‰‡äº†ã€‚</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$user</span>   = User::where(<span class="string">&#x27;id&#x27;</span>, <span class="variable">$userId</span>))-&gt;first();</span><br><span class="line"><span class="comment">// è¿™é‡Œæœ€å¥½åŠ ä¸Šåˆ¤æ–­ï¼Œå¦‚æœæ˜¯ null å°±ä¸å­˜åœ¨ images å±æ€§</span></span><br><span class="line"><span class="variable">$images</span> = <span class="variable">$user</span>-&gt;images;<span class="comment">// è¿™å°±æ˜¯è¿™ä¸ªç”¨æˆ·çš„æ‰€æœ‰å›¾ç‰‡</span></span><br></pre></td></tr></table></figure>
<p>ç„¶è€Œï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¸éœ€è¦å–å‡º images è¡¨çš„æ‰€æœ‰å­—æ®µï¼Œæˆ‘ä»¬åªéœ€è¦ path ä¸€ä¸ªå­—æ®µå³å¯ã€‚</p>
<p>ä½†å¦‚æœç›´æ¥ä½¿ç”¨ select([â€˜pathâ€™]) æ–¹æ³•çš„è¯ï¼Œæ˜¯æŸ¥æ‰¾çš„ users è¡¨ä¸­çš„ path å­—æ®µï¼Œç„¶è€Œ users è¡¨ä¸­å¹¶ä¸å­˜åœ¨ path å­—æ®µï¼Œè¿™æ ·ä½¿ç”¨ä¼šäº§ç”Ÿé”™è¯¯ï¼Œè¿™æ ·å°±éœ€è¦ç”¨åˆ°ä¸‹é¢çš„æ–¹æ³•ã€‚</p>
<blockquote>
<p>å…³äºé¢„åŠ è½½ç”¨æ³•å¯ä»¥å‚è€ƒ <a href="https://learnku.com/docs/laravel/6.x/eloquent-relationships/5177#012e7e">æ–‡æ¡£</a></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$images</span> = User::getAnchorByUuid(<span class="variable">$request</span>-&gt;get(<span class="string">&#x27;uuid&#x27;</span>))</span><br><span class="line">            -&gt;with([</span><br><span class="line">                <span class="string">&#x27;images&#x27;</span> =&gt; <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$query</span></span>) </span>&#123;</span><br><span class="line">                    <span class="variable">$query</span>-&gt;select([<span class="string">&#x27;path&#x27;</span>, <span class="string">&#x27;user_id&#x27;</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            ])</span><br><span class="line">            -&gt;first()</span><br><span class="line">            -&gt;images;</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$images</span> = User::where(<span class="string">&#x27;id&#x27;</span>, <span class="variable">$request</span>-&gt;get(<span class="string">&#x27;uuid&#x27;</span>))</span><br><span class="line">            -&gt;with(<span class="string">&#x27;images:path,user_id&#x27;</span>)</span><br><span class="line">            -&gt;first()</span><br><span class="line">            -&gt;images;</span><br></pre></td></tr></table></figure>
<p>with å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²æˆ–è€…æ•°ç»„ï¼Œæ•°ç»„çš„å€¼å¯ä»¥æ˜¯é—­åŒ…å‡½æ•°ï¼Œç¬¬ä¸€ç§æ–¹å¼æ›´åŠ çµæ´»ï¼Œç¬¬äºŒç§åˆ™æ›´åŠ ç®€ä¾¿ï¼Œé—­åŒ…ä¸­å¯ä»¥ä½¿ç”¨æ›´å¤šçš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$images</span> = User::getAnchorByUuid(<span class="variable">$request</span>-&gt;get(<span class="string">&#x27;uuid&#x27;</span>))</span><br><span class="line">            -&gt;with([</span><br><span class="line">                <span class="string">&#x27;images&#x27;</span> =&gt; <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$query</span></span>) </span>&#123;</span><br><span class="line">                    <span class="variable">$query</span>-&gt;orderByDesc(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">                    <span class="variable">$query</span>-&gt;where(<span class="string">&#x27;status&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            ]);</span><br></pre></td></tr></table></figure>
<p>æœ¬ç¯‡æ–‡ç« å°±åˆ°æ­¤ç»“æŸäº†ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è®°å½•ä¸€ä¸‹ with çš„ç”¨æ³•ã€‚</p>
]]></content>
      <categories>
        <category>Laravel</category>
      </categories>
      <tags>
        <tag>Laravel</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP8æ–°ç‰¹æ€§ä¹‹matchè¡¨è¾¾å¼</title>
    <url>/2aa0d8c4.html</url>
    <content><![CDATA[<p>PHP8 alpha2å‘å¸ƒäº†ï¼Œæœ€è¿‘å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å…³é”®å­—ï¼šmatch, è¿™ä¸ªå…³é”®å­—çš„ä½œç”¨è·Ÿswitchæœ‰ç‚¹ç±»ä¼¼ã€‚</p>
<p>è™½ç„¶æˆ‘ä¸€èˆ¬å¯¹è¯­æ³•ç³–æ— æ„Ÿï¼Œä½†è¿™ä¸ªæˆ‘è§‰å¾—è¿˜æ˜¯æœ‰ç‚¹æ„æ€ï¼Œmatchè¿™ä¸ªè¯ä¹ŸæŒºå¥½çœ‹ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¹²å•¥çš„å‘¢ï¼Ÿ</p>
<a id="more"></a>
<p>åœ¨ä»¥å‰æˆ‘ä»¬å¯èƒ½ä¼šç»å¸¸ä½¿ç”¨switchåšå€¼è½¬æ¢ç±»çš„å·¥ä½œï¼Œç±»ä¼¼:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">switch</span> (<span class="variable">$input</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;true&quot;</span>:</span><br><span class="line">        <span class="variable">$result</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;false&quot;</span>:</span><br><span class="line">        <span class="variable">$result</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;null&quot;</span>:</span><br><span class="line">        <span class="variable">$result</span> = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(å½“ç„¶ï¼Œæœ‰çš„åŒå­¦ä¼šè¯´ï¼Œè°ä¼šè¿™ä¹ˆå†™ï¼Œç”¨ä¸ªæ•°ç»„è½¬æ¢ä¸è¡Œä¹ˆï¼Ÿ æ‹œæ‰˜ï¼Œè¿™æ˜¯ä¸¾ä¾‹å•Šï¼Œæ•°ç»„ä¹Ÿåªèƒ½æ•°å­—é”®å’Œæ•´æ•°å•Šï¼Œä¸‡ä¸€keyæ˜¯éœ€è¦å…¶ä»–è¡¨è¾¾å¼å‘¢ï¼Œä¸‡ä¸€ä½ è¦å¤šä¸ªkeyå¯¹åº”ä¸€ä¸ªå€¼å‘¢ï¼Œå¯¹å§ï¼Ÿ)</p>
<p>é‚£ä¹ˆå¦‚æœä½¿ç”¨matchå…³é”®å­—å‘¢ï¼Œå¯ä»¥å˜æˆç±»ä¼¼:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$result</span> = <span class="keyword">match</span>(<span class="variable">$input</span>) &#123;</span><br><span class="line">        <span class="string">&quot;true&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;false&quot;</span> =&gt; <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;null&quot;</span> =&gt; <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç›¸æ¯”switchï¼Œ matchä¼šç›´æ¥è¿”å›å€¼ï¼Œå¯ä»¥ç›´æ¥èµ‹å€¼ç»™<code>$result</code>äº†ã€‚</p>
<p>å¹¶ä¸”ï¼Œç±»ä¼¼switchçš„å¤šä¸ªcaseä¸€ä¸ªblockä¸€æ ·ï¼Œmatchçš„å¤šä¸ªæ¡ä»¶ä¹Ÿå¯ä»¥å†™åœ¨ä¸€èµ·ï¼Œæ¯”å¦‚:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$result</span> = <span class="keyword">match</span>(<span class="variable">$input</span>) &#123;</span><br><span class="line">    <span class="string">&quot;true&quot;</span>, <span class="string">&quot;on&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;false&quot;</span>, <span class="string">&quot;off&quot;</span> =&gt; <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;null&quot;</span>, <span class="string">&quot;empty&quot;</span>, <span class="string">&quot;NaN&quot;</span> =&gt; <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„å’Œswitchä¸å¤ªä¸€æ ·çš„æ˜¯ï¼Œä»¥å‰æˆ‘ä»¬ç”¨switchå¯èƒ½ä¼šç»å¸¸é‡åˆ°è¿™ç§è¯¡å¼‚çš„é—®é¢˜:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$input</span> = <span class="string">&quot;2 person&quot;</span>;</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$input</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;bad&quot;</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°ï¼Œbadç«Ÿç„¶è¢«è¾“å‡ºäº†ï¼Œè¿™æ˜¯å› ä¸ºswitchä½¿ç”¨äº†å®½æ¾æ¯”è¾ƒ<code>==</code>ã€‚matchå°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜äº†, å®ƒä½¿ç”¨çš„æ˜¯ä¸¥æ ¼æ¯”è¾ƒ<code>===</code>ï¼Œå°±æ˜¯å€¼å’Œç±»å‹éƒ½è¦å®Œå…¨ç›¸ç­‰ã€‚</p>
<p>è¿˜æœ‰å°±æ˜¯ï¼Œå½“inputå¹¶ä¸èƒ½è¢«matchä¸­çš„æ‰€æœ‰æ¡ä»¶æ»¡è¶³çš„æ—¶å€™ï¼Œmatchä¼šæŠ›å‡ºä¸€ä¸ªUnhandledMatchError exception:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$input</span> = <span class="string">&quot;false&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="keyword">match</span>(<span class="variable">$input</span>) &#123;</span><br><span class="line">        <span class="string">&quot;true&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¼šå¾—åˆ°:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Fatal error: Uncaught UnhandledMatchError: Unhandled match value of type string</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±ä¸ç”¨æ‹…å¿ƒä¸‡ä¸€matchæ¡ä»¶æ²¡å†™å…¨å¯¼è‡´äº†ä¸å¯é¢„çŸ¥çš„é”™è¯¯ã€‚</p>
<p>å¦å¤–è¿˜æ˜¯è¦è¯´æ˜ï¼Œmatchæ˜¯å…³é”®å­—ï¼Œä¹Ÿå°±æ˜¯ä»PHP8å¼€å§‹å®ƒä¸èƒ½å‡ºç°åœ¨namespaceæˆ–è€…ç±»åä¸­ï¼Œå¦‚æœä½ çš„é¡¹ç›®ä¸­æœ‰ç”¨matchä½œä¸ºç±»åçš„:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Match</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨PHP8å¼€å§‹å°†ä¼šå¾—åˆ°è¯­æ³•é”™è¯¯äº†, å½“ç„¶ï¼Œæ–¹æ³•åä¸­è¿˜æ˜¯å¯ä»¥ç”¨çš„ã€‚</p>
<p>è¯¦ç»†çš„ï¼Œå¯ä»¥å‚è€ƒ<a href="https://wiki.php.net/rfc/match_expression_v2">RFCï¼šMatch Expression</a></p>
<p>ä»¥ä¸Šï¼Œæ²¡äº†ã€‚</p>
<blockquote>
<p>æœ¬æ–‡è½¬è½½è‡ª <a href="https://www.laruence.com/2020/07/13/6033.html">laruence.com</a></p>
</blockquote>
]]></content>
      <categories>
        <category>PHP8</category>
      </categories>
      <tags>
        <tag>è½¬è½½</tag>
        <tag>PHP8</tag>
      </tags>
  </entry>
  <entry>
    <title>æˆ‘å±…ç„¶è¿˜æœ‰ä¸€ä¸ªåšå®¢ï¼Ÿï¼</title>
    <url>/e86f1947.html</url>
    <content><![CDATA[<p>æ˜¨å¤©åšæ¢¦çš„æ—¶å€™çªç„¶åœ¨æ¢¦ä¸­æƒ³èµ·ï¼Œæˆ‘å±…ç„¶è¿˜æœ‰è¿™ä¹ˆä¸ªåšå®¢ ğŸ˜‚ è‡ªä»æœåŠ¡å™¨åˆ°æœŸå¿˜äº†ç»­è´¹ä¹‹åï¼Œå°±å†ä¹Ÿæ²¡å†™è¿‡åšå®¢äº†ã€‚</p>
<a id="more"></a>

<p>å› ä¸ºä»¥å‰çš„æœåŠ¡å™¨ä»·æ ¼ä¸å¤ªåˆé€‚ï¼Œè€Œä¸”é™¤äº†å‘ä¸ªåšå®¢å…¶ä»–æ—¶å€™åŸºæœ¬ä¸Šä¸€ç‚¹ç”¨å¤„éƒ½æ²¡æœ‰ã€‚ã€‚</p>
<p>ä»¥å‰çš„å†…å®¹ä¹Ÿéƒ½æ²¡æœ‰äº†ï¼Œå› ä¸ºä»¥å‰çš„åšå®¢æ˜¯ç›´æ¥æ­å»ºåœ¨æœåŠ¡å™¨ä¸Šçš„ï¼Œæ—¶é—´ä¹…äº†ä¹‹åæ•°æ®åº“æ²¡äº†ï¼Œä¹Ÿæ²¡æœ‰å¤‡ä»½ã€‚ã€‚å®æƒ¨</p>
<p>ä¸è¿‡å¿½ç„¶æƒ³èµ·æ¥ä»¥å‰åœ¨æ­å»ºåšå®¢çš„æ—¶å€™é¡ºä¾¿ç”¨ gitpage æ­äº†ä¸€ä¸ªhexoåšå®¢ï¼Œä½†å‘äº†å‡ ä¸ªæ–‡ç« ä¹‹åè§‰å¾—å¾ˆéº»çƒ¦ï¼Œå› ä¸ºè¦ç”¨ç”µè„‘ç¼–è¾‘ï¼Œè¿˜è¦å†æ‰§è¡Œå‘½ä»¤ï¼Œå„ç§é…ç½®ï¼Œè€Œä¸”æäº¤è¿˜è¦äº¤åˆ°githubæ‰èƒ½å‡ºæ•ˆæœï¼Œæ¯”ä»¥å‰é¡µé¢ç¼–è¾‘è¦éº»çƒ¦å¾ˆå¤šï¼Œè¿˜ä¸èƒ½ç”¨æ‰‹æœºç¼–è¾‘ã€‚</p>
<p>æœåŠ¡å™¨æš‚æ—¶ä¸å‡†å¤‡å†ä¹°äº†ï¼Œå°±æš‚æ—¶æ”¾åˆ°gitpageä¸Šå§ï¼Œè¿™ä¹ˆä¸€æƒ³å¥½åƒä¹Ÿä¸é‚£ä¹ˆçš„éº»çƒ¦äº†ï¼Œå“ˆå“ˆå“ˆå“ˆã€‚</p>
]]></content>
      <categories>
        <category>æ•£äº‹</category>
      </categories>
      <tags>
        <tag>æ•£äº‹</tag>
      </tags>
  </entry>
  <entry>
    <title>è°ƒä¼‘çš„ä¸€å¤©</title>
    <url>/7b0f9d9.html</url>
    <content><![CDATA[<p><img src="https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=536836266,488945292&fm=26&gp=0.jpg"></p>
<a id="more"></a>
<p>å‘¨å…­ï¼Œæœ¬æ¥è¦ä¼‘æ¯çš„æ—¥å­ï¼Œæˆ‘å´è¿˜åœ¨ä¸Šç­ğŸ˜‚</p>
<p>ä¸è¿‡ä¸æ˜¯åŠ ç­ï¼Œè°è®©æˆ‘ä¸Šæ¬¡è°ƒä¼‘ä¼‘æ¯è¿‡äº†ã€‚è®©æˆ‘æƒ³èµ·ä¸€å¥ç»å…¸å°è¯â€œå‡ºæ¥æ··ï¼Œè¿Ÿæ—©è¦è¿˜çš„â€è¿™ä¸ã€‚æ¥è¡¥ç­äº†å˜›ã€‚</p>
<p>ä¸è¿‡ä¹ŸæŒºå¥½ï¼Œäººå°‘æ¸…å‡€ï¼Œå°±è¿å¹³æ—¶é¢†å¯¼åœ¨æ—¶è·Ÿåªé¸¡å´½ä¸€æ ·çš„åŒäº‹ï¼Œéƒ½å¤§èƒ†çš„ç©èµ·äº†æ¸¸æˆã€‚çœŸèœï¼</p>
]]></content>
      <categories>
        <category>æ•£äº‹</category>
      </categories>
  </entry>
  <entry>
    <title>è€å¸æœºå¸¦ä½ å®ç°Laravelè·¯ç”±æ³¨å†ŒåŠŸèƒ½</title>
    <url>/8e934fac.html</url>
    <content><![CDATA[<h2 id="æ„Ÿæ…¨"><a href="#æ„Ÿæ…¨" class="headerlink" title="æ„Ÿæ…¨"></a>æ„Ÿæ…¨</h2><p>å­¦ä¹ æ€»æ˜¯é‚£ä¹ˆçš„ä¸å®¹æ˜“ï¼Œå¸Œæœ›è®©å…„å¼Ÿä»¬é¢†ç•¥Laravelç¼–ç¨‹æŠ€å·§ï¼Œèµ°è¿›Laravelæ·±å¤„çš„æˆ‘æ›´ä¸å®¹æ˜“ï¼Œæ¯æ¬¡ç»™å¤§å®¶å†™ä»£ç ï¼Œæˆ‘æ€»æ˜¯æ€è€ƒè¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•èƒ½è®©å¤§å®¶æ˜ç™½æˆ‘æƒ³è®©ä½ ä»¬æ˜ç™½çš„ä¸œè¥¿ï¼Œä¸å¯å¦è®¤è¿™æ˜¯ä¸€ä»¶éå¸¸å›°éš¾çš„äº‹ï¼Œæ‰€ä»¥æˆ‘åªèƒ½æ„Ÿæ…¨ï¼šæˆ‘å¤ªéš¾äº†ã€‚å®Œæˆè¿™ç¯‡åšæ–‡å·²ç»æ˜¯2019å¹´11æœˆ28æ—¥å‡Œæ™¨2ç‚¹äº†ï¼Œæˆ‘ä¹Ÿè¦ç¡äº†ã€‚</p>
<p><img src="https://cdn.learnku.com/uploads/images/201911/27/39566/FEnNUW2kRi.gif!large"></p>
<a id="more"></a>

<h2 id="ç»ˆæç›®æ ‡"><a href="#ç»ˆæç›®æ ‡" class="headerlink" title="ç»ˆæç›®æ ‡"></a>ç»ˆæç›®æ ‡</h2><p>ä¹‹å‰å†™äº†ä¸€ç¯‡åšæ–‡ã€Š<a href="https://learnku.com/articles/36590/">å¤§å®¶å¯¹ Laravel çš„æºä»£ç å’Œæ¶æ„æ„Ÿå…´è¶£ä¹ˆï¼Ÿ</a>ã€‹,ç›¸ä¿¡å¾ˆå¤šäººå·²ç»çœ‹è¿‡äº†ï¼Œä¹Ÿéƒ½è¡¨ç¤ºäº†æå¤§çš„å…´è¶£ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘å¯¹å¤§å®¶çš„æ‰¿è¯ºï¼Œæ‰€ä»¥ä»ä¸Šä¸€ç¯‡åšæ–‡ã€Š<a href="https://learnku.com/articles/37162">è¯¦è§£ PHP åå°„çš„åŸºæœ¬ä½¿ç”¨</a>ã€‹å¼€å§‹ï¼Œæˆ‘å°±å‡†å¤‡ç»™å¤§å®¶è®²è§£Laravelçš„ç›¸å…³çŸ¥è¯†ï¼Œè®²è§£Laravelçš„ä»£ç éå¸¸ä¸å®¹æ˜“ï¼Œéœ€è¦é˜…è¯»è€…å…·å¤‡ç›¸å½“çš„ç¼–ç¨‹èƒ½åŠ›ï¼Œå¯¹è®¾è®¡æ¨¡å¼æœ‰ä¸€å®šçš„è®¤è¯†å’Œé¡½å¼ºçš„æ¯…åŠ›ï¼Œæœ€åä½†å¹¶ä¸æ˜¯æœ€ä¸é‡è¦çš„å°±æ˜¯æå¤§çš„å¥½å¥‡å¿ƒã€‚æ‰€ä»¥ä¸ºäº†å¤§å®¶èƒ½å¤Ÿè¯»æ‡‚ï¼Œæˆ‘ä¼šç»™å¤§å®¶ç¼–å†™åŠŸèƒ½å’ŒLaravelç›¸å½“çš„ç¨‹åºï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ç®€åŒ–ç‰ˆï¼Œè¿™æ ·æœ€æœ‰åŠ©äºå¤§å®¶çš„ç†è§£ï¼Œå¦‚æœå¤§å®¶ç†è§£äº†æˆ‘å†™çš„ï¼Œæ—¥åå†æ¥é˜…è¯»Laravelï¼Œå°†ä¼šè½»è½¦ç†Ÿè·¯ã€‚</p>
<h2 id="æœ¬èŠ‚ç›®æ ‡"><a href="#æœ¬èŠ‚ç›®æ ‡" class="headerlink" title="æœ¬èŠ‚ç›®æ ‡"></a>æœ¬èŠ‚ç›®æ ‡</h2><p>åœ¨æœ¬ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘å°†ä¼šç»™å¤§å®¶å®ç°ä¸€ä¸ªç±»ä¼¼<strong>Laravelè·¯ç”±æ³¨å†Œçš„åŠŸèƒ½</strong>ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨Laravelå½“ä¸­éå¸¸é‡è¦ï¼Œå¸Œæœ›å¤§å®¶èƒ½å¤Ÿç†è§£ï¼Œä»£ç æˆ‘å·²ç»ä¸Šä¼ åˆ°äº†ç äº‘<a href="https://gitee.com/obamajs/laravel-route-register">laravel-route-register</a>ï¼Œè¿™æ˜¯æˆ‘åœ¨ä¸‹ç­ä¹‹åç»™å¤§å®¶å†™çš„ï¼Œå®å±ä¸æ˜“ï¼Œå¸Œæœ›å¤§å®¶çæƒœï¼Œä»“åº“ä»£ç æˆªå›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.learnku.com/uploads/images/201911/27/39566/UyVGnsuHyZ.png!large" alt="è€å¸æœºå¸¦ä½ å®ç°Laravelè·¯ç”±æ³¨å†ŒåŠŸèƒ½"></p>
<p>è¿™ä¸ªdebug.phpæ–‡ä»¶çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.learnku.com/uploads/images/201911/27/39566/aOQh55akQH.png!large" alt="è€å¸æœºå¸¦ä½ å®ç°Laravelè·¯ç”±æ³¨å†ŒåŠŸèƒ½"></p>
<p>ä¸Šå›¾å°±æ˜¯æˆ‘ä»¬ä»Šå¤©æ‰€è¦å®ç°çš„åŠŸèƒ½ï¼Œè¿™ä¸ªåµŒå¥—æ˜¯å®Œå…¨æ²¡æœ‰é™åˆ¶çš„ï¼Œä½ å¯ä»¥ä»»æ„ç»„åˆapiï¼Œå¸Œæœ›å¤§å®¶æŠŠæºä»£ç ä¸‹è½½ä¸‹æ¥ï¼Œå†é…åˆæˆ‘å†™çš„è¿™ç¯‡åšæ–‡ï¼Œä¸€å®šè¦è¯»æ‡‚å®ƒï¼Œè¿™æ˜¯ä½ ç†è§£ä»»ä½•PHPæ¡†æ¶æ‰€ä¸å¯æˆ–ç¼ºçš„å¿…è¦æ­¥éª¤ã€‚</p>
<h2 id="é˜…è¯»å‡†å¤‡"><a href="#é˜…è¯»å‡†å¤‡" class="headerlink" title="é˜…è¯»å‡†å¤‡"></a>é˜…è¯»å‡†å¤‡</h2><p>åœ¨é˜…è¯»ä»¥ä¸‹çš„å†…å®¹ä¹‹å‰ï¼Œè¯·å…ˆå‚è€ƒlaravelè·¯ç”±ç›¸å…³æ–‡æ¡£ï¼Œ<a href="https://laravel.com/docs/6.x/routing">Laravelè·¯ç”±</a>ï¼Œé¦–å…ˆææ¸…æ¥šLaravelæ³¨å†Œè·¯ç”±çš„å¯æ“ä½œAPIã€‚</p>
<h2 id="æ–‡ä»¶ç®€ä»‹"><a href="#æ–‡ä»¶ç®€ä»‹" class="headerlink" title="æ–‡ä»¶ç®€ä»‹"></a>æ–‡ä»¶ç®€ä»‹</h2><p>ä¸Šé¢æˆ‘å·²ç»è´´å‡ºäº†è¿™ä¸ªåŒ…çš„å‡ ä¸ªæ–‡ä»¶ï¼Œä¸‹é¢æˆ‘ä¼šä»”ç»†çš„è®²è§£ä¸‹åˆ—æ–‡ä»¶ï¼š</p>
<ol>
<li>Routeræ–‡ä»¶æ˜¯æˆ‘ä»¬çš„è·¯ç”±å™¨æ–‡ä»¶ï¼Œæˆ‘ä»¬æ³¨å†Œè·¯ç”±å°±æ˜¯é€šè¿‡å®ƒè¿›è¡Œçš„ï¼Œæ¯”å¦‚å®ƒç»™æˆ‘ä»¬æä¾›çš„apiæœ‰ï¼šgetï¼Œpostï¼Œwhereï¼Œnamespaceï¼Œprefixï¼Œè¿™å‡ ä¸ªæ–¹æ³•æ˜¯æˆ‘ä»¬æ“çºµè·¯ç”±å™¨çš„æ¥å£ã€‚</li>
<li>RouteRegistraræ–‡ä»¶ï¼Œä¸­æ–‡ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼šè·¯ç”±æ³¨å†Œå•†ï¼Œè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹å¾ˆç®€å•ï¼Œå®ƒçš„ä½œç”¨æ˜¯æä¾›ç»™æˆ‘ä»¬è·¯ç”±åµŒå¥—çš„èƒ½åŠ›ï¼Œä¹‹æ‰€ä»¥groupæ–¹æ³•èƒ½å¤Ÿåšåˆ°è·¯ç”±åµŒå¥—ï¼Œå°±æ˜¯å› ä¸ºè¿™ä¸ªç±»å’ŒRouteræ–‡ä»¶<strong>ç›¸äº’ä½œç”¨</strong>çš„ç»“æœï¼Œåªå‡­å®ƒæ˜¯æ— æ³•åšåˆ°è¿™ä¸€ç‚¹çš„ã€‚</li>
<li>Routeæ–‡ä»¶ï¼Œæ¯ä¸€æ¡è·¯ç”±å®é™…ä¸Šéƒ½æ˜¯ä¸€ä¸ªRouteç±»çš„å¯¹è±¡ï¼Œæ‰€ä»¥ä½ æ˜ç™½å®ƒçš„æ„æ€äº†å§ï¼Ÿ</li>
</ol>
<h2 id="ä»£ç è®²è§£"><a href="#ä»£ç è®²è§£" class="headerlink" title="ä»£ç è®²è§£"></a>ä»£ç è®²è§£</h2><p>åœ¨ä»¥åçš„ä»£ç è®²è§£ä¸­ï¼Œæˆ‘éƒ½ä¸ä¼šè´´å‡ºä»£ç çš„å®Œæ•´ç‰ˆï¼Œå› ä¸ºè¿™æ ·å¾ˆå½±å“åšæ–‡çš„æ„Ÿå®˜ä½“éªŒï¼Œå‡ é¡µéƒ½æ˜¯ä»£ç ï¼Œæ‰€ä»¥å¸Œæœ›å¤§å®¶ä¸‹è½½ä¸‹æ¥ï¼Œä¸ç„¶ä½ è¯»è¿™ç¯‡åšæ–‡æ²¡å•¥æ„ä¹‰ï¼ŒçœŸçš„æ²¡å•¥ç”¨ã€‚</p>
<p>é¦–å…ˆä»æœ€ç®€å•çš„å¼€å§‹å§ï¼</p>
<p>Routeræœ‰ä¸ªé™æ€çš„getæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±å¯¹åº”ç€getè¯·æ±‚äº†ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$rule</span>, <span class="variable">$action</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$route</span> = <span class="built_in">self</span>::newRoute(<span class="built_in">self</span>::REQUEST_METHOD_GET, <span class="variable">$rule</span>, <span class="variable">$action</span>);</span><br><span class="line">    <span class="built_in">self</span>::getInstance()</span><br><span class="line">        -&gt;addRouteToContainer(<span class="variable">$route</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$route</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>REQUEST_METHOD_GETæ˜¯æˆ‘å®šä¹‰çš„å¸¸é‡ä¸ºâ€GETâ€ï¼Œgetæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè·¯ç”±è§„åˆ™ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºä½ çš„æ§åˆ¶å™¨æˆ–è€…æ˜¯å›è°ƒæ–¹æ³•ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Router::get(<span class="string">&#x27;dashboard&#x27;</span>, <span class="string">&#x27;DashboardController@index&#x27;</span>);</span><br><span class="line">Router::get(<span class="string">&#x27;/call&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>getæ–¹æ³•é¦–å…ˆè°ƒç”¨newRouteæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">newRoute</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$rule</span>, <span class="variable">$action</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$inst</span> = <span class="built_in">self</span>::getInstance();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$inst</span>-&gt;groupStack)) &#123;</span><br><span class="line">        <span class="variable">$attributes</span> = end(<span class="variable">$inst</span>-&gt;groupStack);</span><br><span class="line">        <span class="variable">$rule</span> = <span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>]) ?</span><br><span class="line">            rtrim(<span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>], <span class="string">&#x27;/&#x27;</span>) . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$rule</span> : <span class="variable">$rule</span>;</span><br><span class="line">        <span class="keyword">if</span> (is_string(<span class="variable">$action</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$action</span> = trim(<span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>], <span class="string">&#x27;\\&#x27;</span>) . <span class="string">&#x27;\\&#x27;</span> . <span class="variable">$action</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$attributes</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$route</span> = <span class="keyword">new</span> Route(<span class="variable">$method</span>, <span class="variable">$rule</span>, <span class="variable">$action</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;where&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$route</span>-&gt;where(<span class="variable">$attributes</span>[<span class="string">&#x27;where&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$route</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºåœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­ï¼ŒRouterå®ä¾‹ä¸€èˆ¬éƒ½æ˜¯å•ä¾‹çš„ï¼Œæ‰€ä»¥æˆ‘æŠŠå®ƒçš„æ„é€ å™¨å£°æ˜ä¸ºç§æœ‰çš„ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨æ— æ³•è°ƒç”¨å®ƒï¼ŒgetInstanceæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">self</span>::<span class="variable">$instance</span>) &#123;</span><br><span class="line">        <span class="built_in">self</span>::<span class="variable">$instance</span> = <span class="keyword">new</span> <span class="built_in">self</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$instance</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å›åˆ°æ–¹æ³•newRouteä¸­ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥groupStackå±æ€§æ˜¯å¦ä¸ºç©ºï¼Œè¿™ä¸ªå±æ€§æ˜¯å¹²å•¥çš„å‘¢ï¼Ÿæˆ‘å¯ä»¥æå‰å‘Šè¯‰å¤§å®¶ï¼Œä¹‹æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®ç°groupæ“ä½œï¼Œå®ƒçš„åŠŸåŠ³åŠŸä¸å¯æ²¡ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆå‡è®¾å®ƒçš„å€¼ä¸ºç©ºï¼ˆåé¢åˆ†ægroupæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†æ¥çœ‹å®ƒï¼‰ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å¾€ä¸‹èµ°å°±åˆ›å»ºäº†ä¸€ä¸ªRouteå¯¹è±¡äº†ï¼Œæœ€åçš„issetæ£€æŸ¥ä¹Ÿæ˜¯å’Œgroupæœ‰å…³ï¼Œæˆ‘ä»¬åé¢å†åˆ†æï¼ŒnewRouteç²—ç•¥åˆ†æå®Œæˆï¼Œæˆ‘ä»¬å›åˆ°getæ–¹æ³•ä¸­ï¼Œè°ƒç”¨Routerå®ä¾‹å¯¹è±¡çš„addRouteToContaineræ–¹æ³•æ·»åŠ åˆ°å®¹å™¨ä¸­ã€‚</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">addRouteToContainer</span>(<span class="params">Route <span class="variable">$route</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;routeCollection[] = <span class="variable">$route</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>postæ–¹æ³•å’Œgetæ–¹æ³•åŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬ä¸åœ¨åˆ†æã€‚</p>
<p>è¿™é‡Œç»™å¤§å®¶ä¸€ä¸ªä½¿ç”¨Phpstormçš„æŠ€å·§ï¼Œå¦‚æœä½ çš„ç±»æä¾›äº†åŠ¨æ€çš„æ–¹æ³•ï¼ˆ<strong>__call</strong>æˆ–è€…<strong>__callStatic</strong>æä¾›çš„æ–¹æ³•ï¼‰ï¼Œä½ æƒ³è®©Phpstormç»™ä½ ä»£ç æç¤ºï¼Œä½ å¯ä»¥æŒ‰æˆ‘ä¸‹é¢çš„æ–¹æ³•æ“ä½œï¼š</p>
<p><img src="https://cdn.learnku.com/uploads/images/201911/28/39566/XWqHpGSDkG.png!large" alt="è€å¸æœºå¸¦ä½ å®ç°Laravelè·¯ç”±æ³¨å†ŒåŠŸèƒ½"></p>
<p>æ¯”å¦‚æˆ‘çš„Routerç±»ï¼Œå®ƒæä¾›äº†ä¸‰ä¸ªé™æ€æ–¹æ³•whereï¼Œnamespaceå’Œprefixï¼Œæˆ‘å°±åœ¨Routerç±»çš„ä¸Šé¢å†™ä¸‰ä¸ª**@method** ï¼Œå¦‚æœæ˜¯é™æ€æ–¹æ³•çš„è¯ï¼ŒåŠ ä¸Šstaticå‰ç¼€ï¼Œç´§æ¥ç€å†™å‡½æ•°çš„è¿”å›å€¼ç±»å‹ï¼Œç„¶åæ–¹æ³•åï¼Œæœ€åæ‹¬å·åŠ ä¸Šå‚æ•°åï¼Œè¿™æ˜¯å¸¸ç”¨çš„æŠ€å·§ï¼Œå¸Œæœ›å¤§å®¶ç†ŸçŸ¥ã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹Routerç±»</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (in_array(<span class="variable">$name</span>, [<span class="string">&#x27;where&#x27;</span>, <span class="string">&#x27;namespace&#x27;</span>, <span class="string">&#x27;prefix&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> RouteRegistrar(<span class="built_in">self</span>::getInstance()))-&gt;<span class="variable">$name</span>(<span class="variable">$arguments</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&quot;method $&#123;name&#125; not exist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒå®ç°äº†__callStaticæ–¹æ³•ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬èƒ½å¤Ÿè°ƒç”¨whereï¼Œnamespaceå’Œprefixè¿™ä¸‰ä¸ªé™æ€æ–¹æ³•çš„åŸå› ã€‚å¯¹__callStaticä¸ç†Ÿæ‚‰çš„å…„å¼Ÿï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼Œå½“ä½ è°ƒç”¨ä¸€ä¸ªç±»Açš„é™æ€æ–¹æ³•showæ—¶ï¼Œå¦‚æœè¿™ä¸ªé™æ€æ–¹æ³•showä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨__callStaticæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä½ çš„é™æ€æ–¹æ³•åshowï¼Œç¬¬äºŒä¸ªå‚æ•° $argumentsæ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«ä½ ä¼ é€’ç»™é™æ€æ–¹æ³•showçš„æ‰€æœ‰å‚æ•°ï¼Œæ¯”å¦‚ä½ è°ƒç”¨A::show(1,2,3,4)ï¼Œé‚£ä¹ˆ $argumentså°±æ˜¯[1ï¼Œ2ï¼Œ3ï¼Œ4]ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ã€‚è¿›å…¥åˆ°__callStaticæ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­å¦‚æœæˆ‘ä»¬è°ƒç”¨çš„é™æ€æ–¹æ³•ä¸ºâ€™whereâ€™, â€˜namespaceâ€™, â€˜prefixâ€™ä¸‰ä¸ªä¸­çš„ä¸€ä¸ªï¼Œé‚£ä¹ˆä¼šè¿”å›ä¸€ä¸ªRouteRegistrarç±»çš„å¯¹è±¡ï¼Œè¿™ä¸ªç±»çš„å®ç°å¾ˆç®€å•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">RouteRegistrar</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> $router Router</span></span><br><span class="line"><span class="comment">     * **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$router</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$attributes</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">Router <span class="variable">$router</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;router = <span class="variable">$router</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$name</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;attributes[<span class="string">&#x27;where&#x27;</span>][<span class="variable">$key</span>] = <span class="variable">$value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;attributes[<span class="string">&#x27;where&#x27;</span>][<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">namespace</span>(<span class="params"><span class="variable">$namespace</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;attributes[<span class="string">&#x27;namespace&#x27;</span>] = <span class="variable">$namespace</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prefix</span>(<span class="params"><span class="variable">$prefix</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;attributes[<span class="string">&#x27;prefix&#x27;</span>] = <span class="variable">$prefix</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">group</span>(<span class="params"><span class="keyword">callable</span> <span class="variable">$callback</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;router-&gt;group(<span class="keyword">$this</span>-&gt;attributes, <span class="variable">$callback</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒçš„æ„é€ æ–¹æ³•æ¥å—æˆ‘ä»¬çš„Routerå¯¹è±¡å®ä¾‹ï¼Œè¿™ä¸ª$routerå±æ€§ä¼šåœ¨åé¢çš„groupæ–¹æ³•ä¸­ç”¨åˆ°ï¼Œåé¢ä¼šè®²ï¼Œå›åˆ°__callStaticæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è§£é‡Šä¸€ä¸‹è¿™ä¸ªä»£ç ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">new</span> RouteRegistrar(<span class="built_in">self</span>::getInstance()))-&gt;<span class="variable">$name</span>(<span class="variable">$arguments</span>[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>
<p>æˆ‘è¦ç»™å¤§å®¶è§£é‡Šçš„æ˜¯ï¼Œphpä¸­çš„å˜é‡åæ˜¯å¯ä»¥ä½œä¸ºæ–¹æ³•åè¿›è¡Œè°ƒç”¨çš„ï¼Œå…·ä½“è°ƒç”¨çš„å“ªä¸ªæ–¹æ³•å–å†³äºä½ çš„å˜é‡çš„å€¼ï¼Œæ¯”å¦‚è¿™é‡Œçš„$nameæ˜¯whereï¼Œé‚£ä¹ˆå°±æ˜¯è°ƒç”¨RouteRegistrarçš„whereæ–¹æ³•äº†ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥å¾ˆå®¹æ˜“ç†è§£ï¼ŒRouteRegistrarç±»çš„æ‰€æœ‰æ–¹æ³•çš„ä½œç”¨å’ŒLaravelæ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚whereè®¾ç½®å‚æ•°çš„çº¦æŸï¼Œæ¯”å¦‚å¯¹äºè·¯ç”± /admin/order/id :</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">-&gt;where(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;\d&#123;1,2&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>namespaceæ˜¯ç”¨æ¥è®¾ç½®æ§åˆ¶å™¨å‘½åç©ºé—´å‰ç¼€çš„ï¼Œ<br>æ¯”å¦‚ä¸‹é¢è¿™ä¸ªç»™æ§åˆ¶å™¨OrderControlleråŠ ä¸ŠAdmin\Controllerå‘½åç©ºé—´å‰ç¼€ï¼Œå°±æˆä¸ºäº†Admin\Controller\OrderControllerï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">-&gt;namespace(<span class="string">&quot;Admin\\Controller&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>prefixæ˜¯è®¾ç½®è·¯ç”±å‰ç¼€çš„ï¼Œæ¯”å¦‚ä½ æœ‰ä¸€ä¸ª/orderçš„è·¯ç”±ï¼Œé‚£ä¹ˆprefixä¸ºadminçš„è¯ï¼Œè·¯ç”±å°±å˜ä¸ºäº†/admin/orderäº†ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">-&gt;prefix(<span class="string">&quot;admin&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å·²ç»è¯¦ç»†è®²è¿°äº†whereï¼Œprefixå’Œnamespaceçš„ä½œç”¨ï¼Œç›¸ä¿¡å¤§å®¶ç†è§£èµ·æ¥æ²¡å•¥é—®é¢˜äº†æŠŠï¼Œè¿˜æœ‰ä¸€ç‚¹éœ€è¦è®°ä½çš„æ˜¯ï¼Œä¸Šé¢è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½æŠŠæ¥å—çš„å€¼å­˜å‚¨åœ¨äº†RouteRegistrarç±»çš„attributeså±æ€§ä¸­ï¼Œè¿™ä¸ªå±æ€§åé¢ä¼šç”¨åˆ°ï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹groupæ–¹æ³•ï¼Œä»ä¸Šé¢çš„Routerçš„__callStaticæ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“groupæ–¹æ³•æ˜¯ä¸èƒ½ç›´æ¥è¢«æˆ‘ä»¬ä½¿ç”¨çš„ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨groupæ–¹æ³•åªèƒ½å…ˆè°ƒç”¨whereï¼Œprefixå’Œnamespaceä¸‰ä¸ªåŠ¨æ€æ–¹æ³•ä¸­çš„ä¸€ä¸ªï¼Œå‰é¢å·²ç»åˆ†æè¿‡äº†ï¼Œä»–ä»¬ä¼šè¿”å›RouteRegistrarç±»çš„å®ä¾‹ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å†æ¥åˆ†ægroupæ–¹æ³•ï¼Œåœ¨åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬æŠŠå’±ä»¬çš„æµ‹è¯•ä¾‹å­è´´å‡ºæ¥ï¼Œæ¥ä¸‹æ¥çš„åˆ†æéƒ½æ˜¯ä»¥è¿™æ®µä»£ç è¿›è¡Œåˆ†æï¼Œä¸ºäº†å¤§å®¶ç†è§£ï¼Œè¿™ä¹ˆåšäº†ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Router::where(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;[a-z]+&#x27;</span>)</span><br><span class="line">    -&gt;where(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;\d&#123;1,2&#125;&#x27;</span>)</span><br><span class="line">    -&gt;prefix(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">    -&gt;namespace(<span class="string">&quot;Admin\\Controller&quot;</span>)</span><br><span class="line">    -&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params">Router <span class="variable">$router</span></span>) </span>&#123;</span><br><span class="line">        Router::get(<span class="string">&#x27;dashboard&#x27;</span>, <span class="string">&#x27;DashboardController@index&#x27;</span>);</span><br><span class="line">        Router::prefix(<span class="string">&quot;order&quot;</span>)</span><br><span class="line">            -&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                Router::post(<span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;OrderController@add&#x27;</span>);</span><br><span class="line">                Router::post(<span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;OrderController/index&#x27;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>å‰é¢åˆ†æè¿‡whereï¼Œprefixå’Œnamespaceä¼šæŠŠå€¼å­˜å‚¨åœ¨attributesä¸­ï¼Œå…·ä½“è¯·çœ‹ä¸Šé¢çš„ä»£ç ï¼Œå¾ˆç®€å•ï¼Œæœ€ç»ˆå½“å‰çš„RouteRegistrarå®ä¾‹çš„attributeså°±æ˜¯ä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$arrtibuets</span> = [</span><br><span class="line">    <span class="string">&#x27;where&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;\d&#123;1,2&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;[a-z]+&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;namespace&#x27;</span> =&gt; <span class="string">&#x27;Admin\\Controller&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>æœ€å¤–å±‚çš„æœ€åä¸€ä¸ªæ–¹æ³•æ˜¯groupæ–¹æ³•ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°RouteRegistrarç±»çš„groupæ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">group</span>(<span class="params"><span class="keyword">callable</span> <span class="variable">$callback</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;router-&gt;group(<span class="keyword">$this</span>-&gt;attributes, <span class="variable">$callback</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå®ƒåªæ˜¯è°ƒç”¨äº†Routerå®ä¾‹çš„groupæ–¹æ³•ï¼Œ<strong>æ³¨æ„äº†ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨Routerå®ä¾‹çš„groupæ–¹æ³•</strong>ï¼Œå®ƒåªæ˜¯è¢«RouteRegistrarçš„groupæ–¹æ³•è°ƒç”¨ï¼Œ$this-&gt;attributeså°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„åˆ†æç»“æœï¼Œæˆ‘ä»¬è¿›å…¥åˆ°Routerçš„groupæ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">group</span>(<span class="params"><span class="variable">$attributes</span>, <span class="keyword">callable</span> <span class="variable">$callback</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;updateGroupStack(<span class="variable">$attributes</span>);</span><br><span class="line">    <span class="variable">$callback</span>(<span class="built_in">self</span>::getInstance());</span><br><span class="line">    array_pop(<span class="keyword">$this</span>-&gt;groupStack);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¦–å…ˆè°ƒç”¨updateGroupStackæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">updateGroupStack</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;groupStack)) &#123;</span><br><span class="line">        <span class="variable">$new_attributes</span> = [];</span><br><span class="line">        <span class="variable">$last_attribute</span> = end(<span class="keyword">$this</span>-&gt;groupStack);</span><br><span class="line">        <span class="variable">$new_attributes</span>[<span class="string">&#x27;where&#x27;</span>] =</span><br><span class="line">            array_merge(<span class="variable">$last_attribute</span>[<span class="string">&#x27;where&#x27;</span>] ?? [], <span class="variable">$attributes</span>[<span class="string">&#x27;where&#x27;</span>] ?? []);</span><br><span class="line">        <span class="variable">$new_attributes</span>[<span class="string">&#x27;prefix&#x27;</span>] = <span class="keyword">isset</span>(<span class="variable">$last_attribute</span>[<span class="string">&#x27;prefix&#x27;</span>])</span><br><span class="line">            ? (<span class="variable">$last_attribute</span>[<span class="string">&#x27;prefix&#x27;</span>] . (<span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>])</span><br><span class="line">                    ? <span class="string">&#x27;/&#x27;</span> . <span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>] : <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            : (<span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="variable">$new_attributes</span>[<span class="string">&#x27;namespace&#x27;</span>] = <span class="keyword">isset</span>(<span class="variable">$last_attribute</span>[<span class="string">&#x27;namespace&#x27;</span>])</span><br><span class="line">            ? (<span class="variable">$last_attribute</span>[<span class="string">&#x27;namespace&#x27;</span>] .</span><br><span class="line">                (<span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>]) ? <span class="string">&#x27;/&#x27;</span> . <span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>] : <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            : (<span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;groupStack[] = <span class="variable">$new_attributes</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;groupStack[] = <span class="variable">$attributes</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°$attributesçš„å€¼ï¼Œå’±ä»¬æ˜¯çŸ¥é“çš„ï¼Œè¿™é‡Œçš„groupStacké»˜è®¤æ˜¯ä¸ºç©ºçš„ï¼Œæ‰€ä»¥ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;groupStack[] = <span class="variable">$attributes</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç è¢«è°ƒç”¨ï¼Œè‡³äºä¸Šé¢çš„ifè¯­å¥å—ï¼Œåé¢å†æ¥è®²ï¼Œå’±ä»¬æŒ‰ä»£ç æµç¨‹èµ°ã€‚<br>ä¸Šé¢è°ƒç”¨updateGroupStackæ–¹æ³•æŠŠattributeså­˜å‚¨åœ¨äº†groupStackï¼Œæ­¤æ—¶groupStackçš„å€¼ä¸ºï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$groupStack</span> = [[</span><br><span class="line">    <span class="string">&#x27;where&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;\d&#123;1,2&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;[a-z]+&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;namespace&#x27;</span> =&gt; <span class="string">&#x27;Admin\\Controller&#x27;</span></span><br><span class="line">]];</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°groupStackçš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯attributesæ•´ä¸ªæ•°ç»„ï¼Œè®°ä½è¿™ä¸ªï¼Œåé¢ä¼šç”¨åˆ°ï¼Œå›åˆ°Routerçš„groupæ–¹æ³•ä¸­ï¼Œç»§ç»­è°ƒç”¨ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$callback</span>(<span class="built_in">self</span>::getInstance());</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„$callbackå°±æ˜¯æˆ‘ä»¬ä¼ é€’ç»™RouterRegistrarçš„groupæ–¹æ³•çš„å›è°ƒï¼Œå½“å‰å°±æ˜¯ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">Router <span class="variable">$router</span></span>) </span>&#123;</span><br><span class="line">    Router::get(<span class="string">&#x27;dashboard&#x27;</span>, <span class="string">&#x27;DashboardController@index&#x27;</span>);</span><br><span class="line">    Router::prefix(<span class="string">&quot;order&quot;</span>)</span><br><span class="line">        -&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            Router::post(<span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;OrderController@add&#x27;</span>);</span><br><span class="line">            Router::post(<span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;OrderController/index&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢è¿›å…¥åˆ°å›è°ƒä¸­ï¼Œé¦–å…ˆè°ƒç”¨getæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¹‹å‰æˆ‘ä»¬å·²ç»è®²è¿‡äº†ï¼Œä½†æ˜¯è¿˜è®°å¾—å—ï¼Ÿgetæ–¹æ³•è°ƒç”¨äº†newRouteæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢æœ‰å†…å®¹ï¼Œæˆ‘ä»¬è¯´ç­‰åˆ°åé¢å†è®²ï¼Œæ²¡é”™ï¼Œå°±æ˜¯ç°åœ¨äº†ï¼Œæˆ‘ä»¬æ¥çœ‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">newRoute</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$rule</span>, <span class="variable">$action</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$inst</span> = <span class="built_in">self</span>::getInstance();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$inst</span>-&gt;groupStack)) &#123;</span><br><span class="line">        <span class="variable">$attributes</span> = end(<span class="variable">$inst</span>-&gt;groupStack);</span><br><span class="line">        <span class="variable">$rule</span> = <span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>]) ?</span><br><span class="line">            rtrim(<span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>], <span class="string">&#x27;/&#x27;</span>) . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$rule</span> : <span class="variable">$rule</span>;</span><br><span class="line">        <span class="keyword">if</span> (is_string(<span class="variable">$action</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$action</span> = trim(<span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>], <span class="string">&#x27;\\&#x27;</span>) . <span class="string">&#x27;\\&#x27;</span> . <span class="variable">$action</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$attributes</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$route</span> = <span class="keyword">new</span> Route(<span class="variable">$method</span>, <span class="variable">$rule</span>, <span class="variable">$action</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;where&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$route</span>-&gt;where(<span class="variable">$attributes</span>[<span class="string">&#x27;where&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$route</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼ŒgroupStacké‡Œé¢æœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥ä»–ä¼šè¿›å…¥åˆ°ifä»£ç åˆ†æ”¯ä¸­ï¼Œend($inst-&gt;groupStack)è·å–äº†groupStackçš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå› ä¸ºgroupStackä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œè¿™é‡Œå°±æ˜¯ï¼Œæˆ‘ä»¬å†è´´å‡ºæ¥ä¸€æ¬¡ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$arrtibuets</span> = [</span><br><span class="line">    <span class="string">&#x27;where&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;\d&#123;1,2&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;[a-z]+&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;namespace&#x27;</span> =&gt; <span class="string">&#x27;Admin\\Controller&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢é¦–å…ˆæ£€æŸ¥$arrtibuetsä¸­æ˜¯å¦å­˜åœ¨prefixï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œå°±å’Œgetæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ruleåˆå¹¶ï¼Œå‡å¦‚ruleæ˜¯orderï¼Œé‚£ä¹ˆåˆå¹¶ä¹‹åå°±æ˜¯admin/orderäº†ã€‚ç´§æ¥ç€æ£€æŸ¥$arrtibuetsä¸­æ˜¯å¦å­˜åœ¨namespaceï¼Œå¹¶ä¸”getæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°actionä¸ºå­—ç¬¦ä¸²çš„æ—¶å€™ï¼ˆå¦‚æœactionæ˜¯å›è°ƒæ–¹æ³•ï¼Œé‚£ä¹ˆå‘½åç©ºé—´å°±æ²¡ç”¨äº†ï¼‰ï¼Œåˆå¹¶namespaceåˆ°actionçš„å‰é¢ï¼Œä¾‹å¦‚actionä¸ºOrderControllerï¼Œé‚£ä¹ˆåˆå¹¶ä¹‹åå°±æ˜¯Admin\Controller\OrderControlleräº†ã€‚è¿™ä¸ªå‡½æ•°çš„æœ€åé¢æ£€æŸ¥attributesä¸­æ˜¯å¦è®¾ç½®è¿‡whereï¼Œæˆ‘ä»¬è¿™é‡Œæœ‰è®¾ç½®çš„ï¼Œæ‰€ä»¥è°ƒç”¨Routeç±»çš„whereæ–¹æ³•ã€‚Routeç±»çš„æ–¹æ³•å¾ˆç®€å•ï¼Œå°±ä¸è´´å‡ºæ¥äº†ï¼Œå¤§å®¶ä¸‹è½½ä¸‹æ¥çœ‹ï¼Œä¸€ç›®äº†ç„¶ã€‚</p>
<p>getæ–¹æ³•è°ƒç”¨å®Œä¹‹åï¼Œå›åˆ°groupçš„å›è°ƒæ–¹æ³•ä¸­ï¼Œç»§ç»­ä¸‹é¢çš„ä»£ç è°ƒç”¨ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Router::prefix(<span class="string">&quot;order&quot;</span>)</span><br><span class="line">        -&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            Router::post(<span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;OrderController@add&#x27;</span>);</span><br><span class="line">            Router::post(<span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;OrderController/index&#x27;</span>);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå†ä¸€æ¬¡çš„è°ƒç”¨åˆ°prefixæ–¹æ³•ï¼Œ<strong>åŒæ ·çš„ï¼Œå®ƒä¼šèµ°æˆ‘ä»¬ä¸Šé¢çš„æµç¨‹</strong>ï¼Œå®ƒä¹Ÿæ˜¯è®¾ç½®RouteRegistrarç±»çš„attributeså±æ€§çš„prefixå€¼ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™è°ƒç”¨Routerçš„groupæ–¹æ³•ï¼ˆè¿˜è®°å¾—RouteRegistrarç›´æ¥è°ƒç”¨Routerçš„groupæ–¹æ³•å—ï¼Ÿï¼‰ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">group</span>(<span class="params"><span class="variable">$attributes</span>, <span class="keyword">callable</span> <span class="variable">$callback</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;updateGroupStack(<span class="variable">$attributes</span>);</span><br><span class="line">    <span class="variable">$callback</span>(<span class="built_in">self</span>::getInstance());</span><br><span class="line">    array_pop(<span class="keyword">$this</span>-&gt;groupStack);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„$attributesä¸ºï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$attributes</span>=[</span><br><span class="line">	<span class="string">&#x27;prefix&#x27;</span>=&gt;<span class="string">&#x27;order&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>è®°ä½è¿™ä¸ªå€¼ï¼Œæˆ‘ä»¬å†ä¸€æ¬¡è°ƒç”¨updateGroupStackæ–¹æ³•ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">updateGroupStack</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;groupStack)) &#123;</span><br><span class="line">        <span class="variable">$new_attributes</span> = [];</span><br><span class="line">        <span class="variable">$last_attribute</span> = end(<span class="keyword">$this</span>-&gt;groupStack);</span><br><span class="line">        <span class="variable">$new_attributes</span>[<span class="string">&#x27;where&#x27;</span>] =</span><br><span class="line">            array_merge(<span class="variable">$last_attribute</span>[<span class="string">&#x27;where&#x27;</span>] ?? [], <span class="variable">$attributes</span>[<span class="string">&#x27;where&#x27;</span>] ?? []);</span><br><span class="line">        <span class="variable">$new_attributes</span>[<span class="string">&#x27;prefix&#x27;</span>] = <span class="keyword">isset</span>(<span class="variable">$last_attribute</span>[<span class="string">&#x27;prefix&#x27;</span>])</span><br><span class="line">            ? (<span class="variable">$last_attribute</span>[<span class="string">&#x27;prefix&#x27;</span>] . (<span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>])</span><br><span class="line">                    ? <span class="string">&#x27;/&#x27;</span> . <span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>] : <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            : (<span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="variable">$new_attributes</span>[<span class="string">&#x27;namespace&#x27;</span>] = <span class="keyword">isset</span>(<span class="variable">$last_attribute</span>[<span class="string">&#x27;namespace&#x27;</span>])</span><br><span class="line">            ? (<span class="variable">$last_attribute</span>[<span class="string">&#x27;namespace&#x27;</span>] .</span><br><span class="line">                (<span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>]) ? <span class="string">&#x27;/&#x27;</span> . <span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>] : <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            : (<span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;groupStack[] = <span class="variable">$new_attributes</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;groupStack[] = <span class="variable">$attributes</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæ­¤æ—¶çš„groupStackæœ‰ä¸€ä¸ªå…ƒç´ å°±æ˜¯ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$arrtibuets</span> = [</span><br><span class="line">    <span class="string">&#x27;where&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;\d&#123;1,2&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;[a-z]+&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;namespace&#x27;</span> =&gt; <span class="string">&#x27;Admin\\Controller&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>å‚æ•°$attributesæ˜¯ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$attributes</span>=[</span><br><span class="line">	<span class="string">&#x27;prefix&#x27;</span>=&gt;<span class="string">&#x27;order&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>end($this-&gt;groupStack)è·å–åˆ°äº†æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå½“å‰å°±æ˜¯ç¬¬ä¸€ä¸ªå•Šï¼Œè¿™é‡Œé¦–å…ˆåˆå¹¶whereå­—æ®µï¼Œç´§æ¥ç€å†åˆå¹¶prefixï¼Œæœ€ånamespaceï¼Œä¸Šé¢åˆå¹¶çš„ä»£ç å¾ˆç®€å•ï¼Œå¤§å®¶åº”è¯¥èƒ½å¤Ÿçœ‹æ‡‚æŠŠï¼Œå“ˆå“ˆçš„ï¼Œåˆå¹¶ä¹‹åçš„$new_attributesä¸ºï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$arrtibuets</span> = [</span><br><span class="line">    <span class="string">&#x27;where&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;\d&#123;1,2&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;[a-z]+&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;admin/order&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;namespace&#x27;</span> =&gt; <span class="string">&#x27;Admin\\Controller&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>åˆå¹¶å®Œä¹‹åï¼Œå†æ¬¡æŠŠåˆå¹¶çš„ç»“æœ$new_attributeså­˜å‚¨åœ¨groupStackä¸­ï¼Œæ³¨æ„æˆä¸ºgroupStackçš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥æ­¤æ—¶groupStackæœ‰2ä¸ªå…ƒç´ äº†ï¼Œå¥½äº†ï¼Œåˆ†æå®Œä¸Šé¢çš„ï¼Œæˆ‘ä»¬å†è°ƒç”¨æœ€å†…å±‚çš„groupå›è°ƒæ–¹æ³•ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    Router::post(<span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;OrderController@add&#x27;</span>);</span><br><span class="line">    Router::post(<span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;OrderController/index&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜è®°å¾—ä¹‹å‰æˆ‘ä»¬è¯´çš„getè¯·æ±‚å’Œpostè¯·æ±‚æ˜¯ä¸€æ ·çš„ä¹ˆï¼Ÿä»–ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨newRouteæ–¹æ³•ï¼Œæˆ‘ä»¬å†æ¬¡è´´å‡ºæ¥ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">newRoute</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$rule</span>, <span class="variable">$action</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$inst</span> = <span class="built_in">self</span>::getInstance();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$inst</span>-&gt;groupStack)) &#123;</span><br><span class="line">        <span class="variable">$attributes</span> = end(<span class="variable">$inst</span>-&gt;groupStack);</span><br><span class="line">        <span class="variable">$rule</span> = <span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>]) ?</span><br><span class="line">            rtrim(<span class="variable">$attributes</span>[<span class="string">&#x27;prefix&#x27;</span>], <span class="string">&#x27;/&#x27;</span>) . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$rule</span> : <span class="variable">$rule</span>;</span><br><span class="line">        <span class="keyword">if</span> (is_string(<span class="variable">$action</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$action</span> = trim(<span class="variable">$attributes</span>[<span class="string">&#x27;namespace&#x27;</span>], <span class="string">&#x27;\\&#x27;</span>) . <span class="string">&#x27;\\&#x27;</span> . <span class="variable">$action</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$attributes</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$route</span> = <span class="keyword">new</span> Route(<span class="variable">$method</span>, <span class="variable">$rule</span>, <span class="variable">$action</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$attributes</span>[<span class="string">&#x27;where&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$route</span>-&gt;where(<span class="variable">$attributes</span>[<span class="string">&#x27;where&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$route</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„æ­¤æ—¶groupStackä¸ºï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$arrtibuets</span> = [</span><br><span class="line">    <span class="string">&#x27;where&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;\d&#123;1,2&#125;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;[a-z]+&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;admin/order&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;namespace&#x27;</span> =&gt; <span class="string">&#x27;Admin\\Controller&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>åé¢çš„ä¸€ç³»åˆ—åˆå¹¶æ“ä½œï¼Œå’Œä¸Šé¢è®²getçš„æ—¶å€™æ˜¯ä¸€æ ·çš„ï¼Œå›è°ƒè°ƒç”¨å®Œä¹‹åï¼Œå›åˆ°Routerçš„groupæ–¹æ³•ï¼š</p>
<p><img src="https://cdn.learnku.com/uploads/images/201911/28/39566/CyUFAJZRw5.png!large" alt="è€å¸æœºå¸¦ä½ å®ç°Laravelè·¯ç”±æ³¨å†ŒåŠŸèƒ½"></p>
<p>æœ€å†…å±‚çš„å›è°ƒè°ƒç”¨å®Œä¹‹åï¼Œä»groupStackä¸­å¼¹å‡ºæœ€åä¸€ä¸ªå…ƒç´ ï¼Œå› ä¸ºæœ€å†…å±‚groupä¹‹å¤–çš„è·¯ç”±ç”¨ä¸åˆ°ï¼Œæ‰€ä»¥å¿…é¡»å¼¹å‡ºï¼Œåˆ°è¿™é‡Œæœ€å†…å±‚çš„groupæ–¹æ³•è°ƒç”¨å®Œæˆï¼Œè¿”å›åˆ°RouteRegistrarçš„groupæ–¹æ³•ï¼Œ</p>
<p><img src="https://cdn.learnku.com/uploads/images/201911/28/39566/NKRI7MlsPV.png!large" alt="è€å¸æœºå¸¦ä½ å®ç°Laravelè·¯ç”±æ³¨å†ŒåŠŸèƒ½"></p>
<p>è¿˜è®°å¾—RouterRegistrarçš„groupæ–¹æ³•æ˜¯ä»å“ªé‡Œè°ƒç”¨çš„å—ï¼Ÿ</p>
<p><img src="https://cdn.learnku.com/uploads/images/201911/28/39566/CoB5YPLhDo.png!large" alt="è€å¸æœºå¸¦ä½ å®ç°Laravelè·¯ç”±æ³¨å†ŒåŠŸèƒ½"></p>
<p>å®ƒæ˜¯åœ¨æœ€å¤–å±‚çš„groupæ–¹æ³•çš„å›è°ƒä¸­å•Šï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­å›åˆ°</p>
<p><img src="https://cdn.learnku.com/uploads/images/201911/28/39566/sOjCUMq5hj.png!large" alt="è€å¸æœºå¸¦ä½ å®ç°Laravelè·¯ç”±æ³¨å†ŒåŠŸèƒ½"></p>
<p>æœ€åå°±æ˜¯å¼¹å‡ºgroupStackäº†ï¼Œè¿™ä¸€æ­¥æ“ä½œå‰é¢å·²ç»è®²è¿‡äº†ã€‚</p>
<h2 id="é‡ç‚¹"><a href="#é‡ç‚¹" class="headerlink" title="é‡ç‚¹"></a>é‡ç‚¹</h2><p>æˆ‘ä¸Šé¢ä¹‹æ‰€ä»¥è¦åˆ—å‡ºæ¯ä¸€æ­¥çš„å€¼ï¼Œå°±æ˜¯å¸Œæœ›å¤§å®¶æ¸…æ¥šæˆ‘çš„ä»£ç åˆ°åº•åšäº†ä¸€ä»¶ä»€ä¹ˆäº‹ï¼Œä»£ç æ˜¯å¦‚ä½•å®ç°æ— é™å¾ªç¯åµŒå¥—çš„ï¼Œä»¥åŠæ¯ä¸€å±‚çš„çº¦æŸæ˜¯å¦‚ä½•åˆå¹¶çš„ï¼Œç­‰ç­‰ã€‚</p>
<blockquote>
<p>æœ¬æ–‡è½¬è½½è‡ª <a href="https://learnku.com/articles/37275">https://learnku.com/articles/37275</a></p>
</blockquote>
]]></content>
      <categories>
        <category>è½¬è½½</category>
        <category>Laravel</category>
      </categories>
      <tags>
        <tag>Laravel</tag>
        <tag>è½¬è½½</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰‹æ‘¸æ‰‹æ•™ä½ è®© Laravel å¼€å‘ API æ›´å¾—å¿ƒåº”æ‰‹</title>
    <url>/62cc6f9b.html</url>
    <content><![CDATA[<h1 id="1-èµ·å› "><a href="#1-èµ·å› " class="headerlink" title="1. èµ·å› "></a>1. èµ·å› </h1><p>Â  Â  Â  Â éšç€å‰åç«¯å®Œå…¨åˆ†ç¦»ï¼Œ<code>PHP</code>ä¹ŸåŸºæœ¬å‘Šåˆ«äº†<code>view</code>æ¨¡æ¿åµŒå¥—å¼€å‘ï¼Œè½¬è€Œä¸“é—¨å†™èµ„æºæ¥å£ã€‚<code>Laravel</code>æ˜¯PHPæ¡†æ¶ä¸­æœ€ä¼˜é›…çš„æ¡†æ¶ï¼Œå›½å†…ä¹Ÿè¶Šæ¥è¶Šå¤šäººå‘Šåˆ«<code>ThinkPHP</code>é€‰æ‹©äº†<code>Laravel</code>ã€‚</p>
<a id="more"></a>
<p><code>Laravel</code>æ¡†æ¶æœ¬èº«å¯¹<code>API</code>æœ‰æ”¯æŒï¼Œä½†æ˜¯æ„Ÿè§‰å†å·¥ä½œä¸­è¿˜æ˜¯éœ€è¦å†åšä¸€äº›å¤„ç†ã€‚<code>Lumen</code>ç”¨èµ·æ¥ä¸é¡ºæ‰‹ï¼Œæœ‰äº›åŒ…ä¸èƒ½å¾ˆå¥½åœ°æ”¯æŒã€‚æ‰€ä»¥ï¼Œå°†<code>Laravel</code>æ¡†æ¶è¿›è¡Œä¸€äº›é…ç½®å¤„ç†ï¼Œè®©å…¶åœ¨å¼€å‘<code>API</code>æ—¶æ›´å¾—å¿ƒåº”æ‰‹ã€‚</p>
<h1 id="2-å‡†å¤‡å·¥ä½œ"><a href="#2-å‡†å¤‡å·¥ä½œ" class="headerlink" title="2. å‡†å¤‡å·¥ä½œ"></a>2. å‡†å¤‡å·¥ä½œ</h1><h2 id="2-1-ç¯å¢ƒ"><a href="#2-1-ç¯å¢ƒ" class="headerlink" title="2.1. ç¯å¢ƒ"></a>2.1. ç¯å¢ƒ</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PHP &gt; 7.1</span><br><span class="line">MySQL &gt; 5.5</span><br><span class="line">Redis &gt; 2.8</span><br></pre></td></tr></table></figure>
<h2 id="2-2-å·¥å…·"><a href="#2-2-å·¥å…·" class="headerlink" title="2.2. å·¥å…·"></a>2.2. å·¥å…·</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">postman</span><br><span class="line">composer</span><br></pre></td></tr></table></figure>
<h2 id="2-3-ä½¿ç”¨postman"><a href="#2-3-ä½¿ç”¨postman" class="headerlink" title="2.3. ä½¿ç”¨postman"></a>2.3. ä½¿ç”¨postman</h2><p>ä¸ºäº†æ¨¡æ‹ŸAJAXè¯·æ±‚ï¼Œè¯·å°† <code>headerå¤´</code> è®¾ç½®<code>X-Requested-With</code> ä¸º <code>XMLHttpRequest</code></p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/le4MhxnAMV.png!large" alt="file"></p>
<h2 id="2-4-å®‰è£…Laravel"><a href="#2-4-å®‰è£…Laravel" class="headerlink" title="2.4. å®‰è£…Laravel"></a>2.4. å®‰è£…Laravel</h2><p><code>Laravel</code>åªè¦<code>&gt;=5.5</code>çš†å¯ï¼Œè¿™é‡Œé‡‡ç”¨æ–‡ç« ç¼–å†™æ—¶æœ€æ–°çš„<code>5.7</code>ç‰ˆæœ¬</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer create-project laravel&#x2F;laravel Laravel --prefer-dist &quot;5.7.*&quot;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-åˆ›å»ºæ•°æ®åº“"><a href="#2-5-åˆ›å»ºæ•°æ®åº“" class="headerlink" title="2.5. åˆ›å»ºæ•°æ®åº“"></a>2.5. åˆ›å»ºæ•°æ®åº“</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;users&#96; (</span><br><span class="line">	&#96;id&#96; INT UNSIGNED NOT NULL PRIMARY KEY auto_increment COMMENT &#39;ä¸»é”®ID&#39;,</span><br><span class="line">	&#96;name&#96; VARCHAR ( 12 ) NOT NULL COMMENT &#39;ç”¨æˆ·åç§°&#39;,</span><br><span class="line">	&#96;password&#96; VARCHAR ( 80 ) NOT NULL COMMENT &#39;å¯†ç &#39;,</span><br><span class="line">	&#96;last_token&#96; text COMMENT &#39;ç™»é™†æ—¶çš„token&#39;,</span><br><span class="line">	&#96;status&#96; TINYINT NOT NULL DEFAULT 0 COMMENT &#39;ç”¨æˆ·çŠ¶æ€ -1ä»£è¡¨å·²åˆ é™¤ 0ä»£è¡¨æ­£å¸¸ 1ä»£è¡¨å†»ç»“&#39;,</span><br><span class="line">	&#96;created_at&#96; TIMESTAMP NULL DEFAULT NULL COMMENT &#39;åˆ›å»ºæ—¶é—´&#39;,</span><br><span class="line">&#96;updated_at&#96; TIMESTAMP NULL DEFAULT NULL COMMENT &#39;ä¿®æ”¹æ—¶é—´&#39; </span><br><span class="line">) ENGINE &#x3D; INNODB DEFAULT CHARSET &#x3D; utf8mb4 COLLATE &#x3D; utf8mb4_general_ci;</span><br></pre></td></tr></table></figure>
<h1 id="3-åˆå§‹åŒ–æ•°æ®"><a href="#3-åˆå§‹åŒ–æ•°æ®" class="headerlink" title="3. åˆå§‹åŒ–æ•°æ®"></a>3. åˆå§‹åŒ–æ•°æ®</h1><h2 id="3-1-Modelç§»åŠ¨"><a href="#3-1-Modelç§»åŠ¨" class="headerlink" title="3.1. Modelç§»åŠ¨"></a>3.1. Modelç§»åŠ¨</h2><p>åœ¨é¡¹ç›®çš„<code>app</code>ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ª<code>User.php</code>çš„æ¨¡å‹æ–‡ä»¶ã€‚å› ä¸º<code>Laravel</code>é»˜è®¤æŠŠæ¨¡å‹æ–‡ä»¶æ”¾åœ¨<code>app</code>ç›®å½•ä¸‹ï¼Œå¦‚æœæ•°æ®è¡¨å¤šçš„è¯ï¼Œè¿™é‡Œæ¨¡å‹æ–‡ä»¶å°±ä¼šå¾ˆå¤šï¼Œä¸ä¾¿äºç®¡ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆè¦å°†æ¨¡å‹æ–‡ä»¶ç§»åŠ¨åˆ°å…¶ä»–æ–‡ä»¶å¤¹å†…ã€‚</p>
<ol>
<li>åœ¨<code>app</code>ç›®å½•ä¸‹æ–°å»º<code>Models</code>æ–‡ä»¶å¤¹ï¼Œç„¶åå°†<code>User.php</code>æ–‡ä»¶ç§»åŠ¨è¿›æ¥ã€‚</li>
<li>ä¿®æ”¹<code>User.php</code>çš„å†…å®¹<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>; <span class="comment">//è¿™é‡Œä»Appæ”¹æˆäº†App\Models</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Notifications</span>\<span class="title">Notifiable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">Authenticatable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Notifiable</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$table</span> = <span class="string">&#x27;users&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//å»æ‰æˆ‘åˆ›å»ºçš„æ•°æ®è¡¨æ²¡æœ‰çš„å­—æ®µ</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$fillable</span> = [</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;password&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">     <span class="comment">//å»æ‰æˆ‘åˆ›å»ºçš„æ•°æ®è¡¨æ²¡æœ‰çš„å­—æ®µ</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hidden</span> = [</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="comment">//å°†å¯†ç è¿›è¡ŒåŠ å¯†</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setPasswordAttribute</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;attributes[<span class="string">&#x27;password&#x27;</span>] = bcrypt(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>å› ä¸ºæœ‰å…³äºUserçš„å‘½åç©ºé—´å‘ç”Ÿäº†æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å…¨å±€æœç´¢<code>App\User</code>,å°†å…¶æ›¿æ¢ä¸º<code>App\Models\User</code>.æˆ‘ä¸€å…±æœç´¢åˆ°4ä¸ªæ–‡ä»¶<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app&#x2F;Http&#x2F;Controllers&#x2F;Auth ç›®å½•ä¸‹çš„ RegisterController.php</span><br><span class="line">config ç›®å½•ä¸‹çš„ services.php</span><br><span class="line">config ç›®å½•ä¸‹çš„ auth.php</span><br><span class="line">database&#x2F;factories ç›®å½•ä¸‹çš„ UserFactory.php</span><br></pre></td></tr></table></figure>
<h2 id="3-2-æ§åˆ¶å™¨"><a href="#3-2-æ§åˆ¶å™¨" class="headerlink" title="3.2. æ§åˆ¶å™¨"></a>3.2. æ§åˆ¶å™¨</h2></li>
</ol>
<p>å› ä¸ºæ˜¯ä¸“é—¨åšAPIçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠæ˜¯APIçš„æ§åˆ¶å™¨éƒ½æ”¾åˆ°<code>app\Http\Controllers\Api</code>ç›®å½•ä¸‹ã€‚</p>
<p>ä½¿ç”¨å‘½ä»¤è¡Œåˆ›å»ºæ§åˆ¶å™¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan make:controller Api&#x2F;UserController</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™<code>app/Http/Controllers/Api</code>ç›®å½•ä¸‹çš„<code>UserController.php</code>æ–‡ä»¶</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;guaosi&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå†™äº†indexå‡½æ•°ï¼Œç”¨æ¥ä¸‹é¢å»ºç«‹è·¯ç”±åçš„æµ‹è¯•ï¼ŒæŸ¥çœ‹æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®ã€‚</p>
<h2 id="3-3-è·¯ç”±"><a href="#3-3-è·¯ç”±" class="headerlink" title="3.3. è·¯ç”±"></a>3.3. è·¯ç”±</h2><p>åœ¨<code>routes</code>ç›®å½•ä¸‹çš„<code>api.php</code>æ˜¯ä¸“é—¨ç”¨æ¥å†™Apiæ¥å£çš„è·¯ç”±ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰“å¼€å®ƒï¼Œå¡«å†™ä»¥ä¸‹å†…å®¹ï¼Œåšä¸€ä¸ªæµ‹è¯•.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line">Route::namespace(<span class="string">&#x27;Api&#x27;</span>)-&gt;prefix(<span class="string">&#x27;v1&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Route::get(<span class="string">&#x27;/users&#x27;</span>,<span class="string">&#x27;UserController@index&#x27;</span>)-&gt;name(<span class="string">&#x27;users.index&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å› ä¸ºæˆ‘ä»¬Apiæ§åˆ¶å™¨çš„å‘½åç©ºé—´æ˜¯<code>App\Http\Controllers\Api</code>,è€Œ<code>Laravel</code>é»˜è®¤åªä¼šåœ¨å‘½åç©ºé—´<code>App\Http\Controllers</code>ä¸‹æŸ¥æ‰¾æ§åˆ¶å™¨ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬ç»™å‡º<code>namespace</code>ã€‚</p>
</blockquote>
<blockquote>
<p>åŒæ—¶ï¼Œæ·»åŠ ä¸€ä¸ª<code>prefix</code>æ˜¯ä¸ºäº†ç‰ˆæœ¬å·ï¼Œæ–¹ä¾¿åæœŸæ¥å£å‡çº§åŒºåˆ†ã€‚</p>
</blockquote>
<p>æ‰“å¼€<code>postman</code>,ç”¨<code>get</code>æ–¹å¼è¯·æ±‚<code>ä½ çš„åŸŸå/api/v1/users</code>,æœ€åè¿”å›ç»“æœæ˜¯</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">guaosi</span><br></pre></td></tr></table></figure>
<p>åˆ™æˆåŠŸ</p>
<h2 id="3-4-åˆ›å»ºéªŒè¯å™¨"><a href="#3-4-åˆ›å»ºéªŒè¯å™¨" class="headerlink" title="3.4. åˆ›å»ºéªŒè¯å™¨"></a>3.4. åˆ›å»ºéªŒè¯å™¨</h2><p>åœ¨åˆ›å»ºç”¨æˆ·ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºéªŒè¯å™¨ï¼Œæ¥è®©æˆ‘ä»¬æœåŠ¡å™¨æ¥æ”¶åˆ°çš„æ•°æ®æ›´å®‰å…¨.å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿè¦æŠŠå…³äºApiéªŒè¯çš„æ”¾åœ¨ä¸€ä¸ªä¸“é—¨çš„æ–‡ä»¶å¤¹å†…ã€‚<br>å…ˆåˆ›å»ºä¸€ä¸ª<code>Request</code>çš„åŸºç±»</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan make:request Api&#x2F;FormRequest</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºéªŒè¯å™¨é»˜è®¤çš„æƒé™éªŒè¯æ˜¯<code>false</code>ï¼Œå¯¼è‡´è¿”å›éƒ½æ˜¯<code>403</code>çš„æƒé™ä¸é€šè¿‡é”™è¯¯ã€‚è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ç”¨åˆ°æƒé™è®¤è¯ï¼Œä¸ºäº†æ–¹ä¾¿å¤„ç†ï¼Œæˆ‘ä»¬é»˜è®¤å°†æƒé™éƒ½æ˜¯é€šè¿‡çš„çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½éœ€è¦æˆ‘ä»¬å°†<code>false</code>æ”¹æˆ<code>true</code>ã€‚</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authorize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//falseä»£è¡¨æƒé™éªŒè¯ä¸é€šè¿‡ï¼Œè¿”å›403é”™è¯¯</span></span><br><span class="line"><span class="comment">//trueä»£è¡¨æƒé™è®¤è¯é€šè¿‡</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹<code>app/Http/Requests/Api</code> ç›®å½•ä¸‹çš„ <code>FormRequest.php</code> æ–‡ä»¶</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">FormRequest</span> <span class="title">as</span> <span class="title">BaseFormRequest</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FormRequest</span> <span class="keyword">extends</span> <span class="title">BaseFormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authorize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">		<span class="comment">//falseä»£è¡¨æƒé™éªŒè¯ä¸é€šè¿‡ï¼Œè¿”å›403é”™è¯¯</span></span><br><span class="line">		<span class="comment">//trueä»£è¡¨æƒé™è®¤è¯é€šè¿‡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·è¿™ä¸ªå‘½åç©ºé—´ä¸‹çš„éªŒè¯å™¨éƒ½ä¼šé»˜è®¤é€šè¿‡æƒé™éªŒè¯ã€‚å½“ç„¶ï¼Œå¦‚æœä½ éœ€è¦æƒé™éªŒè¯ï¼Œå¯ä»¥é€šè¿‡ç›´æ¥è¦†ç›–æ–¹æ³•ã€‚</p>
<p>æ¥ç€æˆ‘ä»¬å¼€å§‹åˆ›å»ºå…³äº<code>UserController</code>çš„ä¸“å±éªŒè¯å™¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan make:request Api&#x2F;UserRequest</span><br></pre></td></tr></table></figure>
<p>ç¼–è¾‘<code>app/Http/Requests/Api</code> ç›®å½•ä¸‹çš„ <code>UserRequest.php</code>æ–‡ä»¶</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRequest</span> <span class="keyword">extends</span> <span class="title">FormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;method()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> [</span><br><span class="line">                        <span class="string">&#x27;id&#x27;</span> =&gt; [<span class="string">&#x27;required,exists:shop_user,id&#x27;</span>]</span><br><span class="line">                    ];</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> [</span><br><span class="line">                        <span class="string">&#x27;name&#x27;</span> =&gt; [<span class="string">&#x27;required&#x27;</span>, <span class="string">&#x27;max:12&#x27;</span>, <span class="string">&#x27;unique:users,name&#x27;</span>],</span><br><span class="line">                        <span class="string">&#x27;password&#x27;</span> =&gt; [<span class="string">&#x27;required&#x27;</span>, <span class="string">&#x27;max:16&#x27;</span>, <span class="string">&#x27;min:6&#x27;</span>]</span><br><span class="line">                    ];</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;PATCH&#x27;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> [</span><br><span class="line"></span><br><span class="line">                    ];</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">messages</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;id.required&#x27;</span>=&gt;<span class="string">&#x27;ç”¨æˆ·IDå¿…é¡»å¡«å†™&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;id.exists&#x27;</span>=&gt;<span class="string">&#x27;ç”¨æˆ·ä¸å­˜åœ¨&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;name.unique&#x27;</span> =&gt; <span class="string">&#x27;ç”¨æˆ·åå·²ç»å­˜åœ¨&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;name.required&#x27;</span> =&gt; <span class="string">&#x27;ç”¨æˆ·åä¸èƒ½ä¸ºç©º&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;name.max&#x27;</span> =&gt; <span class="string">&#x27;ç”¨æˆ·åæœ€å¤§é•¿åº¦ä¸º12ä¸ªå­—ç¬¦&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password.required&#x27;</span> =&gt; <span class="string">&#x27;å¯†ç ä¸èƒ½ä¸ºç©º&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password.max&#x27;</span> =&gt; <span class="string">&#x27;å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡16ä¸ªå­—ç¬¦&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password.min&#x27;</span> =&gt; <span class="string">&#x27;å¯†ç é•¿åº¦ä¸èƒ½å°äº6ä¸ªå­—ç¬¦&#x27;</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-5-åˆ›å»ºç”¨æˆ·"><a href="#3-5-åˆ›å»ºç”¨æˆ·" class="headerlink" title="3.5. åˆ›å»ºç”¨æˆ·"></a>3.5. åˆ›å»ºç”¨æˆ·</h2><p>ç°åœ¨æˆ‘ä»¬æ¥ç¼–å†™åˆ›å»ºç”¨æˆ·æ¥å£ï¼Œåˆ¶ä½œä¸€äº›è™šæ‹Ÿæ•°æ®ã€‚(å°±ä¸ä½¿ç”¨seederæ¥å¡«å……äº†)<br>æ‰“å¼€<code>UserController.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">UserRequest <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">    User::create(<span class="variable">$request</span>-&gt;all());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;ç”¨æˆ·æ³¨å†ŒæˆåŠŸã€‚ã€‚ã€‚&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">Request <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$res</span>=Auth::guard(<span class="string">&#x27;web&#x27;</span>)-&gt;attempt([<span class="string">&#x27;name&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;name,<span class="string">&#x27;password&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;password]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ç”¨æˆ·ç™»å½•æˆåŠŸ...&#x27;</span>;</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;ç”¨æˆ·ç™»å½•å¤±è´¥&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬åˆ›å»ºè·¯ç”±ï¼Œç¼–è¾‘<code>api.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Route::post(<span class="string">&#x27;/users&#x27;</span>,<span class="string">&#x27;UserController@store&#x27;</span>)-&gt;name(<span class="string">&#x27;users.store&#x27;</span>);</span><br><span class="line">Route::post(<span class="string">&#x27;/login&#x27;</span>,<span class="string">&#x27;UserController@login&#x27;</span>)-&gt;name(<span class="string">&#x27;users.login&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€<code>postman</code>,ç”¨<code>post</code>æ–¹å¼è¯·æ±‚<code>ä½ çš„åŸŸå/api/v1/users</code>,åœ¨<code>form-data</code>è®°å¾—å¡«å†™è¦åˆ›å»ºçš„ç”¨æˆ·åå’Œå¯†ç ã€‚</p>
<p>æœ€åè¿”å›ç»“æœæ˜¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç”¨æˆ·åˆ›å»ºæˆåŠŸã€‚ã€‚ã€‚</span><br></pre></td></tr></table></figure>
<p>åˆ™æˆåŠŸã€‚</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/Ea0rtpCMtC.png!large" alt="file"></p>
<p>å¦‚æœè¿”å›</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;The given data was invalid.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;errors&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;ç”¨æˆ·åä¸èƒ½ä¸ºç©º&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;å¯†ç ä¸èƒ½ä¸ºç©º&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ™è¯æ˜éªŒè¯å¤±è´¥ã€‚</p>
<p>ç„¶åéªŒè¯æ˜¯å¦å¯ä»¥æ­£å¸¸ç™»å½•ã€‚å› ä¸ºæˆ‘ä»¬è®¤è¯çš„å­—æ®µæ˜¯<code>name</code>è·Ÿ<code>password</code>,è€Œ<code>Laravel</code>é»˜è®¤è®¤è¯çš„æ˜¯<code>email</code>è·Ÿ<code>password</code>ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜è¦æ‰“å¼€<code>app/Http/Controllers/auth</code> ç›®å½•ä¸‹çš„ <code>LoginController.php</code>,åŠ å…¥å¦‚ä¸‹ä»£ç </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">username</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;name&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€<code>postman</code>,ç”¨<code>post</code>æ–¹å¼è¯·æ±‚<code>ä½ çš„åŸŸå/api/v1/login</code><br>æœ€åè¿”å›ç»“æœæ˜¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç”¨æˆ·ç™»å½•æˆåŠŸ...</span><br></pre></td></tr></table></figure>
<p>åˆ™æˆåŠŸ</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/xYz7wTN113.png!large" alt="file"></p>
<h2 id="3-6-åˆ›å»º10ä¸ªç”¨æˆ·"><a href="#3-6-åˆ›å»º10ä¸ªç”¨æˆ·" class="headerlink" title="3.6. åˆ›å»º10ä¸ªç”¨æˆ·"></a>3.6. åˆ›å»º10ä¸ªç”¨æˆ·</h2><p>ä¸ºäº†æµ‹è¯•ä½¿ç”¨ï¼Œè¯·è‡ªè¡Œé€šè¿‡æ¥å£åˆ›å»º10ä¸ªç”¨æˆ·ã€‚</p>
<h2 id="3-7-ç¼–å†™ç›¸å…³èµ„æºæ¥å£"><a href="#3-7-ç¼–å†™ç›¸å…³èµ„æºæ¥å£" class="headerlink" title="3.7. ç¼–å†™ç›¸å…³èµ„æºæ¥å£"></a>3.7. ç¼–å†™ç›¸å…³èµ„æºæ¥å£</h2><p>ç»™å‡ºæ•´ä½“æ§åˆ¶å™¨ä¿¡æ¯<code>UserController.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">UserRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Auth</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//3ä¸ªç”¨æˆ·ä¸ºä¸€é¡µ</span></span><br><span class="line">        <span class="variable">$users</span> = User::paginate(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$users</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›å•ä¸€ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">User <span class="variable">$user</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$user</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">UserRequest <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">        User::create(<span class="variable">$request</span>-&gt;all());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ç”¨æˆ·æ³¨å†ŒæˆåŠŸã€‚ã€‚ã€‚&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">Request <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$res</span>=Auth::guard(<span class="string">&#x27;web&#x27;</span>)-&gt;attempt([<span class="string">&#x27;name&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;name,<span class="string">&#x27;password&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;password]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$res</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;ç”¨æˆ·ç™»å½•æˆåŠŸ...&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ç”¨æˆ·ç™»å½•å¤±è´¥&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-8-ç¼–å†™è·¯ç”±"><a href="#3-8-ç¼–å†™è·¯ç”±" class="headerlink" title="3.8. ç¼–å†™è·¯ç”±"></a>3.8. ç¼–å†™è·¯ç”±</h2><p>ç»™å‡ºæ•´ä½“è·¯ç”±ä¿¡æ¯<code>api.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line">Route::namespace(<span class="string">&#x27;Api&#x27;</span>)-&gt;prefix(<span class="string">&#x27;v1&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Route::get(<span class="string">&#x27;/users&#x27;</span>,<span class="string">&#x27;UserController@index&#x27;</span>)-&gt;name(<span class="string">&#x27;users.index&#x27;</span>);</span><br><span class="line">        Route::get(<span class="string">&#x27;/users/&#123;user&#125;&#x27;</span>,<span class="string">&#x27;UserController@show&#x27;</span>)-&gt;name(<span class="string">&#x27;users.show&#x27;</span>);</span><br><span class="line">        Route::post(<span class="string">&#x27;/users&#x27;</span>,<span class="string">&#x27;UserController@store&#x27;</span>)-&gt;name(<span class="string">&#x27;users.store&#x27;</span>);</span><br><span class="line">        Route::post(<span class="string">&#x27;/login&#x27;</span>,<span class="string">&#x27;UserController@login&#x27;</span>)-&gt;name(<span class="string">&#x27;users.login&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="4-å­˜åœ¨é—®é¢˜"><a href="#4-å­˜åœ¨é—®é¢˜" class="headerlink" title="4. å­˜åœ¨é—®é¢˜"></a>4. å­˜åœ¨é—®é¢˜</h1><p>ä»¥ä¸Šæ‰€æœ‰è¿”å›çš„ç»“æœï¼Œæ— è®ºæ­£ç¡®æˆ–è€…é”™è¯¯ï¼Œéƒ½æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€æ ¼å¼è§„èŒƒï¼Œå¯¹å¼€å‘<code>Api</code>ä¸å¤ªå‹å¥½çš„ï¼Œéœ€è¦æˆ‘ä»¬è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼Œè®©Laravelæ¡†æ¶å¯ä»¥æ›´åŠ å‹å¥½åœ°ç¼–å†™Apiã€‚</p>
<h1 id="5-æ„é€ "><a href="#5-æ„é€ " class="headerlink" title="5. æ„é€ "></a>5. æ„é€ </h1><h2 id="5-1-è·¨åŸŸé—®é¢˜"><a href="#5-1-è·¨åŸŸé—®é¢˜" class="headerlink" title="5.1. è·¨åŸŸé—®é¢˜"></a>5.1. è·¨åŸŸé—®é¢˜</h2><p>æ‰€æœ‰é—®é¢˜ï¼Œè·¨åŸŸå…ˆè¡Œã€‚è·¨åŸŸé—®é¢˜æ²¡æœ‰è§£å†³ï¼Œä¸€åˆ‡å¤„ç†éƒ½æ˜¯çº¸è€è™ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨medzåšçš„<a href="https://learnku.com/laravel/t/8816/the-new-wheel-php-cors-cross-origin-resource-sharing-solves-the-cross-domain-requirements-of-the-php-project-program">corsæ‰©å±•åŒ…</a></p>
<h3 id="5-1-1-å®‰è£…medz-cors"><a href="#5-1-1-å®‰è£…medz-cors" class="headerlink" title="5.1.1. å®‰è£…medz/cors"></a>5.1.1. å®‰è£…medz/cors</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer require medz&#x2F;cors</span><br></pre></td></tr></table></figure>
<h3 id="5-1-2-å‘å¸ƒé…ç½®æ–‡ä»¶"><a href="#5-1-2-å‘å¸ƒé…ç½®æ–‡ä»¶" class="headerlink" title="5.1.2. å‘å¸ƒé…ç½®æ–‡ä»¶"></a>5.1.2. å‘å¸ƒé…ç½®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan vendor:publish --provider&#x3D;&quot;Medz\Cors\Laravel\Providers\LaravelServiceProvider&quot; --force</span><br></pre></td></tr></table></figure>
<h3 id="5-1-3-ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#5-1-3-ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="5.1.3. ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>5.1.3. ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p>æ‰“å¼€<code>config/cors.php</code>,åœ¨<code>expose-headers</code>æ·»åŠ å€¼<code>Authorization</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    ......</span><br><span class="line">    <span class="string">&#x27;expose-headers&#x27;</span>     =&gt; [<span class="string">&#x27;Authorization&#x27;</span>],</span><br><span class="line">    ......</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™æ ·è·¨åŸŸè¯·æ±‚æ—¶ï¼Œæ‰èƒ½è¿”å›<code>header</code>å¤´ä¸º<code>Authorization</code>çš„å†…å®¹ï¼Œå¦åˆ™åœ¨åˆ·æ–°ç”¨æˆ·<code>token</code>æ—¶ä¸ä¼šè¿”å›åˆ·æ–°åçš„<code>token</code></p>
</blockquote>
<h3 id="5-1-4-å¢åŠ ä¸­é—´ä»¶åˆ«å"><a href="#5-1-4-å¢åŠ ä¸­é—´ä»¶åˆ«å" class="headerlink" title="5.1.4. å¢åŠ ä¸­é—´ä»¶åˆ«å"></a>5.1.4. å¢åŠ ä¸­é—´ä»¶åˆ«å</h3><p>æ‰“å¼€<code>app/Http/Kernel.php</code>,å¢åŠ ä¸€è¡Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$routeMiddleware</span> = [</span><br><span class="line">        ...... <span class="comment">//å‰é¢çš„ä¸­é—´ä»¶</span></span><br><span class="line">        <span class="string">&#x27;cors&#x27;</span>=&gt; \Medz\Cors\Laravel\Middleware\ShouldGroup::class,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="5-1-5-ä¿®æ”¹è·¯ç”±"><a href="#5-1-5-ä¿®æ”¹è·¯ç”±" class="headerlink" title="5.1.5. ä¿®æ”¹è·¯ç”±"></a>5.1.5. ä¿®æ”¹è·¯ç”±</h3><p>æ‰“å¼€<code>routes/api.php</code>,åœ¨è·¯ç”±ç»„ä¸­å¢åŠ ä½¿ç”¨ä¸­é—´ä»¶</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Route::namespace(<span class="string">&#x27;Api&#x27;</span>)-&gt;prefix(<span class="string">&#x27;v1&#x27;</span>)-&gt;middleware(<span class="string">&#x27;cors&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Route::get(<span class="string">&#x27;/users&#x27;</span>,<span class="string">&#x27;UserController@index&#x27;</span>)-&gt;name(<span class="string">&#x27;users.index&#x27;</span>);</span><br><span class="line">        Route::get(<span class="string">&#x27;/users/&#123;user&#125;&#x27;</span>,<span class="string">&#x27;UserController@show&#x27;</span>)-&gt;name(<span class="string">&#x27;users.show&#x27;</span>);</span><br><span class="line">        Route::post(<span class="string">&#x27;/users&#x27;</span>,<span class="string">&#x27;UserController@store&#x27;</span>)-&gt;name(<span class="string">&#x27;users.store&#x27;</span>);</span><br><span class="line">        Route::post(<span class="string">&#x27;/login&#x27;</span>,<span class="string">&#x27;UserController@login&#x27;</span>)-&gt;name(<span class="string">&#x27;users.login&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="5-2-ç»Ÿä¸€Responseå“åº”å¤„ç†"><a href="#5-2-ç»Ÿä¸€Responseå“åº”å¤„ç†" class="headerlink" title="5.2. ç»Ÿä¸€Responseå“åº”å¤„ç†"></a>5.2. ç»Ÿä¸€Responseå“åº”å¤„ç†</h2><p>æ¥å£ä¸»æµè¿”å›<code>json</code>æ ¼å¼ï¼Œå…¶ä¸­åŒ…å«<code>httpçŠ¶æ€ç </code>ï¼Œ<code>statusè¯·æ±‚çŠ¶æ€</code>ï¼Œ<code>dataè¯·æ±‚èµ„æºç»“æœ</code>ç­‰ç­‰ã€‚éœ€è¦æˆ‘ä»¬æœ‰ä¸€ä¸ªAPIæ¥å£å…¨å±€éƒ½èƒ½æœ‰ç»Ÿä¸€çš„æ ¼å¼å’Œå¯¹åº”çš„æ•°æ®å¤„ç†ã€‚å‚è€ƒäº<a href="https://learnku.com/articles/6035/laravel55-developing-api-combat">è¿™é‡Œ</a>ã€‚</p>
<h3 id="5-2-1-å°è£…è¿”å›çš„ç»Ÿä¸€æ¶ˆæ¯"><a href="#5-2-1-å°è£…è¿”å›çš„ç»Ÿä¸€æ¶ˆæ¯" class="headerlink" title="5.2.1. å°è£…è¿”å›çš„ç»Ÿä¸€æ¶ˆæ¯"></a>5.2.1. å°è£…è¿”å›çš„ç»Ÿä¸€æ¶ˆæ¯</h3><p>åœ¨ <code>app/Api/Helpers</code> ç›®å½•(ä¸å­˜åœ¨ç›®å½•è‡ªå·±æ–°å»º)ä¸‹æ–°å»º <code>ApiResponse.php</code><br>å¡«å…¥å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Api</span>\<span class="title">Helpers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Response</span> <span class="title">as</span> <span class="title">FoundationResponse</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> ApiResponse</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$statusCode</span> = FoundationResponse::HTTP_OK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getStatusCode</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;statusCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $statusCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setStatusCode</span>(<span class="params"><span class="variable">$statusCode</span>,<span class="variable">$httpCode</span>=<span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$httpCode</span> = <span class="variable">$httpCode</span> ?? <span class="variable">$statusCode</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;statusCode = <span class="variable">$statusCode</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $header</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">respond</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$header</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response::json(<span class="variable">$data</span>,<span class="keyword">$this</span>-&gt;getStatusCode(),<span class="variable">$header</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> null $code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">status</span>(<span class="params"><span class="variable">$status</span>, <span class="keyword">array</span> <span class="variable">$data</span>, <span class="variable">$code</span> = <span class="literal">null</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$code</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;setStatusCode(<span class="variable">$code</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$status</span> = [</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span> =&gt; <span class="variable">$status</span>,</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;statusCode</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = array_merge(<span class="variable">$status</span>,<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;respond(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * æ ¼å¼</span></span><br><span class="line"><span class="comment">     * data:</span></span><br><span class="line"><span class="comment">     *  code:422</span></span><br><span class="line"><span class="comment">     *  message:xxx</span></span><br><span class="line"><span class="comment">     *  status:&#x27;error&#x27;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">failed</span>(<span class="params"><span class="variable">$message</span>, <span class="variable">$code</span> = FoundationResponse::HTTP_BAD_REQUEST,<span class="variable">$status</span> = <span class="string">&#x27;error&#x27;</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(<span class="variable">$code</span>)-&gt;message(<span class="variable">$message</span>,<span class="variable">$status</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">message</span>(<span class="params"><span class="variable">$message</span>, <span class="variable">$status</span> = <span class="string">&quot;success&quot;</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;status(<span class="variable">$status</span>,[</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="variable">$message</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">internalError</span>(<span class="params"><span class="variable">$message</span> = <span class="string">&quot;Internal Error!&quot;</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="variable">$message</span>,FoundationResponse::HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">created</span>(<span class="params"><span class="variable">$message</span> = <span class="string">&quot;created&quot;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(FoundationResponse::HTTP_CREATED)</span><br><span class="line">            -&gt;message(<span class="variable">$message</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">success</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$status</span> = <span class="string">&quot;success&quot;</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;status(<span class="variable">$status</span>,compact(<span class="string">&#x27;data&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">notFond</span>(<span class="params"><span class="variable">$message</span> = <span class="string">&#x27;Not Fond!&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="variable">$message</span>,Foundationresponse::HTTP_NOT_FOUND);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-2-æ–°å»ºApiæ§åˆ¶å™¨åŸºç±»"><a href="#5-2-2-æ–°å»ºApiæ§åˆ¶å™¨åŸºç±»" class="headerlink" title="5.2.2. æ–°å»ºApiæ§åˆ¶å™¨åŸºç±»"></a>5.2.2. æ–°å»ºApiæ§åˆ¶å™¨åŸºç±»</h3><p>åœ¨ <code>app/Http/Controller/Api</code> ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª<code>Controller.php</code>ä½œä¸º<code>Api</code>ä¸“é—¨çš„<code>åŸºç±»</code>.<br>å¡«å…¥ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Api</span>\<span class="title">Helpers</span>\<span class="title">ApiResponse</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span> <span class="title">as</span> <span class="title">BaseController</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">use</span> <span class="title">ApiResponse</span>;</span><br><span class="line">    <span class="comment">// å…¶ä»–é€šç”¨çš„Apiå¸®åŠ©å‡½æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-3-ç»§æ‰¿Apiæ§åˆ¶å™¨åŸºç±»"><a href="#5-2-3-ç»§æ‰¿Apiæ§åˆ¶å™¨åŸºç±»" class="headerlink" title="5.2.3. ç»§æ‰¿Apiæ§åˆ¶å™¨åŸºç±»"></a>5.2.3. ç»§æ‰¿Apiæ§åˆ¶å™¨åŸºç±»</h3><p>è®©Apiçš„æ§åˆ¶å™¨ç»§æ‰¿è¿™ä¸ªåŸºç±»å³å¯ã€‚<br>æ‰“å¼€<code>UserController.php</code>æ–‡ä»¶ï¼Œå»æ‰å‘½åç©ºé—´<code>use App\Http\Controllers\Controller</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">UserRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Auth</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-4-å¦‚ä½•ä½¿ç”¨"><a href="#5-2-4-å¦‚ä½•ä½¿ç”¨" class="headerlink" title="5.2.4. å¦‚ä½•ä½¿ç”¨"></a>5.2.4. å¦‚ä½•ä½¿ç”¨</h3><p>å¾—ç›Šäºå‰é¢ç»Ÿä¸€æ¶ˆæ¯çš„å°è£…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸å®¹æ˜“ã€‚<br>1.è¿”å›æ­£ç¡®ä¿¡æ¯</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="string">&#x27;ç”¨æˆ·ç™»å½•æˆåŠŸ...&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>2.è¿”å›æ­£ç¡®èµ„æºä¿¡æ¯</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="variable">$user</span>);</span><br></pre></td></tr></table></figure>
<p>3.è¿”å›è‡ªå®šä¹‰httpçŠ¶æ€ç çš„æ­£ç¡®ä¿¡æ¯</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(<span class="number">201</span>)-&gt;success(<span class="string">&#x27;ç”¨æˆ·ç™»å½•æˆåŠŸ...&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>4.è¿”å›é”™è¯¯ä¿¡æ¯</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="string">&#x27;ç”¨æˆ·æ³¨å†Œå¤±è´¥&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>5.è¿”å›è‡ªå®šä¹‰httpçŠ¶æ€ç çš„é”™è¯¯ä¿¡æ¯</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="string">&#x27;ç”¨æˆ·ç™»å½•å¤±è´¥&#x27;</span>,<span class="number">401</span>);</span><br></pre></td></tr></table></figure>
<p>6.è¿”å›è‡ªå®šä¹‰httpçŠ¶æ€ç çš„é”™è¯¯ä¿¡æ¯,åŒæ—¶ä¹Ÿæƒ³è¿”å›è‡ªå·±å†…éƒ¨å®šä¹‰çš„é”™è¯¯ç </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="string">&#x27;ç”¨æˆ·ç™»å½•å¤±è´¥&#x27;</span>,<span class="number">401</span>,<span class="number">10001</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>é»˜è®¤successè¿”å›çš„çŠ¶æ€ç æ˜¯200ï¼Œfailedè¿”å›çš„çŠ¶æ€ç æ˜¯400</p>
</blockquote>
<h3 id="5-2-5-ä¿®æ”¹ç”¨æˆ·æ§åˆ¶å™¨"><a href="#5-2-5-ä¿®æ”¹ç”¨æˆ·æ§åˆ¶å™¨" class="headerlink" title="5.2.5. ä¿®æ”¹ç”¨æˆ·æ§åˆ¶å™¨"></a>5.2.5. ä¿®æ”¹ç”¨æˆ·æ§åˆ¶å™¨</h3><p>æˆ‘ä»¬å°†ç»Ÿä¸€æ¶ˆæ¯å°è£…è¿ç”¨åˆ°<code>UserController</code>ä¸­</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">UserRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Auth</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//3ä¸ªç”¨æˆ·ä¸ºä¸€é¡µ</span></span><br><span class="line">        <span class="variable">$users</span> = User::paginate(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="variable">$users</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›å•ä¸€ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">User <span class="variable">$user</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="variable">$user</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">UserRequest <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">        User::create(<span class="variable">$request</span>-&gt;all());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(<span class="number">201</span>)-&gt;success(<span class="string">&#x27;ç”¨æˆ·æ³¨å†ŒæˆåŠŸ&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">Request <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$res</span>=Auth::guard(<span class="string">&#x27;web&#x27;</span>)-&gt;attempt([<span class="string">&#x27;name&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;name,<span class="string">&#x27;password&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;password]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$res</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(<span class="number">201</span>)-&gt;success(<span class="string">&#x27;ç”¨æˆ·ç™»å½•æˆåŠŸ...&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="string">&#x27;ç”¨æˆ·ç™»å½•å¤±è´¥&#x27;</span>,<span class="number">401</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-6-æµ‹è¯•"><a href="#5-2-6-æµ‹è¯•" class="headerlink" title="5.2.6. æµ‹è¯•"></a>5.2.6. æµ‹è¯•</h3><ol>
<li>è¿”å›ç”¨æˆ·åˆ—è¡¨<br>è¯·æ±‚<code>http://ä½ çš„åŸŸå/api/v1/users</code><br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/MgY6gBEEHM.png!large" alt="file"></li>
<li>è¿”å›å•ä¸€ç”¨æˆ·<br>è¯·æ±‚<code>http://ä½ çš„åŸŸå/api/v1/users/1</code><br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/zmeLfnRmcZ.png!large" alt="file"></li>
<li>ç™»é™†æ­£ç¡®<br>è¯·æ±‚<code>http://ä½ çš„åŸŸå/api/v1/login</code><br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/6ZGWMcrWCA.png!large" alt="file"></li>
<li>ç™»é™†é”™è¯¯<br>è¯·æ±‚<code>http://ä½ çš„åŸŸå/api/v1/login</code><br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/jQkIwUF0u1.png!large" alt="file"><h2 id="5-3-Api-Resourceèµ„æº"><a href="#5-3-Api-Resourceèµ„æº" class="headerlink" title="5.3. Api-Resourceèµ„æº"></a>5.3. Api-Resourceèµ„æº</h2></li>
</ol>
<p>åœ¨ä¸Šé¢è¯·æ±‚è¿”å›ç”¨æˆ·åˆ—è¡¨å’Œè¿”å›å•ä¸€ç”¨æˆ·æ—¶ï¼Œè¿”å›çš„å­—æ®µéƒ½æ˜¯æ•°æ®åº“é‡Œæ‰€æœ‰çš„å­—æ®µï¼Œå½“ç„¶ï¼Œä¸åŒ…å«æˆ‘ä»¬åœ¨<code>User</code>æ¨¡å‹ä¸­å»é™¤çš„<code>password</code>å­—æ®µã€‚</p>
<h3 id="5-3-1-éœ€æ±‚"><a href="#5-3-1-éœ€æ±‚" class="headerlink" title="5.3.1. éœ€æ±‚"></a>5.3.1. éœ€æ±‚</h3><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¦‚æœæƒ³æ§åˆ¶è¿”å›çš„å­—æ®µæœ‰å“ªäº›ï¼Œå¯ä»¥ä½¿ç”¨<code>select</code>æˆ–è€…ä½¿ç”¨<code>User</code>æ¨¡å‹ä¸­çš„<code>hidden</code>æ•°ç»„æ¥é™åˆ¶å­—æ®µã€‚</p>
<p>è¿™2ç§åŠæ³•è™½ç„¶å¯ä»¥ï¼Œä½†æ˜¯æ‰©å±•æ€§å¤ªå·®ã€‚å¹¶ä¸”æˆ‘æƒ³å¯¹<code>status</code>è¿”å›çš„å½¢å¼è¿›è¡Œä¿®æ”¹ï¼Œæ¯”å¦‚0çš„æ—¶å€™æ˜¾ç¤ºæ­£å¸¸ï¼Œ1æ˜¾ç¤ºå†»ç»“ï¼Œæ­¤æ—¶å°±éœ€è¦éå†æ•°æ®è¿›è¡Œä¿®æ”¹äº†ã€‚æ­¤æ—¶ï¼ŒLaravelæä¾›çš„<code>API èµ„æº</code>å°±å¯ä»¥å¾ˆå¥½åœ°è§£å†³æˆ‘ä»¬çš„é—®é¢˜ã€‚</p>
<blockquote>
<p>å½“æ„å»º API æ—¶ï¼Œä½ å¾€å¾€éœ€è¦ä¸€ä¸ªè½¬æ¢å±‚æ¥è”ç»“ä½ çš„ Eloquent æ¨¡å‹å’Œå®é™…è¿”å›ç»™ç”¨æˆ·çš„ JSON å“åº”ã€‚Laravel çš„èµ„æºç±»èƒ½å¤Ÿè®©ä½ ä»¥æ›´ç›´è§‚ç®€ä¾¿çš„æ–¹å¼å°†æ¨¡å‹å’Œæ¨¡å‹é›†åˆè½¬åŒ–æˆ JSONã€‚</p>
</blockquote>
<blockquote>
<p>ä¹Ÿå°±æ˜¯åœ¨Cå±‚è¾“å‡ºVå±‚æ—¶ï¼Œä¸­é—´å†æ¥ä¸€å±‚æ¥ä¸“é—¨å¤„ç†å­—æ®µé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸º<code>ViewModel</code>å±‚ã€‚</p>
</blockquote>
<p>è¯¦ç»†å¯ä»¥æŸ¥çœ‹<a href="https://learnku.com/docs/laravel/5.7/eloquent-resources/2298">æ‰‹å†Œ</a>å¦‚ä½•ä½¿ç”¨ã€‚</p>
<h3 id="5-3-2-åˆ›å»ºå•ä¸€ç”¨æˆ·èµ„æºå’Œåˆ—è¡¨ç”¨æˆ·èµ„æº"><a href="#5-3-2-åˆ›å»ºå•ä¸€ç”¨æˆ·èµ„æºå’Œåˆ—è¡¨ç”¨æˆ·èµ„æº" class="headerlink" title="5.3.2. åˆ›å»ºå•ä¸€ç”¨æˆ·èµ„æºå’Œåˆ—è¡¨ç”¨æˆ·èµ„æº"></a>5.3.2. åˆ›å»ºå•ä¸€ç”¨æˆ·èµ„æºå’Œåˆ—è¡¨ç”¨æˆ·èµ„æº</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan make:resource Api&#x2F;UserResource</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹<code>app/Http/Resources/Api</code> ç›®å½•ä¸‹çš„ <code>UserResource.php</code>æ–‡ä»¶</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Resources</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Resources</span>\<span class="title">Json</span>\<span class="title">JsonResource</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserResource</span> <span class="keyword">extends</span> <span class="title">JsonResource</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transform the resource into an array.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;status)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;status = <span class="string">&#x27;å·²åˆ é™¤&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;status = <span class="string">&#x27;æ­£å¸¸&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;status = <span class="string">&#x27;å†»ç»“&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>=&gt;<span class="keyword">$this</span>-&gt;id,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;name,</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;status,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>=&gt;(<span class="keyword">string</span>)<span class="keyword">$this</span>-&gt;created_at,</span><br><span class="line">            <span class="string">&#x27;updated_at&#x27;</span>=&gt;(<span class="keyword">string</span>)<span class="keyword">$this</span>-&gt;updated_at</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-3-3-å¦‚ä½•ä½¿ç”¨"><a href="#5-3-3-å¦‚ä½•ä½¿ç”¨" class="headerlink" title="5.3.3. å¦‚ä½•ä½¿ç”¨"></a>5.3.3. å¦‚ä½•ä½¿ç”¨</h3><p>è¿”å›å•ä¸€ç”¨æˆ·(å•ä¸€çš„èµ„æº)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="keyword">new</span> UserResource(<span class="variable">$user</span>));</span><br></pre></td></tr></table></figure>
<p>è¿”å›ç”¨æˆ·åˆ—è¡¨(èµ„æºåˆ—è¡¨)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> UserResource::collection(<span class="variable">$users</span>);</span><br><span class="line"><span class="comment">//è¿™é‡Œä¸èƒ½ç”¨$this-&gt;success(UserResource::collection($users))</span></span><br><span class="line"><span class="comment">//å¦åˆ™ä¸èƒ½è¿”å›åˆ†é¡µæ ‡ç­¾ä¿¡æ¯</span></span><br></pre></td></tr></table></figure>
<h3 id="5-3-4-ä¿®æ”¹ç”¨æˆ·æ§åˆ¶å™¨"><a href="#5-3-4-ä¿®æ”¹ç”¨æˆ·æ§åˆ¶å™¨" class="headerlink" title="5.3.4. ä¿®æ”¹ç”¨æˆ·æ§åˆ¶å™¨"></a>5.3.4. ä¿®æ”¹ç”¨æˆ·æ§åˆ¶å™¨</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è¿”å›ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//3ä¸ªç”¨æˆ·ä¸ºä¸€é¡µ</span></span><br><span class="line">    <span class="variable">$users</span> = User::paginate(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> UserResource::collection(<span class="variable">$users</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿”å›å•ä¸€ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">User <span class="variable">$user</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="keyword">new</span> UserResource(<span class="variable">$user</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-3-5-æµ‹è¯•"><a href="#5-3-5-æµ‹è¯•" class="headerlink" title="5.3.5. æµ‹è¯•"></a>5.3.5. æµ‹è¯•</h3><p>è¿”å›å•ä¸€ç”¨æˆ·(å•ä¸€çš„èµ„æº)<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/twtvLpxFxu.png!large" alt="file"><br>è¿”å›ç”¨æˆ·åˆ—è¡¨(èµ„æºåˆ—è¡¨)<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/KUD37DL6Zi.png!large" alt="file"></p>
<h2 id="5-4-Enumæšä¸¾"><a href="#5-4-Enumæšä¸¾" class="headerlink" title="5.4. Enumæšä¸¾"></a>5.4. Enumæšä¸¾</h2><p>æˆ‘ä»¬å¸¸å¸¸ä¼šä½¿ç”¨æ•°å­—æ¥ä»£è¡¨çŠ¶æ€ï¼Œæ¯”å¦‚ç”¨æˆ·è¡¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>-1</code> ä»£è¡¨å·²åˆ é™¤ <code>0</code> ä»£è¡¨æ­£å¸¸ <code>1</code> ä»£è¡¨å†»ç»“ã€‚</p>
<h3 id="5-4-1-ä¸¤ä¸ªé—®é¢˜"><a href="#5-4-1-ä¸¤ä¸ªé—®é¢˜" class="headerlink" title="5.4.1. ä¸¤ä¸ªé—®é¢˜"></a>5.4.1. ä¸¤ä¸ªé—®é¢˜</h3><ol>
<li><p>å½“æˆ‘ä»¬åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·ï¼Œå¦‚æœæ˜¯åˆ é™¤æˆ–è€…å†»ç»“çŠ¶æ€å°±ä¸è®©å…¶ç™»é™†äº†ã€‚åˆ¤æ–­ä»£ç è¿™æ ·å†™</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æœ‰å¯èƒ½çŠ¶æ€æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥è¿™è¾¹å°±ç›´æ¥ç”¨ æˆ– æ¥åˆ¤æ–­ä¸å–åäº†ã€‚</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>-&gt;status==<span class="number">-1</span>||<span class="variable">$user</span>-&gt;status==<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="comment">// ä¸å…è®¸ç”¨æˆ·ç™»å½•é€»è¾‘</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”¨æˆ·æ­£å¸¸ç™»å½•é€»è¾‘</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢é€»è¾‘å’Œç¼–å†™æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚å› ä¸ºæ˜¯ç°åœ¨çœ‹ï¼Œå¯ä»¥å¾ˆæ˜ç™½çš„çŸ¥é“<code>-1</code> ä»£è¡¨å·²åˆ é™¤ï¼Œ<code>1</code> ä»£è¡¨å†»ç»“ã€‚ä½†æ˜¯å¦‚æœä¸€ä¸ªæœˆåå†æ¥çœ‹è¿™è¡Œä»£ç ï¼Œæ—©å·²ç»å¿˜è®°äº† <code>-1</code> è·Ÿ <code>1</code> å…·ä½“è¡¨ç¤ºçš„å«ä¹‰ã€‚</p>
</li>
<li><p>å‚è€ƒä¸Šé¢<code>UserResource.php</code>ç¼–å†™æ—¶ï¼Œåˆ¤æ–­<code>status</code>å…·ä½“çŠ¶æ€å‡½æ•°ï¼Œæˆ‘ä»¬æ˜¯ä½¿ç”¨<code>switch</code>è¯­å¥ã€‚è¿™æ ·å¤ªä¸ç¾è§‚ï¼Œè€Œä¸”åœ°æ–¹ç”¨å¤šäº†è¿˜å®¹æ˜“å†—ä½™ï¼Œæ¯æ¬¡ç¼–å†™éƒ½éœ€è¦å»æŸ¥çœ‹æ¯ä¸ªæ•°å­—ä»£è¡¨çš„å…·ä½“æ„æ€ã€‚</p>
</li>
</ol>
<h3 id="5-4-2-è§£å†³æ€è·¯"><a href="#5-4-2-è§£å†³æ€è·¯" class="headerlink" title="5.4.2. è§£å†³æ€è·¯"></a>5.4.2. è§£å†³æ€è·¯</h3><ol>
<li>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆä¸€æ®µæ—¶é—´åå†çœ‹å°±ä¸çŸ¥é“<code>-1</code> è·Ÿ <code>1</code> å…·ä½“è¡¨ç¤ºçš„å«ä¹‰ï¼Ÿ</li>
</ol>
<p>Â  Â  Â  Â è¿™æ˜¯å› ä¸ºå•çº¯çš„æ•°å­—æ²¡æœ‰è§£é‡Šè¯´æ˜çš„ä½œç”¨ï¼Œå˜é‡ä»¥åŠå‡½æ•°è¿™äº›å…·æœ‰è§£é‡Šè¯´æ˜çš„ä½œç”¨ï¼Œå¯ä»¥è®©æˆ‘ä»¬ç«‹åˆ»çŸ¥é“å…·ä½“å«ä¹‰ã€‚</p>
<ol start="2">
<li>ç¬¬äºŒä¸ªé—®é¢˜ï¼šå¦‚ä½•ç»™ä¸€ä¸ªæ•°å­—å°±èƒ½ç›´æ¥çŸ¥é“å®ƒä»£è¡¨çš„å«ä¹‰ï¼Ÿ</li>
</ol>
<p>Â  Â  Â  Â æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›è¿™ä¸ªæ•°å­—ä»£è¡¨çš„å…·ä½“å«ä¹‰ã€‚</p>
<p>è€Œè¿™äº›ï¼Œéƒ½å¯ä»¥ä½¿ç”¨<code>Enumæšä¸¾</code>å¯ä»¥è§£å†³ã€‚</p>
<h3 id="5-4-3-æ³¨æ„"><a href="#5-4-3-æ³¨æ„" class="headerlink" title="5.4.3. æ³¨æ„"></a>5.4.3. æ³¨æ„</h3><p><code>PHP</code>å’Œ<code>Laravel</code>æ¡†æ¶æœ¬èº«æ˜¯ä¸æ”¯æŒ<code>Enumæšä¸¾</code>çš„ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿæšä¸¾çš„åŠŸèƒ½</p>
<h3 id="5-4-4-åˆ›å»ºæšä¸¾"><a href="#5-4-4-åˆ›å»ºæšä¸¾" class="headerlink" title="5.4.4. åˆ›å»ºæšä¸¾"></a>5.4.4. åˆ›å»ºæšä¸¾</h3><p>åœ¨ <code>app/Models</code> ä¸‹æ–°å»ºç›®å½• <code>Enum</code> ,å¹¶åœ¨ç›®å½•<code>Enum</code>ä¸‹æ–°å»º <code>UserEnum.php</code> æ–‡ä»¶ï¼Œå¡«å†™ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">Enum</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserEnum</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// çŠ¶æ€ç±»åˆ«</span></span><br><span class="line">    <span class="keyword">const</span> INVALID = <span class="number">-1</span>; <span class="comment">//å·²åˆ é™¤</span></span><br><span class="line">    <span class="keyword">const</span> NORMAL = <span class="number">0</span>; <span class="comment">//æ­£å¸¸</span></span><br><span class="line">    <span class="keyword">const</span> FREEZE = <span class="number">1</span>; <span class="comment">//å†»ç»“</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getStatusName</span>(<span class="params"><span class="variable">$status</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$status</span>)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">self</span>::INVALID:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;å·²åˆ é™¤&#x27;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">self</span>::NORMAL:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;æ­£å¸¸&#x27;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">self</span>::FREEZE:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;å†»ç»“&#x27;</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;æ­£å¸¸&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-4-5-ä½¿ç”¨"><a href="#5-4-5-ä½¿ç”¨" class="headerlink" title="5.4.5. ä½¿ç”¨"></a>5.4.5. ä½¿ç”¨</h3><p>1.è¡¨ç¤ºå…·ä½“å«ä¹‰</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æœ‰å¯èƒ½çŠ¶æ€æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥è¿™è¾¹å°±ç›´æ¥ç”¨ æˆ– æ¥åˆ¤æ–­ä¸å–åäº†ã€‚</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>-&gt;status==UserEnum::INVALID||<span class="variable">$user</span>-&gt;status==UserEnum::FREEZE)&#123;</span><br><span class="line">    <span class="comment">// ä¸å…è®¸ç”¨æˆ·ç™»å½•é€»è¾‘</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”¨æˆ·æ­£å¸¸ç™»å½•é€»è¾‘</span></span><br></pre></td></tr></table></figure>
<p>2.ä¿®æ”¹<code>UserResource.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>=&gt;<span class="keyword">$this</span>-&gt;id,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;name,</span><br><span class="line">        <span class="string">&#x27;status&#x27;</span> =&gt; UserEnum::getStatusName(<span class="keyword">$this</span>-&gt;status),</span><br><span class="line">        <span class="string">&#x27;created_at&#x27;</span>=&gt;(<span class="keyword">string</span>)<span class="keyword">$this</span>-&gt;created_at,</span><br><span class="line">        <span class="string">&#x27;updated_at&#x27;</span>=&gt;(<span class="keyword">string</span>)<span class="keyword">$this</span>-&gt;updated_at</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†è¯·æ±‚å•ä¸€ç”¨æˆ·å’Œç”¨æˆ·åˆ—è¡¨æ¥å£ï¼Œè¿”å›ç»“æœå’Œä¹‹å‰ä¸€æ ·ã€‚</p>
<h2 id="5-5-å¼‚å¸¸è‡ªå®šä¹‰å¤„ç†"><a href="#5-5-å¼‚å¸¸è‡ªå®šä¹‰å¤„ç†" class="headerlink" title="5.5. å¼‚å¸¸è‡ªå®šä¹‰å¤„ç†"></a>5.5. å¼‚å¸¸è‡ªå®šä¹‰å¤„ç†</h2><h3 id="5-5-1-å†å‘ç°ä¸€ä¸ªé—®é¢˜"><a href="#5-5-1-å†å‘ç°ä¸€ä¸ªé—®é¢˜" class="headerlink" title="5.5.1. å†å‘ç°ä¸€ä¸ªé—®é¢˜"></a>5.5.1. å†å‘ç°ä¸€ä¸ªé—®é¢˜</h3><p>æˆ‘ä»¬åœ¨<code>UserController.php</code>æ–‡ä»¶ä¸­ä¿®æ”¹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è¿”å›å•ä¸€ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">User <span class="variable">$user</span></span>)</span>&#123;</span><br><span class="line">    <span class="number">3</span>/<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="keyword">new</span> UserResource(<span class="variable">$user</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ•…æ„æŠ¥ä¸ªé”™ï¼Œè¯·æ±‚çœ‹çœ‹ç»“æœ<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/PYLjHqbuvv.png!large" alt="file"><br>æˆ‘ä»¬å†æŠŠè®¾ç½®æˆ<code>ajax</code>çš„<code>header</code>å¤´å»æ‰<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/nCzqtib1RR.png!large" alt="file"></p>
<p>æŠ¥é”™éå¸¸è¯¦ç»†ï¼Œå¹¶ä¸”æŠŠæˆ‘ä»¬éšç§è®¾ç½®éƒ½æš´éœ²å‡ºæ¥äº†ï¼Œè¿™æ˜¯ç”±äºæˆ‘ä»¬<code>.env</code>çš„<code>APP_DEBUG</code>æ˜¯<code>true</code>çŠ¶æ€ã€‚æˆ‘ä»¬ä¸å¸Œæœ›è¿™äº›ä¿¡æ¯è¢«å…¶ä»–è®¿é—®è€…çœ‹åˆ°ã€‚æˆ‘ä»¬æ”¹ä¸º<code>false</code>ï¼Œå†è¯·æ±‚çœ‹çœ‹ç»“æœã€‚</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/t8DJo0tk39.png!large" alt="file"></p>
<blockquote>
<p>å—¯ã€‚å¾ˆå¥½ï¼Œä¸ä»…åˆ«äººçœ‹ä¸åˆ°äº†ï¼Œè¿æˆ‘ä»¬è‡ªå·±éƒ½çœ‹ä¸åˆ°äº†</p>
</blockquote>
<h3 id="5-5-2-éœ€æ±‚"><a href="#5-5-2-éœ€æ±‚" class="headerlink" title="5.5.2. éœ€æ±‚"></a>5.5.2. éœ€æ±‚</h3><ol>
<li>æ‰€æœ‰çš„å¼‚å¸¸ä¿¡æ¯éƒ½ä»¥ç»Ÿä¸€<code>json</code>æ ¼å¼è¾“å‡º</li>
<li>å› ä¸ºæˆ‘ä»¬æ˜¯å¼€å‘è€…ï¼Œå¹¶ä¸”<code>.env</code>æ–‡ä»¶é»˜è®¤æ˜¯ä¸åŠ å…¥<code>git</code>ä¸Šä¼ çº¿ä¸Šçš„ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥å½“<code>APP_DEBUG</code>ä¸º<code>true</code>(æœ¬åœ°)çš„æ—¶å€™å¯ä»¥ç»§ç»­æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œ<code>false</code>(çº¿ä¸Š)çš„æ—¶å€™å°±æ˜¾ç¤ºç®€è¦<code>json</code>ä¿¡æ¯ï¼Œæ¯”å¦‚500ã€‚</li>
</ol>
<h3 id="5-5-3-åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†"><a href="#5-5-3-åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†" class="headerlink" title="5.5.3. åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†"></a>5.5.3. åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†</h3><p>åœ¨ <code>app/Api/Helpers</code> ç›®å½•ä¸‹æ–°å»º <code>ExceptionReport.php</code> æ–‡ä»¶ï¼Œå¡«å…¥ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Api</span>\<span class="title">Helpers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">Access</span>\<span class="title">AuthorizationException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">AuthenticationException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">ModelNotFoundException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Validation</span>\<span class="title">ValidationException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Exception</span>\<span class="title">MethodNotAllowedHttpException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Exception</span>\<span class="title">NotFoundHttpException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Exception</span>\<span class="title">UnauthorizedHttpException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">TokenInvalidException</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExceptionReport</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ApiResponse</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$exception</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$request</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$report</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ExceptionReport constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Exception $exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">Request <span class="variable">$request</span>, <span class="built_in">Exception</span> <span class="variable">$exception</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;request = <span class="variable">$request</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;exception = <span class="variable">$exception</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//å½“æŠ›å‡ºè¿™äº›å¼‚å¸¸æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘ä»¬å®šä¹‰çš„é”™è¯¯ä¿¡æ¯ä¸HTTPçŠ¶æ€ç </span></span><br><span class="line">    <span class="comment">//å¯ä»¥æŠŠå¸¸è§å¼‚å¸¸æ”¾åœ¨è¿™é‡Œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$doReport</span> = [</span><br><span class="line">        AuthenticationException::class =&gt; [<span class="string">&#x27;æœªæˆæƒ&#x27;</span>,<span class="number">401</span>],</span><br><span class="line">        ModelNotFoundException::class =&gt; [<span class="string">&#x27;è¯¥æ¨¡å‹æœªæ‰¾åˆ°&#x27;</span>,<span class="number">404</span>],</span><br><span class="line">        AuthorizationException::class =&gt; [<span class="string">&#x27;æ²¡æœ‰æ­¤æƒé™&#x27;</span>,<span class="number">403</span>],</span><br><span class="line">        ValidationException::class =&gt; [],</span><br><span class="line">        UnauthorizedHttpException::class=&gt;[<span class="string">&#x27;æœªç™»å½•æˆ–ç™»å½•çŠ¶æ€å¤±æ•ˆ&#x27;</span>,<span class="number">422</span>],</span><br><span class="line">        TokenInvalidException::class=&gt;[<span class="string">&#x27;tokenä¸æ­£ç¡®&#x27;</span>,<span class="number">400</span>],</span><br><span class="line">        NotFoundHttpException::class=&gt;[<span class="string">&#x27;æ²¡æœ‰æ‰¾åˆ°è¯¥é¡µé¢&#x27;</span>,<span class="number">404</span>],</span><br><span class="line">        MethodNotAllowedHttpException::class=&gt;[<span class="string">&#x27;è®¿é—®æ–¹å¼ä¸æ­£ç¡®&#x27;</span>,<span class="number">405</span>],</span><br><span class="line">		QueryException::class=&gt;[<span class="string">&#x27;å‚æ•°é”™è¯¯&#x27;</span>,<span class="number">401</span>],</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$className</span>,<span class="keyword">callable</span> <span class="variable">$callback</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;doReport[<span class="variable">$className</span>] = <span class="variable">$callback</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">shouldReturn</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//åªæœ‰è¯·æ±‚åŒ…å«æ˜¯jsonæˆ–è€…ajaxè¯·æ±‚æ—¶æ‰æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment">//        if (! ($this-&gt;request-&gt;wantsJson() || $this-&gt;request-&gt;ajax()))&#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            return false;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">foreach</span> (array_keys(<span class="keyword">$this</span>-&gt;doReport) <span class="keyword">as</span> <span class="variable">$report</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exception <span class="keyword">instanceof</span> <span class="variable">$report</span>)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;report = <span class="variable">$report</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Exception $e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> static</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params"><span class="built_in">Exception</span> <span class="variable">$e</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">static</span>(\request(),<span class="variable">$e</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">report</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exception <span class="keyword">instanceof</span> ValidationException)&#123;</span><br><span class="line">            <span class="variable">$error</span> = array_first(<span class="keyword">$this</span>-&gt;exception-&gt;errors());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(array_first(<span class="variable">$error</span>),<span class="keyword">$this</span>-&gt;exception-&gt;status);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$message</span> = <span class="keyword">$this</span>-&gt;doReport[<span class="keyword">$this</span>-&gt;report];</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="variable">$message</span>[<span class="number">0</span>],<span class="variable">$message</span>[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prodReport</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="string">&#x27;æœåŠ¡å™¨é”™è¯¯&#x27;</span>,<span class="string">&#x27;500&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-5-4-æ•æ‰å¼‚å¸¸"><a href="#5-5-4-æ•æ‰å¼‚å¸¸" class="headerlink" title="5.5.4. æ•æ‰å¼‚å¸¸"></a>5.5.4. æ•æ‰å¼‚å¸¸</h3><p>ä¿®æ”¹ <code>app/Exceptions</code> ç›®å½•ä¸‹çš„ <code>Handler.php</code> æ–‡ä»¶</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Exceptions</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Api</span>\<span class="title">Helpers</span>\<span class="title">ExceptionReport</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Exceptions</span>\<span class="title">Handler</span> <span class="title">as</span> <span class="title">ExceptionHandler</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">extends</span> <span class="title">ExceptionHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Exception</span> <span class="variable">$exception</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//ajaxè¯·æ±‚æˆ‘ä»¬æ‰æ•æ‰å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$request</span>-&gt;ajax())&#123;</span><br><span class="line">            <span class="comment">// å°†æ–¹æ³•æ‹¦æˆªåˆ°è‡ªå·±çš„ExceptionReport</span></span><br><span class="line">            <span class="variable">$reporter</span> = ExceptionReport::make(<span class="variable">$exception</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$reporter</span>-&gt;shouldReturn())&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$reporter</span>-&gt;report();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(env(<span class="string">&#x27;APP_DEBUG&#x27;</span>))&#123;</span><br><span class="line">                <span class="comment">//å¼€å‘ç¯å¢ƒï¼Œåˆ™æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">parent</span>::render(<span class="variable">$request</span>, <span class="variable">$exception</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//çº¿ä¸Šç¯å¢ƒ,æœªçŸ¥é”™è¯¯ï¼Œåˆ™æ˜¾ç¤º500</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$reporter</span>-&gt;prodReport();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parent</span>::render(<span class="variable">$request</span>, <span class="variable">$exception</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-5-5-æµ‹è¯•"><a href="#5-5-5-æµ‹è¯•" class="headerlink" title="5.5.5. æµ‹è¯•"></a>5.5.5. æµ‹è¯•</h3><p>ç»§ç»­æ‰“å¼€è®¾ç½®<code>AJAX</code>çš„<code>header</code>å¤´</p>
<p>1.å…³é—­<code>APP_DEBUG</code>ï¼Œè¯·æ±‚åˆšåˆšæ•…æ„é”™è¯¯çš„æ¥å£ã€‚<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/ExjP7nbJ9E.png!large" alt="file"><br>2.å¼€å¯<code>APP_DEBUG</code>ï¼Œè¯·æ±‚åˆšåˆšæ•…æ„é”™è¯¯çš„æ¥å£ã€‚<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/h9xJOYFNHv.png!large" alt="file"><br>3.è¯·æ±‚ä¸€ä¸ªä¸å­˜åœ¨çš„è·¯ç”±ï¼ŒæŸ¥çœ‹è¿”å›ç»“æœã€‚<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/xSiSqMS1GK.png!large" alt="file"></p>
<blockquote>
<p>å…¶ä»–çš„å¼‚å¸¸æ˜¾ç¤ºï¼Œè‡ªè¡Œæµ‹è¯•å•¦~</p>
</blockquote>
<h2 id="5-6-jwt-auth"><a href="#5-6-jwt-auth" class="headerlink" title="5.6. jwt-auth"></a>5.6. jwt-auth</h2><p>åœ¨ä¼ ç»Ÿwebä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ˜¯ä½¿ç”¨<code>session</code>æ¥åˆ¤å®šä¸€ä¸ªç”¨æˆ·çš„ç™»é™†çŠ¶æ€ã€‚è€Œåœ¨<code>API</code>å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<code>token</code>ã€‚<code>jwt-token</code>æ˜¯<code>Laravel</code>å¼€å‘<code>API</code>ç”¨çš„æ¯”è¾ƒå¤šçš„ã€‚</p>
<blockquote>
<p>JWT å…¨ç§° JSON Web Tokens ï¼Œæ˜¯ä¸€ç§è§„èŒƒåŒ–çš„ tokenã€‚å¯ä»¥ç†è§£ä¸ºå¯¹ token è¿™ä¸€æŠ€æœ¯æå‡ºä¸€å¥—è§„èŒƒï¼Œæ˜¯åœ¨ RFC 7519 ä¸­æå‡ºçš„ã€‚</p>
</blockquote>
<p><code>jwt-auth</code>çš„è¯¦ç»†ä»‹ç»åˆ†æå¯ä»¥çœ‹<a href="https://learnku.com/articles/17883">JWTè¶…è¯¦ç»†åˆ†æ</a>è¿™ç¯‡æ–‡ç« ï¼Œå…·ä½“ä½¿ç”¨å¯ä»¥çœ‹<a href="https://learnku.com/articles/10885/full-use-of-jwt">JWTå®Œæ•´ä½¿ç”¨è¯¦è§£</a> è¿™ç¯‡æ–‡ç« ã€‚</p>
<h3 id="5-6-1-å®‰è£…"><a href="#5-6-1-å®‰è£…" class="headerlink" title="5.6.1. å®‰è£…"></a>5.6.1. å®‰è£…</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer require tymon&#x2F;jwt-auth 1.0.0-rc.3</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯<code>Laravel5.5</code>ç‰ˆæœ¬ï¼Œåˆ™å®‰è£…<code>rc.1</code>ã€‚å¦‚æœæ˜¯<code>Laravel5.6</code>ç‰ˆæœ¬ï¼Œåˆ™å®‰è£…<code>rc.2</code></p>
<h3 id="5-6-2-é…ç½®"><a href="#5-6-2-é…ç½®" class="headerlink" title="5.6.2. é…ç½®"></a>5.6.2. é…ç½®</h3><p>é…ç½®å‚è€ƒæ¥è‡ª<a href="https://learnku.com/articles/7264/using-jwt-auth-to-implement-api-user-authentication-and-painless-refresh-access-token">ä½¿ç”¨ Jwt-Auth å®ç° API ç”¨æˆ·è®¤è¯ä»¥åŠæ— ç—›åˆ·æ–°è®¿é—®ä»¤ç‰Œ</a></p>
<p>1.æ·»åŠ æœåŠ¡æä¾›å•†<br>æ‰“å¼€ <code>config</code> ç›®å½•ä¸‹çš„ app.phpæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢ä»£ç </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;providers&#x27;</span> =&gt; [</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Tymon\JWTAuth\Providers\LaravelServiceProvider::class,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>2.å‘å¸ƒé…ç½®æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan vendor:publish --provider&#x3D;&quot;Tymon\JWTAuth\Providers\LaravelServiceProvider&quot;</span><br></pre></td></tr></table></figure>
<p>æ­¤å‘½ä»¤ä¼šåœ¨ <code>config</code> ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª <code>jwt.php</code> é…ç½®æ–‡ä»¶ï¼Œä½ å¯ä»¥åœ¨æ­¤è¿›è¡Œè‡ªå®šä¹‰é…ç½®ã€‚</p>
<p>3.ç”Ÿæˆå¯†é’¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan jwt:secret</span><br></pre></td></tr></table></figure>
<p>æ­¤å‘½ä»¤ä¼šåœ¨ä½ çš„ <code>.env</code> æ–‡ä»¶ä¸­æ–°å¢ä¸€è¡Œ <code>JWT_SECRET=secret</code>ã€‚ä»¥æ­¤æ¥ä½œä¸ºåŠ å¯†æ—¶ä½¿ç”¨çš„ç§˜é’¥ã€‚</p>
<p>4.é…ç½® Auth guard<br>æ‰“å¼€ <code>config</code> ç›®å½•ä¸‹çš„ auth.phpæ–‡ä»¶ï¼Œä¿®æ”¹ä¸ºä¸‹é¢ä»£ç </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;guards&#x27;</span> =&gt; [</span><br><span class="line">    <span class="string">&#x27;web&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;session&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;provider&#x27;</span> =&gt; <span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;api&#x27;</span> =&gt; [</span><br><span class="line">       <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;jwt&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;provider&#x27;</span> =&gt; <span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½è®©apiçš„ç”¨æˆ·è®¤è¯å˜æˆä½¿ç”¨<code>jwt</code>ã€‚</p>
<p>5.æ›´æ”¹ Model</p>
<p>å¦‚æœéœ€è¦ä½¿ç”¨ <code>jwt-auth</code> ä½œä¸ºç”¨æˆ·è®¤è¯ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æˆ‘ä»¬çš„ <code>User</code> æ¨¡å‹è¿›è¡Œä¸€ç‚¹å°å°çš„æ”¹å˜ï¼Œå®ç°ä¸€ä¸ªæ¥å£ï¼Œå˜æ›´åçš„ <code>User</code> æ¨¡å‹å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Notifications</span>\<span class="title">Notifiable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">Authenticatable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Contracts</span>\<span class="title">JWTSubject</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span> <span class="keyword">implements</span> <span class="title">JWTSubject</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Notifiable</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getJWTIdentifier</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getKey();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getJWTCustomClaims</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>
<p>6.é…ç½®é¡¹è¯¦è§£<br><code>config</code>ç›®å½•ä¸‹çš„<code>jwt.php</code>æ–‡ä»¶é…ç½®è¯¦è§£</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | JWT Authentication Secret</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | ç”¨äºåŠ å¯†ç”Ÿæˆ token çš„ secret</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;secret&#x27;</span> =&gt; env(<span class="string">&#x27;JWT_SECRET&#x27;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | JWT Authentication Keys</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | å¦‚æœä½ åœ¨ .env æ–‡ä»¶ä¸­å®šä¹‰äº† JWT_SECRET çš„éšæœºå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">    | é‚£ä¹ˆ jwt å°†ä¼šä½¿ç”¨ å¯¹ç§°ç®—æ³• æ¥ç”Ÿæˆ token</span></span><br><span class="line"><span class="comment">    | å¦‚æœä½ æ²¡æœ‰å®šæœ‰ï¼Œé‚£ä¹ˆjwt å°†ä¼šä½¿ç”¨å¦‚ä¸‹é…ç½®çš„å…¬é’¥å’Œç§é’¥æ¥ç”Ÿæˆ token</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;keys&#x27;</span> =&gt; [</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        | Public Key</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        | å…¬é’¥</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;public&#x27;</span> =&gt; env(<span class="string">&#x27;JWT_PUBLIC_KEY&#x27;</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        | Private Key</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        | ç§é’¥</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;private&#x27;</span> =&gt; env(<span class="string">&#x27;JWT_PRIVATE_KEY&#x27;</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        | Passphrase</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        | ç§é’¥çš„å¯†ç ã€‚ å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œå¯ä»¥ä¸º nullã€‚</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;passphrase&#x27;</span> =&gt; env(<span class="string">&#x27;JWT_PASSPHRASE&#x27;</span>),</span><br><span class="line"></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | JWT time to live</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | æŒ‡å®š access_token æœ‰æ•ˆçš„æ—¶é—´é•¿åº¦ï¼ˆä»¥åˆ†é’Ÿä¸ºå•ä½ï¼‰ï¼Œé»˜è®¤ä¸º1å°æ—¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥å°†å…¶è®¾ç½®ä¸ºç©ºï¼Œä»¥äº§ç”Ÿæ°¸ä¸è¿‡æœŸçš„æ ‡è®°</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;ttl&#x27;</span> =&gt; env(<span class="string">&#x27;JWT_TTL&#x27;</span>, <span class="number">60</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | Refresh time to live</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | æŒ‡å®š access_token å¯åˆ·æ–°çš„æ—¶é—´é•¿åº¦ï¼ˆä»¥åˆ†é’Ÿä¸ºå•ä½ï¼‰ã€‚é»˜è®¤çš„æ—¶é—´ä¸º 2 å‘¨ã€‚</span></span><br><span class="line"><span class="comment">    | å¤§æ¦‚æ„æ€å°±æ˜¯å¦‚æœç”¨æˆ·æœ‰ä¸€ä¸ª access_tokenï¼Œé‚£ä¹ˆä»–å¯ä»¥å¸¦ç€ä»–çš„ access_token </span></span><br><span class="line"><span class="comment">    | è¿‡æ¥é¢†å–æ–°çš„ access_tokenï¼Œç›´åˆ° 2 å‘¨çš„æ—¶é—´åï¼Œä»–ä¾¿æ— æ³•ç»§ç»­åˆ·æ–°äº†ï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;refresh_ttl&#x27;</span> =&gt; env(<span class="string">&#x27;JWT_REFRESH_TTL&#x27;</span>, <span class="number">20160</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | JWT hashing algorithm</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | æŒ‡å®šå°†ç”¨äºå¯¹ä»¤ç‰Œè¿›è¡Œç­¾åçš„æ•£åˆ—ç®—æ³•ã€‚</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;algo&#x27;</span> =&gt; env(<span class="string">&#x27;JWT_ALGO&#x27;</span>, <span class="string">&#x27;HS256&#x27;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | Required Claims</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | æŒ‡å®šå¿…é¡»å­˜åœ¨äºä»»ä½•ä»¤ç‰Œä¸­çš„å£°æ˜ã€‚</span></span><br><span class="line"><span class="comment">    | </span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;required_claims&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;iss&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;iat&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;exp&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;nbf&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sub&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;jti&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | Persistent Claims</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | æŒ‡å®šåœ¨åˆ·æ–°ä»¤ç‰Œæ—¶è¦ä¿ç•™çš„å£°æ˜å¯†é’¥ã€‚</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;persistent_claims&#x27;</span> =&gt; [</span><br><span class="line">        <span class="comment">// &#x27;foo&#x27;,</span></span><br><span class="line">        <span class="comment">// &#x27;bar&#x27;,</span></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | Blacklist Enabled</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | ä¸ºäº†ä½¿ä»¤ç‰Œæ— æ•ˆï¼Œæ‚¨å¿…é¡»å¯ç”¨é»‘åå•ã€‚</span></span><br><span class="line"><span class="comment">    | å¦‚æœæ‚¨ä¸æƒ³æˆ–ä¸éœ€è¦æ­¤åŠŸèƒ½ï¼Œè¯·å°†å…¶è®¾ç½®ä¸º falseã€‚</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;blacklist_enabled&#x27;</span> =&gt; env(<span class="string">&#x27;JWT_BLACKLIST_ENABLED&#x27;</span>, <span class="literal">true</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    | -------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | Blacklist Grace Period</span></span><br><span class="line"><span class="comment">    | -------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | å½“å¤šä¸ªå¹¶å‘è¯·æ±‚ä½¿ç”¨ç›¸åŒçš„JWTè¿›è¡Œæ—¶ï¼Œ</span></span><br><span class="line"><span class="comment">    | ç”±äº access_token çš„åˆ·æ–° ï¼Œå…¶ä¸­ä¸€äº›å¯èƒ½ä¼šå¤±è´¥</span></span><br><span class="line"><span class="comment">    | ä»¥ç§’ä¸ºå•ä½è®¾ç½®è¯·æ±‚æ—¶é—´ä»¥é˜²æ­¢å¹¶å‘çš„è¯·æ±‚å¤±è´¥ã€‚</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;blacklist_grace_period&#x27;</span> =&gt; env(<span class="string">&#x27;JWT_BLACKLIST_GRACE_PERIOD&#x27;</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | Providers</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | æŒ‡å®šæ•´ä¸ªåŒ…ä¸­ä½¿ç”¨çš„å„ç§æä¾›ç¨‹åºã€‚</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;providers&#x27;</span> =&gt; [</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        | JWT Provider</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        | æŒ‡å®šç”¨äºåˆ›å»ºå’Œè§£ç ä»¤ç‰Œçš„æä¾›ç¨‹åºã€‚</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;jwt&#x27;</span> =&gt; Tymon\JWTAuth\Providers\JWT\Namshi::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        | Authentication Provider</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        | æŒ‡å®šç”¨äºå¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯çš„æä¾›ç¨‹åºã€‚</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;auth&#x27;</span> =&gt; Tymon\JWTAuth\Providers\Auth\Illuminate::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        | Storage Provider</span></span><br><span class="line"><span class="comment">        |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        | æŒ‡å®šç”¨äºåœ¨é»‘åå•ä¸­å­˜å‚¨æ ‡è®°çš„æä¾›ç¨‹åºã€‚</span></span><br><span class="line"><span class="comment">        |</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;storage&#x27;</span> =&gt; Tymon\JWTAuth\Providers\Storage\Illuminate::class,</span><br><span class="line"></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="5-6-3-æµ‹è¯•"><a href="#5-6-3-æµ‹è¯•" class="headerlink" title="5.6.3. æµ‹è¯•"></a>5.6.3. æµ‹è¯•</h3><p>1.æˆ‘ä»¬åœ¨<code>UserController</code>æ§åˆ¶å™¨ä¸­å°†<code>login</code>æ–¹æ³•è¿›è¡Œä¿®æ”¹ä»¥åŠæ–°å¢ä¸€ä¸ª<code>logout</code>æ–¹æ³•ç”¨æ¥é€€å‡ºç™»å½•è¿˜æœ‰<code>info</code>æ–¹æ³•ç”¨æ¥è·å–å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ã€‚</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">Request <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$token</span>=Auth::guard(<span class="string">&#x27;api&#x27;</span>)-&gt;attempt([<span class="string">&#x27;name&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;name,<span class="string">&#x27;password&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;password]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$token</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(<span class="number">201</span>)-&gt;success([<span class="string">&#x27;token&#x27;</span> =&gt; <span class="string">&#x27;bearer &#x27;</span> . <span class="variable">$token</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="string">&#x27;è´¦å·æˆ–å¯†ç é”™è¯¯&#x27;</span>,<span class="number">400</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”¨æˆ·é€€å‡º</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Auth::guard(<span class="string">&#x27;api&#x27;</span>)-&gt;logout();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="string">&#x27;é€€å‡ºæˆåŠŸ...&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿”å›å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">info</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$user</span> = Auth::guard(<span class="string">&#x27;api&#x27;</span>)-&gt;user();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="keyword">new</span> UserResource(<span class="variable">$user</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.æ·»åŠ ä¸€ä¸‹è·¯ç”±<br><code>routes/api.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å½“å‰ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">Route::get(<span class="string">&#x27;/users/info&#x27;</span>,<span class="string">&#x27;UserController@info&#x27;</span>)-&gt;name(<span class="string">&#x27;users.info&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>3.æ¥ç€æˆ‘ä»¬æ‰“å¼€<code>postman</code>,è¯·æ±‚<code>http://ä½ çš„åŸŸå/api/v1/login</code>.å¯ä»¥çœ‹åˆ°æ¥å£è¿”å›çš„<code>token</code>.</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">201</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOlwvXC90ZXN0LmNvbVwvYXBpXC92MVwvbG9naW4iLCJpYXQiOjE1NTEzMzUyNzgsImV4cCI6MTU1MTMzODg3OCwibmJmIjoxNTUxMzM1Mjc4LCJqdGkiOiJrUzZSWHRoQVBkczR6ck4wIiwic3ViIjoxLCJwcnYiOiIyM2JkNWM4OTQ5ZjYwMGFkYjM5ZTcwMWM0MDA4NzJkYjdhNTk3NmY3In0.FLk-JPFBDTWcItPRN8SVGaLI0j2zgiWLLs_MNKxCafQ&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>4.æ­¤æ—¶ï¼Œæˆ‘ä»¬æ‰“å¼€<code>Postman</code>ç›´æ¥è®¿é—®<code>http://ä½ çš„åŸŸå/api/v1/users/info</code>,ä½ ä¼šçœ‹åˆ°æŠ¥äº†å¦‚ä¸‹é”™è¯¯.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Trying to get property &#39;id&#39; of non-object</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯æˆ‘ä»¬æ²¡æœ‰æºå¸¦tokenå¯¼è‡´çš„ã€‚æŠ¥é”™ä¸å‹å¥½æˆ‘ä»¬å°†åœ¨ä¸‹é¢<code>è‡ªåŠ¨åˆ·æ–°ç”¨æˆ·è®¤è¯</code>è§£å†³ã€‚</p>
<p>5.æˆ‘ä»¬åœ¨<code>Postman</code>çš„<code>Header</code>å¤´éƒ¨åˆ†å†åŠ ä¸€ä¸ª<code>key</code>ä¸º<code>Authorization</code>ï¼Œ<code>value</code>ä¸ºç™»é™†æˆåŠŸåè¿”å›çš„<code>token</code>å€¼ï¼Œç„¶åå†æ¬¡è¿›è¡Œè¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°æˆåŠŸè¿”å›å½“å‰ç™»é™†ç”¨æˆ·çš„ä¿¡æ¯ã€‚<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/jnYnXGv60I.png!large" alt="file"></p>
<h2 id="5-7-è‡ªåŠ¨åˆ·æ–°ç”¨æˆ·è®¤è¯"><a href="#5-7-è‡ªåŠ¨åˆ·æ–°ç”¨æˆ·è®¤è¯" class="headerlink" title="5.7. è‡ªåŠ¨åˆ·æ–°ç”¨æˆ·è®¤è¯"></a>5.7. è‡ªåŠ¨åˆ·æ–°ç”¨æˆ·è®¤è¯</h2><h3 id="5-7-1-éœ€æ±‚"><a href="#5-7-1-éœ€æ±‚" class="headerlink" title="5.7.1. éœ€æ±‚"></a>5.7.1. éœ€æ±‚</h3><p>ç°åœ¨æˆ‘æƒ³ç”¨æˆ·ç™»å½•åï¼Œä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼Œæ¯ä¸ªå°æ—¶è¯¥ç”¨æˆ·çš„tokenéƒ½ä¼šè‡ªåŠ¨åˆ·æ–°ä¸ºå…¨æ–°çš„ï¼Œç”¨æ—§çš„tokenè¯·æ±‚ä¸ä¼šé€šè¿‡ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç”¨æˆ·å¦‚æœtokenä¸å¯¹ï¼Œå°±ä¼šé€€åˆ°å½“å‰ç•Œé¢é‡æ–°ç™»å½•æ¥è·å¾—æ–°çš„tokenï¼Œæˆ‘åŒæ—¶å¸Œæœ›è™½ç„¶åˆ·æ–°äº†tokenï¼Œä½†æ˜¯èƒ½å¦ä¸è¦é‡æ–°ç™»å½•ï¼Œå°±ç®—é‡æ–°ç™»å½•ä¹Ÿæ˜¯ä¸€å‘¨ç”šè‡³ä¸€ä¸ªæœˆä¹‹åå‘¢ï¼Ÿç»™ç”¨æˆ·ä¸€ç§æ— æ„ŸçŸ¥çš„ä½“éªŒã€‚</p>
<p>çœ‹ç€æ„Ÿè§‰å¾ˆç¥å¥‡ï¼Œæˆ‘ä»¬ä¸€èµ·æ‰‹æ‘¸æ‰‹æ¥å®ç°ã€‚</p>
<h3 id="5-7-2-è‡ªå®šä¹‰è®¤è¯ä¸­é—´ä»¶"><a href="#5-7-2-è‡ªå®šä¹‰è®¤è¯ä¸­é—´ä»¶" class="headerlink" title="5.7.2. è‡ªå®šä¹‰è®¤è¯ä¸­é—´ä»¶"></a>5.7.2. è‡ªå®šä¹‰è®¤è¯ä¸­é—´ä»¶</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan make:middleware Api&#x2F;RefreshTokenMiddleware</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€ <code>app/Http/Middleware/Api</code> ç›®å½•ä¸‹çš„ <code>RefreshTokenMiddleware.php</code> æ–‡ä»¶ï¼Œå¡«å†™ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">JWTException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Facades</span>\<span class="title">JWTAuth</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">BaseMiddleware</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">TokenExpiredException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Exception</span>\<span class="title">UnauthorizedHttpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œæˆ‘ä»¬è¦ç»§æ‰¿çš„æ˜¯ jwt çš„ BaseMiddleware</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefreshTokenMiddleware</span> <span class="keyword">extends</span> <span class="title">BaseMiddleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure $next</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ­¤æ¬¡è¯·æ±‚ä¸­æ˜¯å¦å¸¦æœ‰ tokenï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkForToken(<span class="variable">$request</span>);</span><br><span class="line"><span class="comment">//         ä½¿ç”¨ try åŒ…è£¹ï¼Œä»¥æ•æ‰ token è¿‡æœŸæ‰€æŠ›å‡ºçš„ TokenExpiredException  å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ£€æµ‹ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæ­£å¸¸åˆ™é€šè¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;auth-&gt;parseToken()-&gt;authenticate()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedHttpException(<span class="string">&#x27;jwt-auth&#x27;</span>, <span class="string">&#x27;æœªç™»å½•&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TokenExpiredException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="comment">// æ­¤å¤„æ•è·åˆ°äº† token è¿‡æœŸæ‰€æŠ›å‡ºçš„ TokenExpiredException å¼‚å¸¸ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦åšçš„æ˜¯åˆ·æ–°è¯¥ç”¨æˆ·çš„ token å¹¶å°†å®ƒæ·»åŠ åˆ°å“åº”å¤´ä¸­</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ·æ–°ç”¨æˆ·çš„ token</span></span><br><span class="line">                <span class="variable">$token</span> = <span class="keyword">$this</span>-&gt;auth-&gt;refresh();</span><br><span class="line">                <span class="comment">// ä½¿ç”¨ä¸€æ¬¡æ€§ç™»å½•ä»¥ä¿è¯æ­¤æ¬¡è¯·æ±‚çš„æˆåŠŸ</span></span><br><span class="line">                Auth::guard(<span class="string">&#x27;api&#x27;</span>)-&gt;onceUsingId(<span class="keyword">$this</span>-&gt;auth-&gt;manager()-&gt;getPayloadFactory()-&gt;buildClaimsCollection()-&gt;toPlainArray()[<span class="string">&#x27;sub&#x27;</span>]);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JWTException <span class="variable">$exception</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ•è·åˆ°æ­¤å¼‚å¸¸ï¼Œå³ä»£è¡¨ refresh ä¹Ÿè¿‡æœŸäº†ï¼Œç”¨æˆ·æ— æ³•åˆ·æ–°ä»¤ç‰Œï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedHttpException(<span class="string">&#x27;jwt-auth&#x27;</span>, <span class="variable">$exception</span>-&gt;getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨å“åº”å¤´ä¸­è¿”å›æ–°çš„ token</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setAuthenticationHeader(<span class="variable">$next</span>(<span class="variable">$request</span>), <span class="variable">$token</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-7-3-å¢åŠ ä¸­é—´ä»¶åˆ«å"><a href="#5-7-3-å¢åŠ ä¸­é—´ä»¶åˆ«å" class="headerlink" title="5.7.3. å¢åŠ ä¸­é—´ä»¶åˆ«å"></a>5.7.3. å¢åŠ ä¸­é—´ä»¶åˆ«å</h3><p>æ‰“å¼€ <code>app/Http</code> ç›®å½•ä¸‹çš„ <code>Kernel.php</code> æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä¸€è¡Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$routeMiddleware</span> = [</span><br><span class="line">    ......</span><br><span class="line">    <span class="string">&#x27;api.refresh&#x27;</span>=&gt;\App\Http\Middleware\Api\RefreshTokenMiddleware::class,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="5-7-4-è·¯ç”±å™¨ä¿®æ”¹"><a href="#5-7-4-è·¯ç”±å™¨ä¿®æ”¹" class="headerlink" title="5.7.4. è·¯ç”±å™¨ä¿®æ”¹"></a>5.7.4. è·¯ç”±å™¨ä¿®æ”¹</h3><p>æ¥ç€æˆ‘ä»¬å°†è·¯ç”±è¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ ä¸Šæˆ‘ä»¬å†™å¥½çš„ä¸­é—´ä»¶ã€‚<br><code>routes/api.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line">Route::namespace(<span class="string">&#x27;Api&#x27;</span>)-&gt;prefix(<span class="string">&#x27;v1&#x27;</span>)-&gt;middleware(<span class="string">&#x27;cors&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//ç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line">        Route::post(<span class="string">&#x27;/users&#x27;</span>,<span class="string">&#x27;UserController@store&#x27;</span>)-&gt;name(<span class="string">&#x27;users.store&#x27;</span>);</span><br><span class="line">        <span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line">        Route::post(<span class="string">&#x27;/login&#x27;</span>,<span class="string">&#x27;UserController@login&#x27;</span>)-&gt;name(<span class="string">&#x27;users.login&#x27;</span>);</span><br><span class="line">        Route::middleware(<span class="string">&#x27;api.refresh&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">//å½“å‰ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">            Route::get(<span class="string">&#x27;/users/info&#x27;</span>,<span class="string">&#x27;UserController@info&#x27;</span>)-&gt;name(<span class="string">&#x27;users.info&#x27;</span>);</span><br><span class="line">            <span class="comment">//ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line">            Route::get(<span class="string">&#x27;/users&#x27;</span>,<span class="string">&#x27;UserController@index&#x27;</span>)-&gt;name(<span class="string">&#x27;users.index&#x27;</span>);</span><br><span class="line">            <span class="comment">//ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">            Route::get(<span class="string">&#x27;/users/&#123;user&#125;&#x27;</span>,<span class="string">&#x27;UserController@show&#x27;</span>)-&gt;name(<span class="string">&#x27;users.show&#x27;</span>);</span><br><span class="line">            <span class="comment">//ç”¨æˆ·é€€å‡º</span></span><br><span class="line">            Route::get(<span class="string">&#x27;/logout&#x27;</span>,<span class="string">&#x27;UserController@logout&#x27;</span>)-&gt;name(<span class="string">&#x27;users.logout&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="5-7-5-æµ‹è¯•"><a href="#5-7-5-æµ‹è¯•" class="headerlink" title="5.7.5. æµ‹è¯•"></a>5.7.5. æµ‹è¯•</h3><p>1.æ­¤æ—¶æˆ‘ä»¬å†æ¬¡ä¸æºå¸¦tokenï¼Œä½¿ç”¨<code>Postman</code>ç›´æ¥è®¿é—®<code>http://ä½ çš„åŸŸå/api/v1/users/info</code>,è¿”å›å¦‚ä¸‹é”™è¯¯</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">422</span>,</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;æœªç™»å½•æˆ–ç™»å½•çŠ¶æ€å¤±æ•ˆ&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.é‚£éšä¾¿è¾“å…¥tokenåˆä¼šæ˜¯æ€ä¹ˆæ ·å‘¢ï¼Ÿæˆ‘ä»¬ä¹Ÿæ¥å°è¯•ä¸€ä¸‹</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">400</span>,</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;tokenä¸æ­£ç¡®&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.ç°åœ¨ï¼Œæˆ‘ä»¬å†åšä¸€ä¸ªå¦‚æœ<code>token</code>è¿‡æœŸäº†ï¼Œä½†æ˜¯åˆ·æ–°é™åˆ¶æ²¡æœ‰è¿‡æœŸçš„æƒ…å†µï¼Œçœ‹çœ‹ä¼šæœ‰ä»€ä¹ˆç»“æœã€‚æˆ‘ä»¬å…ˆå°†<code>config/jwt.php</code>é‡Œçš„<code>ttl</code>ä»<code>60</code>æ”¹æˆ<code>1</code>ã€‚æ„å‘³ç€é‡æ–°ç”Ÿæˆçš„tokenå°†ä¼š1åˆ†é’Ÿåè¿‡æœŸã€‚</p>
<p>ç„¶åæˆ‘ä»¬é‡æ–°ç™»å½•è·å–åˆ°<code>token</code>ï¼Œæ›¿æ¢<code>/api/v1/users/info</code>åŸæœ‰çš„tokenï¼Œè¿›è¡Œè®¿é—®ï¼Œå¯ä»¥æ­£å¸¸è¿”å›ç”¨æˆ·çš„ä¿¡æ¯ã€‚</p>
<p>ç­‰è¿‡äº†ä¸€åˆ†é’Ÿï¼Œæˆ‘ä»¬å†è¿›è¡Œè®¿é—®ï¼Œå‘ç°ä¾æ—§å¯ä»¥è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è¿”å›çš„<code>Headers</code>çš„<code>Authorization</code>å¯ä»¥çœ‹åˆ°æ–°çš„<code>token</code>ã€‚<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/rPx1FRAcbH.png!large" alt="file"><br>æ­¤æ—¶å¦‚æœæˆ‘ä»¬å†æ¬¡è®¿é—®ï¼Œåˆ™æŠ¥å‡ºå¼‚å¸¸</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">422</span>,</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;æœªç™»å½•æˆ–ç™»å½•çŠ¶æ€å¤±æ•ˆ&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ›¿æ¢ä¸Šæ–°çš„<code>token</code>ï¼Œå†æ¬¡è®¿é—®ï¼Œè®¿é—®æ­£å¸¸é€šè¿‡ã€‚</p>
<p>4.ç°åœ¨ï¼Œæˆ‘ä»¬æ¥ç€ç»§ç»­åš<code>token</code>å’Œåˆ·æ–°æ—¶é—´éƒ½è¿‡æœŸçš„æƒ…å†µï¼Œä¼šå‘ç”Ÿä»€ä¹ˆã€‚æˆ‘ä»¬å†å°†<code>config/jwt.php</code>é‡Œçš„<code>refresh_ttl</code>ä»<code>20160</code>æ”¹æˆ<code>2</code>ã€‚</p>
<p>é‡æ–°æŒ‰ç…§3æ­¥éª¤æ‰§è¡Œä¸€æ¬¡ï¼Œå½“åˆšè¿‡ä¸€åˆ†é’Ÿæ—¶ï¼Œè¿”å›ç»“æœä¸3ç›¸åŒï¼Œéƒ½æ˜¯æ­£å¸¸è¿”å›ä¿¡æ¯å¹¶ä¸”åœ¨<code>Headers</code>æºå¸¦äº†æ–°çš„tokenã€‚</p>
<p>å½“2åˆ†é’Ÿè¿‡åï¼ŒæŠ¥å¦‚ä¸‹é”™è¯¯ä¿¡æ¯ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">422</span>,</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;æœªç™»å½•æˆ–ç™»å½•çŠ¶æ€å¤±æ•ˆ&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5.ä¸ºäº†åé¢çš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†ä¿®æ”¹çš„<code>ttl</code>å’Œ<code>refresh_ttl</code>çš„æ—¶é—´å¤åŸã€‚</p>
<h3 id="5-7-6-å‰ç«¯é€»è¾‘"><a href="#5-7-6-å‰ç«¯é€»è¾‘" class="headerlink" title="5.7.6. å‰ç«¯é€»è¾‘"></a>5.7.6. å‰ç«¯é€»è¾‘</h3><p>ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå½“tokenè¿‡æœŸæˆ–è€…æ— æ•ˆä»¥åŠä¹±å†™ï¼Œè¿”å›çš„<code>HTTPçŠ¶æ€ç </code>éƒ½æ˜¯<code>422</code>ã€‚è¿™æ˜¯å› ä¸ºè¿™ä¸ªå¼‚å¸¸è¢«æˆ‘ä»¬ä¸Šé¢è‡ªå®šä¹‰å¼‚å¸¸æ•æ‰äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">UnauthorizedHttpException::class=&gt;[<span class="string">&#x27;æœªç™»å½•æˆ–ç™»å½•çŠ¶æ€å¤±æ•ˆ&#x27;</span>,<span class="number">422</span>],</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ï¼Œå¯ä»¥è·Ÿå‰ç«¯å°ä¼™ä¼´å•†é‡ä¸€ä¸ªçŠ¶æ€ç ï¼Œä¸“é—¨è¡¨ç¤ºæ¥æ”¶åˆ°è¿™ä¸ªçŠ¶æ€ç å°±è¦é€€å›é‡æ–°ç™»å½•äº†ã€‚å½“<code>Header</code>å¤´æºå¸¦<code>Authorization</code>æ—¶ï¼Œå°±è¦åŠæ—¶è‡ªåŠ¨æ›¿æ¢æ–°çš„tokenï¼Œä¸éœ€è¦å›åˆ°é‡æ–°ç™»å½•ç•Œé¢ã€‚è¿™æ ·ç”¨æˆ·å°±èƒ½å®Œå…¨æ— æ„ŸçŸ¥å•¦~</p>
<h2 id="5-8-å¤šè§’è‰²è®¤è¯"><a href="#5-8-å¤šè§’è‰²è®¤è¯" class="headerlink" title="5.8. å¤šè§’è‰²è®¤è¯"></a>5.8. å¤šè§’è‰²è®¤è¯</h2><p>å¦‚æœæˆ‘ä»¬çš„ç³»ç»Ÿä¸ä»…ä»…åªæœ‰ä¸€ç§è§’è‰²èº«ä»½ï¼Œè¿˜æœ‰å…¶ä»–çš„è§’è‰²èº«ä»½éœ€è¦è®¤è¯å‘¢ï¼Ÿç›®å‰æˆ‘ä»¬çš„è§’è‰²è®¤è¯æ˜¯è®¤è¯<code>Users</code>è¡¨çš„ï¼Œå¦‚æœæˆ‘ä»¬å†åŠ å…¥ä¸€ä¸ª<code>Admins</code>è¡¨ï¼Œä¹Ÿè¦è§’è‰²è®¤è¯è¦å¦‚ä½•æ“ä½œ?</p>
<h3 id="5-8-1-Adminç”¨æˆ·è¡¨"><a href="#5-8-1-Adminç”¨æˆ·è¡¨" class="headerlink" title="5.8.1. Adminç”¨æˆ·è¡¨"></a>5.8.1. Adminç”¨æˆ·è¡¨</h3><p>æˆ‘ä»¬å°†æ•°æ®åº“çš„<code>Users</code>è¡¨å¤åˆ¶ä¸€ä»½ï¼Œå°†å…¶å‘½åä¸º<code>Admins</code>è¡¨ï¼Œå¹¶ä¸”å°†å…¶ä¸­çš„ä¸€ä¸ªç”¨æˆ·åè¿›è¡Œä¿®æ”¹ï¼Œä»¥ç¤ºåŒºåˆ«ã€‚</p>
<h3 id="5-8-2-æ¡†æ¶æ–‡ä»¶"><a href="#5-8-2-æ¡†æ¶æ–‡ä»¶" class="headerlink" title="5.8.2. æ¡†æ¶æ–‡ä»¶"></a>5.8.2. æ¡†æ¶æ–‡ä»¶</h3><p>æˆ‘ä»¬åˆ†åˆ«å°†<code>User.php</code>æ¨¡å‹æ–‡ä»¶ï¼Œ<code>UserEnum.php</code>æšä¸¾æ–‡ä»¶,<code>UserResource.php</code>èµ„æºæ–‡ä»¶ï¼Œ<code>UserRequest.php</code>éªŒè¯å™¨æ–‡ä»¶<code>UserController.php</code>æ§åˆ¶å™¨æ–‡ä»¶å„å¤åˆ¶ä¸€ä»½ï¼Œæ›´æ”¹ä¸º<code>Admin</code>çš„ï¼Œå¹¶å°†å…¶ä¸­å†…å®¹ä¹Ÿæ”¹ä¸º<code>Admin</code>ç›¸å…³ã€‚å› ä¸ºå°±æ˜¯å¤åˆ¶ç²˜è´´ï¼ŒæŠŠ<code>user</code>æ”¹æˆ<code>admin</code>,ç”±äºç¯‡å¹…é—®é¢˜å…·ä½“ä¿®æ”¹è¿‡ç¨‹æˆ‘å°±ä¸æ”¾ä»£ç äº†ã€‚å…·ä½“çš„å¯ä»¥çœ‹ä¸‹é¢çš„<code>æˆå“</code></p>
<h3 id="5-8-3-ç”¨æˆ·è®¤è¯æ–‡ä»¶"><a href="#5-8-3-ç”¨æˆ·è®¤è¯æ–‡ä»¶" class="headerlink" title="5.8.3. ç”¨æˆ·è®¤è¯æ–‡ä»¶"></a>5.8.3. ç”¨æˆ·è®¤è¯æ–‡ä»¶</h3><p>æ‰“å¼€<code>config/auth.php</code>æ–‡ä»¶ï¼Œä¿®æ”¹å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;guards&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;web&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;session&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;provider&#x27;</span> =&gt; <span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;api&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;jwt&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;provider&#x27;</span> =&gt; <span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;admin&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;jwt&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;provider&#x27;</span> =&gt; <span class="string">&#x27;admins&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">],</span><br><span class="line"><span class="string">&#x27;providers&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;users&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;eloquent&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;model&#x27;</span> =&gt; App\Models\User::class,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;admins&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;eloquent&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;model&#x27;</span> =&gt; App\Models\Admin::class,</span><br><span class="line">        ],</span><br><span class="line">        <span class="comment">// &#x27;users&#x27; =&gt; [</span></span><br><span class="line">        <span class="comment">//     &#x27;driver&#x27; =&gt; &#x27;database&#x27;,</span></span><br><span class="line">        <span class="comment">//     &#x27;table&#x27; =&gt; &#x27;users&#x27;,</span></span><br><span class="line">        <span class="comment">// ],</span></span><br><span class="line">    ],</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œguardå®ˆæŠ¤å°±å¤šäº†ä¸€ä¸ª<code>admin</code>ï¼Œå½“<code>Auth::guard(&#39;admin&#39;)</code>æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨æŸ¥æ‰¾<code>Admin</code>æ¨¡å‹æ–‡ä»¶ï¼Œè¿™æ ·å°±èƒ½è·Ÿä¸Šé¢çš„<code>User</code>æ¨¡å‹è®¤è¯åˆ†å¼€äº†ã€‚</p>
<h3 id="5-8-4-åˆ·æ–°ç”¨æˆ·è®¤è¯ä¸­é—´ä»¶"><a href="#5-8-4-åˆ·æ–°ç”¨æˆ·è®¤è¯ä¸­é—´ä»¶" class="headerlink" title="5.8.4. åˆ·æ–°ç”¨æˆ·è®¤è¯ä¸­é—´ä»¶"></a>5.8.4. åˆ·æ–°ç”¨æˆ·è®¤è¯ä¸­é—´ä»¶</h3><p>æˆ‘ä»¬éœ€è¦å†å¤åˆ¶ä¸€ä¸ªåˆ·æ–°ç”¨æˆ·è®¤è¯çš„ä¸­é—´ä»¶ï¼Œä¸“é—¨ä¸º<code>admin</code>è®¤è¯ä»¥åŠåˆ·æ–°<code>token</code>.<br><code>app/Http/Middleware/Api/RefreshAdminTokenMiddleware.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">JWTException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Facades</span>\<span class="title">JWTAuth</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">BaseMiddleware</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">TokenExpiredException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Exception</span>\<span class="title">UnauthorizedHttpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œæˆ‘ä»¬è¦ç»§æ‰¿çš„æ˜¯ jwt çš„ BaseMiddleware</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefreshAdminTokenMiddleware</span> <span class="keyword">extends</span> <span class="title">BaseMiddleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure $next</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ­¤æ¬¡è¯·æ±‚ä¸­æ˜¯å¦å¸¦æœ‰ tokenï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkForToken(<span class="variable">$request</span>);</span><br><span class="line"><span class="comment">//         ä½¿ç”¨ try åŒ…è£¹ï¼Œä»¥æ•æ‰ token è¿‡æœŸæ‰€æŠ›å‡ºçš„ TokenExpiredException  å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ£€æµ‹ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæ­£å¸¸åˆ™é€šè¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;auth-&gt;parseToken()-&gt;authenticate()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedHttpException(<span class="string">&#x27;jwt-auth&#x27;</span>, <span class="string">&#x27;æœªç™»å½•&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TokenExpiredException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="comment">// æ­¤å¤„æ•è·åˆ°äº† token è¿‡æœŸæ‰€æŠ›å‡ºçš„ TokenExpiredException å¼‚å¸¸ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦åšçš„æ˜¯åˆ·æ–°è¯¥ç”¨æˆ·çš„ token å¹¶å°†å®ƒæ·»åŠ åˆ°å“åº”å¤´ä¸­</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ·æ–°ç”¨æˆ·çš„ token</span></span><br><span class="line">                <span class="variable">$token</span> = <span class="keyword">$this</span>-&gt;auth-&gt;refresh();</span><br><span class="line">                <span class="comment">// ä½¿ç”¨ä¸€æ¬¡æ€§ç™»å½•ä»¥ä¿è¯æ­¤æ¬¡è¯·æ±‚çš„æˆåŠŸ</span></span><br><span class="line">                Auth::guard(<span class="string">&#x27;admin&#x27;</span>)-&gt;onceUsingId(<span class="keyword">$this</span>-&gt;auth-&gt;manager()-&gt;getPayloadFactory()-&gt;buildClaimsCollection()-&gt;toPlainArray()[<span class="string">&#x27;sub&#x27;</span>]);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JWTException <span class="variable">$exception</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ•è·åˆ°æ­¤å¼‚å¸¸ï¼Œå³ä»£è¡¨ refresh ä¹Ÿè¿‡æœŸäº†ï¼Œç”¨æˆ·æ— æ³•åˆ·æ–°ä»¤ç‰Œï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedHttpException(<span class="string">&#x27;jwt-auth&#x27;</span>, <span class="variable">$exception</span>-&gt;getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨å“åº”å¤´ä¸­è¿”å›æ–°çš„ token</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setAuthenticationHeader(<span class="variable">$next</span>(<span class="variable">$request</span>), <span class="variable">$token</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-8-5-å¢åŠ ä¸­é—´ä»¶åˆ«å"><a href="#5-8-5-å¢åŠ ä¸­é—´ä»¶åˆ«å" class="headerlink" title="5.8.5. å¢åŠ ä¸­é—´ä»¶åˆ«å"></a>5.8.5. å¢åŠ ä¸­é—´ä»¶åˆ«å</h3><p>æ‰“å¼€ app/Http ç›®å½•ä¸‹çš„ Kernel.php æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä¸€è¡Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$routeMiddleware</span> = [</span><br><span class="line">    ......</span><br><span class="line">    <span class="string">&#x27;admin.refresh&#x27;</span>=&gt;\App\Http\Middleware\Api\RefreshAdminTokenMiddleware::class,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="5-8-6-è·¯ç”±æ–‡ä»¶"><a href="#5-8-6-è·¯ç”±æ–‡ä»¶" class="headerlink" title="5.8.6. è·¯ç”±æ–‡ä»¶"></a>5.8.6. è·¯ç”±æ–‡ä»¶</h3><p>routes/api.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line">Route::namespace(<span class="string">&#x27;Api&#x27;</span>)-&gt;prefix(<span class="string">&#x27;v1&#x27;</span>)-&gt;middleware(<span class="string">&#x27;cors&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//ç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line">    Route::post(<span class="string">&#x27;/users&#x27;</span>, <span class="string">&#x27;UserController@store&#x27;</span>)-&gt;name(<span class="string">&#x27;users.store&#x27;</span>);</span><br><span class="line">    <span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line">    Route::post(<span class="string">&#x27;/login&#x27;</span>, <span class="string">&#x27;UserController@login&#x27;</span>)-&gt;name(<span class="string">&#x27;users.login&#x27;</span>);</span><br><span class="line">    Route::middleware(<span class="string">&#x27;api.refresh&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//å½“å‰ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        Route::get(<span class="string">&#x27;/users/info&#x27;</span>, <span class="string">&#x27;UserController@info&#x27;</span>)-&gt;name(<span class="string">&#x27;users.info&#x27;</span>);</span><br><span class="line">        <span class="comment">//ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line">        Route::get(<span class="string">&#x27;/users&#x27;</span>, <span class="string">&#x27;UserController@index&#x27;</span>)-&gt;name(<span class="string">&#x27;users.index&#x27;</span>);</span><br><span class="line">        <span class="comment">//ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        Route::get(<span class="string">&#x27;/users/&#123;user&#125;&#x27;</span>, <span class="string">&#x27;UserController@show&#x27;</span>)-&gt;name(<span class="string">&#x27;users.show&#x27;</span>);</span><br><span class="line">        <span class="comment">//ç”¨æˆ·é€€å‡º</span></span><br><span class="line">        Route::get(<span class="string">&#x27;/logout&#x27;</span>, <span class="string">&#x27;UserController@logout&#x27;</span>)-&gt;name(<span class="string">&#x27;users.logout&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç®¡ç†å‘˜æ³¨å†Œ</span></span><br><span class="line">    Route::post(<span class="string">&#x27;/admins&#x27;</span>, <span class="string">&#x27;AdminController@store&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.store&#x27;</span>);</span><br><span class="line">    <span class="comment">//ç®¡ç†å‘˜ç™»å½•</span></span><br><span class="line">    Route::post(<span class="string">&#x27;/admin/login&#x27;</span>, <span class="string">&#x27;AdminController@login&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.login&#x27;</span>);</span><br><span class="line">    Route::middleware(<span class="string">&#x27;admin.refresh&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//å½“å‰ç®¡ç†å‘˜ä¿¡æ¯</span></span><br><span class="line">        Route::get(<span class="string">&#x27;/admins/info&#x27;</span>, <span class="string">&#x27;AdminController@info&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.info&#x27;</span>);</span><br><span class="line">        <span class="comment">//ç®¡ç†å‘˜åˆ—è¡¨</span></span><br><span class="line">        Route::get(<span class="string">&#x27;/admins&#x27;</span>, <span class="string">&#x27;AdminController@index&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.index&#x27;</span>);</span><br><span class="line">        <span class="comment">//ç®¡ç†å‘˜ä¿¡æ¯</span></span><br><span class="line">        Route::get(<span class="string">&#x27;/admins/&#123;user&#125;&#x27;</span>, <span class="string">&#x27;AdminController@show&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.show&#x27;</span>);</span><br><span class="line">        <span class="comment">//ç®¡ç†å‘˜é€€å‡º</span></span><br><span class="line">        Route::get(<span class="string">&#x27;/admins/logout&#x27;</span>, <span class="string">&#x27;AdminController@logout&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.logout&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="5-8-7-æ§åˆ¶å™¨æ–‡ä»¶"><a href="#5-8-7-æ§åˆ¶å™¨æ–‡ä»¶" class="headerlink" title="5.8.7. æ§åˆ¶å™¨æ–‡ä»¶"></a>5.8.7. æ§åˆ¶å™¨æ–‡ä»¶</h3><p><code>app/Http/Controllers/Api/AdminController.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">UserRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Resources</span>\<span class="title">Api</span>\<span class="title">AdminResource</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">Admin</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//3ä¸ªç”¨æˆ·ä¸ºä¸€é¡µ</span></span><br><span class="line">        <span class="variable">$admins</span> = Admin::paginate(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> AdminResource::collection(<span class="variable">$admins</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›å•ä¸€ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">Admin <span class="variable">$admin</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="keyword">new</span> AdminResource(<span class="variable">$admin</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">info</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Auth::guard(<span class="string">&#x27;admin&#x27;</span>)-&gt;user();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="keyword">new</span> AdminResource(<span class="variable">$admins</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">UserRequest <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">        Admin::create(<span class="variable">$request</span>-&gt;all());</span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(<span class="number">201</span>)-&gt;success(<span class="string">&#x27;ç”¨æˆ·æ³¨å†ŒæˆåŠŸ&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">Request <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$token</span>=Auth::guard(<span class="string">&#x27;admin&#x27;</span>)-&gt;attempt([<span class="string">&#x27;name&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;name,<span class="string">&#x27;password&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;password]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$token</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(<span class="number">201</span>)-&gt;success([<span class="string">&#x27;token&#x27;</span> =&gt; <span class="string">&#x27;bearer &#x27;</span> . <span class="variable">$token</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="string">&#x27;è´¦å·æˆ–å¯†ç é”™è¯¯&#x27;</span>,<span class="number">400</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”¨æˆ·é€€å‡º</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Auth::guard(<span class="string">&#x27;admin&#x27;</span>)-&gt;logout();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="string">&#x27;é€€å‡ºæˆåŠŸ...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-8-8-æµ‹è¯•"><a href="#5-8-8-æµ‹è¯•" class="headerlink" title="5.8.8. æµ‹è¯•"></a>5.8.8. æµ‹è¯•</h3><p>æˆ‘ä»¬å°†<code>admin</code>è¿™è¾¹ç™»é™†è¿”å›çš„tokenæ”¾åœ¨<code>admin</code>çš„è¯·æ±‚ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼Œçœ‹çœ‹ä¼šä¸ä¼šä¸²å·ã€‚ç»“æœè¿”å›</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;guaosi123&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;æ­£å¸¸&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;created_at&quot;</span>: <span class="string">&quot;2019-02-26 08:12:31&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;updated_at&quot;</span>: <span class="string">&quot;2019-02-26 08:12:31&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å†å°†tokenæ”¾åœ¨<code>user</code>çš„è¯·æ±‚ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼Œçœ‹çœ‹ä¼šä¸ä¼šä¸²å·ã€‚ç»“æœè¿”å›</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;guaosi123&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;æ­£å¸¸&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;created_at&quot;</span>: <span class="string">&quot;2019-02-26 08:12:31&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;updated_at&quot;</span>: <span class="string">&quot;2019-03-01 01:48:12&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹æ¥<code>jwt-auth</code>çœŸçš„ä¸²å·äº†ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬ä¸‹é¢å†å¼€ä¸€ä¸ªæ ‡é¢˜è¿›è¡Œè§£å†³ã€‚</p>
<h3 id="5-8-9-è‡ªåŠ¨åŒºåˆ†guard"><a href="#5-8-9-è‡ªåŠ¨åŒºåˆ†guard" class="headerlink" title="5.8.9. è‡ªåŠ¨åŒºåˆ†guard"></a>5.8.9. è‡ªåŠ¨åŒºåˆ†guard</h3><p>1.å½“æˆ‘ä»¬ç¼–å†™ç™»é™†ï¼Œé€€å‡ºï¼Œè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯çš„æ—¶å€™ï¼Œéƒ½éœ€è¦</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Auth::guard(<span class="string">&#x27;admin&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡åˆ¶å®š<code>guard</code>çš„å…·ä½“å®ˆæŠ¤æ˜¯å“ªä¸€ä¸ªã€‚å› ä¸ºæ¡†æ¶é»˜è®¤çš„<code>guard</code>é»˜è®¤å®ˆæŠ¤çš„æ˜¯<code>web</code>ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘å¸Œæœ›å¯ä»¥è®©<code>guard</code>è‡ªåŠ¨åŒ–ï¼Œå¦‚æœæˆ‘è¯·æ±‚çš„æ˜¯<code>users</code>çš„ï¼Œæˆ‘å°±å®ˆæŠ¤<code>api</code>ã€‚å¦‚æœæˆ‘è¯·æ±‚çš„æ˜¯<code>admins</code>çš„ï¼Œæˆ‘å°±å®ˆæŠ¤<code>admin</code>ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œå°±ä»¥<code>admins</code>çš„ä¸ºä¾‹ï¼Œ<code>users</code>çš„ä¿æŒä¸åŠ¨</p>
<p>2.æ–°å»ºä¸­é—´ä»¶</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan make:middleware Api&#x2F;AdminGuardMiddleware</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€<code>app/Http/Middleware/Api/AdminGuardMiddleware.php</code> æ–‡ä»¶ï¼Œå¡«å…¥ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">Api</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminGuardMiddleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure $next</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        config([<span class="string">&#x27;auth.defaults.guard&#x27;</span>=&gt;<span class="string">&#x27;admin&#x27;</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.æ·»åŠ ä¸­é—´ä»¶åˆ«å<br>æ‰“å¼€ <code>app/Http</code> ç›®å½•ä¸‹çš„ <code>Kernel.php</code> æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä¸€è¡Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$routeMiddleware</span> = [</span><br><span class="line">    ......</span><br><span class="line">    <span class="string">&#x27;admin.guard&#x27;</span>=&gt;\App\Http\Middleware\Api\AdminGuardMiddleware::class,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>4.ä¿®æ”¹è·¯ç”±<br>æ¥ç€æˆ‘ä»¬å°†è·¯ç”±è¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ ä¸Šæˆ‘ä»¬å†™å¥½çš„ä¸­é—´ä»¶ã€‚<br><code>routes/api.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Route::middleware(<span class="string">&#x27;admin.guard&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//ç®¡ç†å‘˜æ³¨å†Œ</span></span><br><span class="line">        Route::post(<span class="string">&#x27;/admins&#x27;</span>, <span class="string">&#x27;AdminController@store&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.store&#x27;</span>);</span><br><span class="line">        <span class="comment">//ç®¡ç†å‘˜ç™»å½•</span></span><br><span class="line">        Route::post(<span class="string">&#x27;/admin/login&#x27;</span>, <span class="string">&#x27;AdminController@login&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.login&#x27;</span>);</span><br><span class="line">        Route::middleware(<span class="string">&#x27;admin.refresh&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">//å½“å‰ç®¡ç†å‘˜ä¿¡æ¯</span></span><br><span class="line">            Route::get(<span class="string">&#x27;/admins/info&#x27;</span>, <span class="string">&#x27;AdminController@info&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.info&#x27;</span>);</span><br><span class="line">            <span class="comment">//ç®¡ç†å‘˜åˆ—è¡¨</span></span><br><span class="line">            Route::get(<span class="string">&#x27;/admins&#x27;</span>, <span class="string">&#x27;AdminController@index&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.index&#x27;</span>);</span><br><span class="line">            <span class="comment">//ç®¡ç†å‘˜ä¿¡æ¯</span></span><br><span class="line">            Route::get(<span class="string">&#x27;/admins/&#123;user&#125;&#x27;</span>, <span class="string">&#x27;AdminController@show&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.show&#x27;</span>);</span><br><span class="line">            <span class="comment">//ç®¡ç†å‘˜é€€å‡º</span></span><br><span class="line">            Route::get(<span class="string">&#x27;/admins/logout&#x27;</span>, <span class="string">&#x27;AdminController@logout&#x27;</span>)-&gt;name(<span class="string">&#x27;admins.logout&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>5.ä¿®æ”¹æ§åˆ¶å™¨<br><code>app/Http/Controllers/Api/AdminController.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è¿”å›å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">info</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$admins</span> = Auth::user();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(newAdminResource(<span class="variable">$admins</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">Request <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$token</span>=Auth::attempt([<span class="string">&#x27;name&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;name,<span class="string">&#x27;password&#x27;</span>=&gt;<span class="variable">$request</span>-&gt;password]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$token</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(<span class="number">201</span>)-&gt;success([<span class="string">&#x27;token&#x27;</span> =&gt; <span class="string">&#x27;bearer &#x27;</span> . <span class="variable">$token</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="string">&#x27;è´¦å·æˆ–å¯†ç é”™è¯¯&#x27;</span>,<span class="number">400</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”¨æˆ·é€€å‡º</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Auth::logout();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;success(<span class="string">&#x27;é€€å‡ºæˆåŠŸ...&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6.æµ‹è¯•ç»“æœ<br>å°†<code>admin</code>ç™»é™†åçš„tokenå†æ¬¡æºå¸¦è®¿é—®<code>/api/v1/admins/info</code>,ä¾æ—§å¯ä»¥æ­£å¸¸è¾“å‡ºå½“å‰ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<blockquote>
<p>userçš„è‡ªåŠ¨åŒºåˆ†è¯·è‡ªå·±å¡«å†™ï¼Œè¿™é‡Œå°±ä¸å†å•°å—¦ä¸€éäº†ã€‚</p>
</blockquote>
<h2 id="5-9-ä¿®å¤è§’è‰²è®¤è¯ä¸²å·é—®é¢˜"><a href="#5-9-ä¿®å¤è§’è‰²è®¤è¯ä¸²å·é—®é¢˜" class="headerlink" title="5.9. ä¿®å¤è§’è‰²è®¤è¯ä¸²å·é—®é¢˜"></a>5.9. ä¿®å¤è§’è‰²è®¤è¯ä¸²å·é—®é¢˜</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªé—®é¢˜ï¼Œ<code>jwt-auth</code>é¢å‘çš„<code>token</code>é‡Œé¢æ˜¯ä¸åŒ…å«<code>æ¨¡å‹é©±åŠ¨</code>çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡è¿™ä¸ªä»¤ç‰Œï¼Œæˆ‘ä»¬ä¸çŸ¥é“å®ƒåˆ°åº•æ˜¯å±äº<code>api</code>è¿˜æ˜¯å±äº<code>admin</code>çš„ã€‚</p>
<blockquote>
<p>æŠ˜è…¾äº†ä¸€æ™šä¸Šï¼Œç™¾åº¦äº†å¾ˆå¤šèµ„æ–™ï¼Œæƒ³æ‰¾æ‰¾æœ‰æ²¡æœ‰è§£å†³åŠæ³•ã€‚ç»“æœæ‰¾åˆ°çš„éƒ½æ˜¯æ²¡ä»€ä¹ˆä½œç”¨çš„ï¼Œæˆ–è€…æ˜¯è®©è‡ªåŠ¨åˆ·æ–°å¤±æ•ˆäº†ã€‚æœ€åè‡ªå·±è¿½æºç ï¼Œæ‰¾åˆ°äº†è¿™ç§æ¯”è¾ƒå®Œç¾çš„æ–¹å¼ã€‚</p>
</blockquote>
<h3 id="5-9-1-å‡½æ•°"><a href="#5-9-1-å‡½æ•°" class="headerlink" title="5.9.1. å‡½æ•°"></a>5.9.1. å‡½æ•°</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹å‡ ä¸ªæˆ‘ä»¬åœ¨ä¸­é—´ä»¶ä¸­ç”¨çš„å‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;checkForToken(<span class="variable">$request</span>)</span><br><span class="line"><span class="comment">//è¿™ä¸ªå‡½æ•°åªä¼šæ£€æµ‹æ˜¯å¦æºå¸¦tokenä»¥åŠtokenæ˜¯å¦èƒ½è¢«å½“å‰å¯†é’¥æ‰€è§£æ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;auth-&gt;parseToken()-&gt;authenticate()</span><br><span class="line"><span class="comment">//å°†ä½¿ç”¨tokenè¿›è¡Œç™»å½•ï¼Œå¦‚æœtokenè¿‡æœŸï¼Œåˆ™æŠ›å‡º TokenExpiredException å¼‚å¸¸</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;auth-&gt;refresh(); </span><br><span class="line"><span class="comment">//åˆ·æ–°å½“å‰token</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªæœ‰è¶£çš„å‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Auth::check();</span><br><span class="line"><span class="comment">//å¯ä»¥æ ¹æ®å½“å‰çš„`guard`æ¥åˆ¤æ–­è¿™ä¸ªtokenæ˜¯å¦å±äºè¿™ä¸ª guard ,ä¸æ˜¯åˆ™æŠ›å‡º TokenInvalidException å¼‚å¸¸</span></span><br><span class="line"><span class="comment">//ä½†æ˜¯ï¼Œå½“tokenè¿‡æœŸæ—¶ï¼Œæ— è®ºæ˜¯ä¸æ˜¯å±äºè¿™ä¸ª guard ï¼Œå®ƒä¹Ÿæ˜¯éƒ½æŠ›å‡º TokenInvalidException å¼‚å¸¸ã€‚è¿™å¯¼è‡´æˆ‘ä»¬æ— æ³•æ­£å¸¸åˆ¤æ–­å‡ºåˆ°åº•æ˜¯å±äºå“ªç§é—®é¢˜</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥ï¼Œæƒ³è¦ç”¨check()æ¥åˆ¤æ–­ï¼Œæ˜¯ä¸å¯èƒ½çš„ã€‚</span></span><br></pre></td></tr></table></figure>
<p>æ¥ç€ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸ªæœ‰æ„æ€çš„å‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Auth::payload();</span><br><span class="line"><span class="comment">//å¯ä»¥è¾“å‡ºå½“å‰tokençš„è½½è·ä¿¡æ¯(ä¹Ÿå°±æ˜¯tokenè§£æåçš„å†…å®¹)</span></span><br><span class="line"><span class="comment">//ä½†æ˜¯ï¼Œå¦‚æœä½ è¿™ä¸ªtokenå·²ç»è¿‡æœŸäº†ï¼Œé‚£è¿™ä¸ªå‡½æ•°å°†ä¼šæŠ¥é”™</span></span><br></pre></td></tr></table></figure>
<h3 id="5-9-2-åŸç†"><a href="#5-9-2-åŸç†" class="headerlink" title="5.9.2. åŸç†"></a>5.9.2. åŸç†</h3><p>æˆ‘ä»¬é€šè¿‡<code>Auth::payload()</code>å¯ä»¥çœ‹åˆ°æœªè¿‡æœŸtokençš„è½½è·ä¿¡æ¯</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sub&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;iss&quot;</span>: <span class="string">&quot;http://test.com/api/v1/admin/login&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;iat&quot;</span>: <span class="number">1551407332</span>,</span><br><span class="line">  <span class="attr">&quot;exp&quot;</span>: <span class="number">1551407392</span>,</span><br><span class="line">  <span class="attr">&quot;nbf&quot;</span>: <span class="number">1551407332</span>,</span><br><span class="line">  <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;f9zwcMHaXBr5kQYp&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;prv&quot;</span>: <span class="string">&quot;df883db97bd05ef8ff85082d686c45e832e593a9&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å…¶å®æ˜¯å¯ä»¥æ‹¿åˆ°è¿™äº›è·è½½ä¿¡æ¯çš„ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åŠ å…¥è‡ªå·±çš„ä¿¡æ¯ï¼Œè¿™æ ·åœ¨ä¸­é—´ä»¶æ—¶å€™è¿›è¡Œè§£æï¼Œæ‹¿åˆ°æˆ‘ä»¬çš„è´Ÿè½½ï¼Œå°±å¯ä»¥è¿›è¡Œåˆ¤æ–­æ˜¯å¦æ˜¯å±äºå½“å‰<code>guard</code>çš„tokenäº†ã€‚</p>
<h3 id="5-9-3-å®ç°"><a href="#5-9-3-å®ç°" class="headerlink" title="5.9.3. å®ç°"></a>5.9.3. å®ç°</h3><p>ä¿®æ”¹ <code>app\Http\Controllers\Api\AdminController.php</code> ä¸­çš„ <code>login</code>æ–¹æ³•ï¼Œåœ¨<code>token</code>ä¸­åŠ å…¥æˆ‘ä»¬å®šä¹‰çš„å­—æ®µã€‚</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰å®ˆæŠ¤çš„åç§°</span></span><br><span class="line">    <span class="variable">$present_guard</span> =Auth::getDefaultDriver();</span><br><span class="line">    <span class="variable">$token</span> = Auth::claims([<span class="string">&#x27;guard&#x27;</span>=&gt;<span class="variable">$present_guard</span>])-&gt;attempt([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$request</span>-&gt;name, <span class="string">&#x27;password&#x27;</span> =&gt; <span class="variable">$request</span>-&gt;password]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$token</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(<span class="number">201</span>)-&gt;success([<span class="string">&#x27;token&#x27;</span> =&gt; <span class="string">&#x27;bearer &#x27;</span> . <span class="variable">$token</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="string">&#x27;è´¦å·æˆ–å¯†ç é”™è¯¯&#x27;</span>, <span class="number">400</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†ä¿®æ”¹ä¸­é—´ä»¶<code>app/Http/Middleware/Api/RefreshAdminTokenMiddleware.php</code> ï¼Œè®©å…¶å°±ç®—è¿‡æœŸ<code>token</code>ä¹Ÿèƒ½è¯»å–å‡ºé‡Œé¢çš„ä¿¡æ¯</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Exception</span>\<span class="title">UnauthorizedHttpException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">JWTException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">TokenExpiredException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">TokenInvalidException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">BaseMiddleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œæˆ‘ä»¬è¦ç»§æ‰¿çš„æ˜¯ jwt çš„ BaseMiddleware</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefreshAdminTokenMiddleware</span> <span class="keyword">extends</span> <span class="title">BaseMiddleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure $next</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> TokenInvalidException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ­¤æ¬¡è¯·æ±‚ä¸­æ˜¯å¦å¸¦æœ‰ tokenï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkForToken(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. æ ¼å¼é€šè¿‡ï¼ŒéªŒè¯æ˜¯å¦æ˜¯ä¸“å±äºè¿™ä¸ªçš„token</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–å½“å‰å®ˆæŠ¤çš„åç§°</span></span><br><span class="line">        <span class="variable">$present_guard</span> = Auth::getDefaultDriver();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–å½“å‰token</span></span><br><span class="line">        <span class="variable">$token</span>=Auth::getToken();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å³ä½¿è¿‡æœŸäº†ï¼Œä¹Ÿèƒ½è·å–åˆ°tokené‡Œçš„ è½½è· ä¿¡æ¯ã€‚</span></span><br><span class="line">        <span class="variable">$payload</span> = Auth::manager()-&gt;getJWTProvider()-&gt;decode(<span class="variable">$token</span>-&gt;get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœä¸åŒ…å«guardå­—æ®µæˆ–è€…guardæ‰€å¯¹åº”çš„å€¼ä¸å½“å‰çš„guardå®ˆæŠ¤å€¼ä¸ç›¸åŒ</span></span><br><span class="line">        <span class="comment">//è¯æ˜æ˜¯ä¸å±äºå½“å‰guardå®ˆæŠ¤çš„token</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$payload</span>[<span class="string">&#x27;guard&#x27;</span>])||<span class="variable">$payload</span>[<span class="string">&#x27;guard&#x27;</span>]!=<span class="variable">$present_guard</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TokenInvalidException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨ try åŒ…è£¹ï¼Œä»¥æ•æ‰ token è¿‡æœŸæ‰€æŠ›å‡ºçš„ TokenExpiredException  å¼‚å¸¸</span></span><br><span class="line">        <span class="comment">//2. æ­¤æ—¶è¿›å…¥çš„éƒ½æ˜¯å±äºå½“å‰guardå®ˆæŠ¤çš„token</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ£€æµ‹ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæ­£å¸¸åˆ™é€šè¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;auth-&gt;parseToken()-&gt;authenticate()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedHttpException(<span class="string">&#x27;jwt-auth&#x27;</span>, <span class="string">&#x27;æœªç™»å½•&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TokenExpiredException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="comment">// 3. æ­¤å¤„æ•è·åˆ°äº† token è¿‡æœŸæ‰€æŠ›å‡ºçš„ TokenExpiredException å¼‚å¸¸ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦åšçš„æ˜¯åˆ·æ–°è¯¥ç”¨æˆ·çš„ token å¹¶å°†å®ƒæ·»åŠ åˆ°å“åº”å¤´ä¸­</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ·æ–°ç”¨æˆ·çš„ token</span></span><br><span class="line">                <span class="variable">$token</span> = <span class="keyword">$this</span>-&gt;auth-&gt;refresh();</span><br><span class="line">                <span class="comment">// ä½¿ç”¨ä¸€æ¬¡æ€§ç™»å½•ä»¥ä¿è¯æ­¤æ¬¡è¯·æ±‚çš„æˆåŠŸ</span></span><br><span class="line">                Auth::onceUsingId(<span class="keyword">$this</span>-&gt;auth-&gt;manager()-&gt;getPayloadFactory()-&gt;buildClaimsCollection()-&gt;toPlainArray()[<span class="string">&#x27;sub&#x27;</span>]);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JWTException <span class="variable">$exception</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ•è·åˆ°æ­¤å¼‚å¸¸ï¼Œå³ä»£è¡¨ refresh ä¹Ÿè¿‡æœŸäº†ï¼Œç”¨æˆ·æ— æ³•åˆ·æ–°ä»¤ç‰Œï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedHttpException(<span class="string">&#x27;jwt-auth&#x27;</span>, <span class="variable">$exception</span>-&gt;getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨å“åº”å¤´ä¸­è¿”å›æ–°çš„ token</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setAuthenticationHeader(<span class="variable">$next</span>(<span class="variable">$request</span>), <span class="variable">$token</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™ä¸ªä¸­é—´ä»¶æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥ç›´æ¥æ›¿æ¢Userçš„åˆ·æ–°ç”¨æˆ·è®¤è¯ä¸­é—´ä»¶å™¢</p>
</blockquote>
<h3 id="5-9-4-æµ‹è¯•"><a href="#5-9-4-æµ‹è¯•" class="headerlink" title="5.9.4. æµ‹è¯•"></a>5.9.4. æµ‹è¯•</h3><p>æ­¤æ—¶å†æ¬¡è¿›è¡Œæµ‹è¯•æ˜¯å¦ä¸²å·ï¼Œæœ€åç»“æœå¯ä»¥æˆåŠŸé˜»æ­¢ä¹‹å‰çš„ä¸²å·é—®é¢˜ï¼Œæš‚æœªå‘ç°å…¶ä»–BUGã€‚</p>
<blockquote>
<p>userçš„ä¿®å¤ä¸²å·é—®é¢˜è¯·è‡ªå·±ä¿®æ”¹ï¼Œè¿™é‡Œå°±ä¸å†å•°å—¦ä¸€éäº†ã€‚</p>
</blockquote>
<h2 id="5-10-å•ä¸€è®¾å¤‡ç™»é™†"><a href="#5-10-å•ä¸€è®¾å¤‡ç™»é™†" class="headerlink" title="5.10. å•ä¸€è®¾å¤‡ç™»é™†"></a>5.10. å•ä¸€è®¾å¤‡ç™»é™†</h2><h3 id="5-10-1-æå‡ºéœ€æ±‚"><a href="#5-10-1-æå‡ºéœ€æ±‚" class="headerlink" title="5.10.1. æå‡ºéœ€æ±‚"></a>5.10.1. æå‡ºéœ€æ±‚</h3><p>åŒä¸€æ—¶é—´åªå…è®¸ç™»å½•å”¯ä¸€ä¸€å°è®¾å¤‡ã€‚ä¾‹å¦‚è®¾å¤‡ A ä¸­ç”¨æˆ·å¦‚æœå·²ç»ç™»å½•ï¼Œé‚£ä¹ˆä½¿ç”¨è®¾å¤‡ B ç™»å½•åŒä¸€è´¦æˆ·ï¼Œè®¾å¤‡ A å°±æ— æ³•ç»§ç»­ä½¿ç”¨äº†ã€‚</p>
<h3 id="5-10-2-åŸç†"><a href="#5-10-2-åŸç†" class="headerlink" title="5.10.2. åŸç†"></a>5.10.2. åŸç†</h3><p>æˆ‘ä»¬åœ¨ç™»é™†ï¼Œ<code>token</code>è¿‡æœŸè‡ªåŠ¨æ›´æ¢çš„æ—¶å€™ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„<code>token</code>ã€‚</p>
<p>æˆ‘ä»¬å°†<code>token</code>éƒ½å­˜åˆ°è¡¨ä¸­çš„<code>last_token</code>å­—æ®µã€‚åœ¨ç™»é™†æ¥å£ï¼Œè·å–åˆ°<code>last_token</code>é‡Œçš„å€¼ï¼Œå°†å…¶åŠ å…¥é»‘åå•ã€‚</p>
<p>è¿™æ ·ï¼Œåªè¦æˆ‘ä»¬æ— è®ºåœ¨å“ªé‡Œç™»é™†ï¼Œä¹‹å‰çš„<code>token</code>ä¸€å®šä¼šè¢«æ‹‰é»‘å¤±æ•ˆï¼Œå¿…é¡»é‡æ–°ç™»é™†ï¼Œæˆ‘ä»¬çš„ç›®çš„ä¹Ÿå°±è¾¾åˆ°äº†ã€‚</p>
<h3 id="5-10-3-å®ç°"><a href="#5-10-3-å®ç°" class="headerlink" title="5.10.3. å®ç°"></a>5.10.3. å®ç°</h3><p>ä¿®æ”¹ <code>app\Http\Controllers\Api\AdminController.php</code> ä¸­çš„ <code>login</code>æ–¹æ³•ï¼Œåœ¨ç™»é™†çš„æ—¶å€™ï¼Œæ‹‰é»‘ä¸Šä¸€ä¸ª<code>token</code>ã€‚</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç”¨æˆ·ç™»å½•</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰å®ˆæŠ¤çš„åç§°</span></span><br><span class="line">    <span class="variable">$present_guard</span> =Auth::getDefaultDriver();</span><br><span class="line">    <span class="variable">$token</span> = Auth::claims([<span class="string">&#x27;guard&#x27;</span>=&gt;<span class="variable">$present_guard</span>])-&gt;attempt([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$request</span>-&gt;name, <span class="string">&#x27;password&#x27;</span> =&gt; <span class="variable">$request</span>-&gt;password]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$token</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœç™»é™†ï¼Œå…ˆæ£€æŸ¥åŸå…ˆæ˜¯å¦æœ‰å­˜tokenï¼Œæœ‰çš„è¯å…ˆå¤±æ•ˆï¼Œç„¶åå†å­˜å…¥æœ€æ–°çš„token</span></span><br><span class="line">        <span class="variable">$user</span> = Auth::user();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$user</span>-&gt;last_token) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                Auth::setToken(<span class="variable">$user</span>-&gt;last_token)-&gt;invalidate();</span><br><span class="line">            &#125;<span class="keyword">catch</span> (TokenExpiredException <span class="variable">$e</span>)&#123;</span><br><span class="line">                <span class="comment">//å› ä¸ºè®©ä¸€ä¸ªè¿‡æœŸçš„tokenå†å¤±æ•ˆï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬æ•æ‰å¼‚å¸¸ï¼Œä¸éœ€è¦åšä»»ä½•å¤„ç†</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$user</span>-&gt;last_token = <span class="variable">$token</span>;</span><br><span class="line">        <span class="variable">$user</span>-&gt;save();        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setStatusCode(<span class="number">201</span>)-&gt;success([<span class="string">&#x27;token&#x27;</span> =&gt; <span class="string">&#x27;bearer &#x27;</span> . <span class="variable">$token</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;failed(<span class="string">&#x27;è´¦å·æˆ–å¯†ç é”™è¯¯&#x27;</span>, <span class="number">400</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†ä¿®æ”¹ä¸­é—´ä»¶<code>app/Http/Middleware/Api/RefreshAdminTokenMiddleware.php</code> ï¼Œæ›´æ–°çš„<code>token</code>åŠ åˆ°<code>last_token</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Exception</span>\<span class="title">UnauthorizedHttpException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">JWTException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">TokenExpiredException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Exceptions</span>\<span class="title">TokenInvalidException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">BaseMiddleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œæˆ‘ä»¬è¦ç»§æ‰¿çš„æ˜¯ jwt çš„ BaseMiddleware</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefreshAdminTokenMiddleware</span> <span class="keyword">extends</span> <span class="title">BaseMiddleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure $next</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> TokenInvalidException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ­¤æ¬¡è¯·æ±‚ä¸­æ˜¯å¦å¸¦æœ‰ tokenï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkForToken(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. æ ¼å¼é€šè¿‡ï¼ŒéªŒè¯æ˜¯å¦æ˜¯ä¸“å±äºè¿™ä¸ªçš„token</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–å½“å‰å®ˆæŠ¤çš„åç§°</span></span><br><span class="line">        <span class="variable">$present_guard</span> = Auth::getDefaultDriver();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–å½“å‰token</span></span><br><span class="line">        <span class="variable">$token</span>=Auth::getToken();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å³ä½¿è¿‡æœŸäº†ï¼Œä¹Ÿèƒ½è·å–åˆ°tokené‡Œçš„ è½½è· ä¿¡æ¯ã€‚</span></span><br><span class="line">        <span class="variable">$payload</span> = Auth::manager()-&gt;getJWTProvider()-&gt;decode(<span class="variable">$token</span>-&gt;get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœä¸åŒ…å«guardå­—æ®µæˆ–è€…guardæ‰€å¯¹åº”çš„å€¼ä¸å½“å‰çš„guardå®ˆæŠ¤å€¼ä¸ç›¸åŒ</span></span><br><span class="line">        <span class="comment">//è¯æ˜æ˜¯ä¸å±äºå½“å‰guardå®ˆæŠ¤çš„token</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$payload</span>[<span class="string">&#x27;guard&#x27;</span>])||<span class="variable">$payload</span>[<span class="string">&#x27;guard&#x27;</span>]!=<span class="variable">$present_guard</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TokenInvalidException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨ try åŒ…è£¹ï¼Œä»¥æ•æ‰ token è¿‡æœŸæ‰€æŠ›å‡ºçš„ TokenExpiredException  å¼‚å¸¸</span></span><br><span class="line">        <span class="comment">//2. æ­¤æ—¶è¿›å…¥çš„éƒ½æ˜¯å±äºå½“å‰guardå®ˆæŠ¤çš„token</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ£€æµ‹ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæ­£å¸¸åˆ™é€šè¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;auth-&gt;parseToken()-&gt;authenticate()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedHttpException(<span class="string">&#x27;jwt-auth&#x27;</span>, <span class="string">&#x27;æœªç™»å½•&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TokenExpiredException <span class="variable">$exception</span>) &#123;</span><br><span class="line">            <span class="comment">// 3. æ­¤å¤„æ•è·åˆ°äº† token è¿‡æœŸæ‰€æŠ›å‡ºçš„ TokenExpiredException å¼‚å¸¸ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦åšçš„æ˜¯åˆ·æ–°è¯¥ç”¨æˆ·çš„ token å¹¶å°†å®ƒæ·»åŠ åˆ°å“åº”å¤´ä¸­</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ·æ–°ç”¨æˆ·çš„ token</span></span><br><span class="line">                <span class="variable">$token</span> = <span class="keyword">$this</span>-&gt;auth-&gt;refresh();</span><br><span class="line">                <span class="comment">// ä½¿ç”¨ä¸€æ¬¡æ€§ç™»å½•ä»¥ä¿è¯æ­¤æ¬¡è¯·æ±‚çš„æˆåŠŸ</span></span><br><span class="line">                Auth::onceUsingId(<span class="keyword">$this</span>-&gt;auth-&gt;manager()-&gt;getPayloadFactory()-&gt;buildClaimsCollection()-&gt;toPlainArray()[<span class="string">&#x27;sub&#x27;</span>]);</span><br><span class="line">                <span class="comment">//åˆ·æ–°äº†tokenï¼Œå°†tokenå­˜å…¥æ•°æ®åº“</span></span><br><span class="line">                <span class="variable">$user</span> = Auth::user();</span><br><span class="line">                <span class="variable">$user</span>-&gt;last_token = <span class="variable">$token</span>;</span><br><span class="line">                <span class="variable">$user</span>-&gt;save();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JWTException <span class="variable">$exception</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ•è·åˆ°æ­¤å¼‚å¸¸ï¼Œå³ä»£è¡¨ refresh ä¹Ÿè¿‡æœŸäº†ï¼Œç”¨æˆ·æ— æ³•åˆ·æ–°ä»¤ç‰Œï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedHttpException(<span class="string">&#x27;jwt-auth&#x27;</span>, <span class="variable">$exception</span>-&gt;getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨å“åº”å¤´ä¸­è¿”å›æ–°çš„ token</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;setAuthenticationHeader(<span class="variable">$next</span>(<span class="variable">$request</span>), <span class="variable">$token</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-10-4-æµ‹è¯•"><a href="#5-10-4-æµ‹è¯•" class="headerlink" title="5.10.4. æµ‹è¯•"></a>5.10.4. æµ‹è¯•</h3><p>æˆ‘ä»¬å…ˆç™»é™†ä¸€æ¬¡<code>/api/v1/admin/login</code>ï¼Œå°†è·å–åˆ°<code>token</code>æºå¸¦è®¿é—®<code>/api/v1/admins/info</code>ã€‚æ­£å¸¸è®¿é—®ã€‚<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/iKyPgwRhQA.png!large" alt="file"><br>å½“æˆ‘ä»¬å†æ¬¡è¯·æ±‚ç™»é™†<code>/api/v1/admin/login</code>ï¼Œç„¶åç»§ç»­ç”¨åŸ<code>token</code>è®¿é—®<code>/api/v1/admins/info</code>ï¼Œæç¤ºé”™è¯¯ã€‚<br><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/UFUGdXLbKX.png!large" alt="file"></p>
<blockquote>
<p>userçš„è¯·è‡ªè¡Œæ·»åŠ ï¼Œè‡ªè¡Œæµ‹è¯•ç»“æœ</p>
</blockquote>
<h2 id="5-11-horizonç®¡ç†å¼‚æ­¥é˜Ÿåˆ—"><a href="#5-11-horizonç®¡ç†å¼‚æ­¥é˜Ÿåˆ—" class="headerlink" title="5.11. horizonç®¡ç†å¼‚æ­¥é˜Ÿåˆ—"></a>5.11. horizonç®¡ç†å¼‚æ­¥é˜Ÿåˆ—</h2><p>å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿç»å¸¸éœ€è¦ä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—ï¼Œæ¥åŠ å¿«æˆ‘ä»¬çš„å“åº”é€Ÿåº¦ã€‚æ¯”å¦‚å‘é€çŸ­ä¿¡ï¼Œå‘é€éªŒè¯ç ç­‰ã€‚ä½†æ˜¯é˜Ÿåˆ—æ‰§è¡Œç»“æœçš„æˆåŠŸæˆ–è€…å¤±è´¥åªèƒ½é€šè¿‡æ—¥å¿—æ¥æŸ¥çœ‹ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨<code>horizon</code>æ¥ç®¡ç†å¼‚æ­¥é˜Ÿåˆ—ï¼Œå®Œæˆç™»é™†å’Œåˆ·æ–°<code>token</code>æ—¶ï¼Œå°†<code>token</code>å­˜å…¥<code>last_token</code>çš„å› ä¸ºæ”¾åœ¨å¼‚æ­¥å®Œæˆã€‚</p>
<blockquote>
<p>Horizon æä¾›äº†ä¸€ä¸ªæ¼‚äº®çš„ä»ªè¡¨ç›˜ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ä»£ç é…ç½®ä½ çš„ Laravel Redis é˜Ÿåˆ—ï¼ŒåŒæ—¶å®ƒå…è®¸ä½ è½»æ˜“çš„ç›‘æ§ä½ çš„é˜Ÿåˆ—ç³»ç»Ÿä¸­è¯¸å¦‚ä»»åŠ¡ååé‡ï¼Œè¿è¡Œæ—¶é—´å’Œå¤±è´¥ä»»åŠ¡ç­‰å…³é”®æŒ‡æ ‡ã€‚</p>
</blockquote>
<h3 id="5-11-1-å®‰è£…"><a href="#5-11-1-å®‰è£…" class="headerlink" title="5.11.1. å®‰è£…"></a>5.11.1. å®‰è£…</h3><p><code>horizon</code>çš„è¯¦ç»†ä»‹ç»å¯ä»¥<a href="https://learnku.com/docs/laravel/5.7/horizon/2308">æŸ¥çœ‹æ‰‹å†Œ</a>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer require laravel&#x2F;horizon</span><br></pre></td></tr></table></figure>
<h3 id="5-11-2-å‘å¸ƒé…ç½®æ–‡ä»¶"><a href="#5-11-2-å‘å¸ƒé…ç½®æ–‡ä»¶" class="headerlink" title="5.11.2. å‘å¸ƒé…ç½®æ–‡ä»¶"></a>5.11.2. å‘å¸ƒé…ç½®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan vendor:publish --provider&#x3D;&quot;Laravel\Horizon\HorizonServiceProvider&quot;</span><br></pre></td></tr></table></figure>
<h3 id="5-11-3-ä¿®æ”¹é˜Ÿåˆ—é©±åŠ¨"><a href="#5-11-3-ä¿®æ”¹é˜Ÿåˆ—é©±åŠ¨" class="headerlink" title="5.11.3. ä¿®æ”¹é˜Ÿåˆ—é©±åŠ¨"></a>5.11.3. ä¿®æ”¹é˜Ÿåˆ—é©±åŠ¨</h3><p>æ‰“å¼€ <code>.env</code> æ–‡ä»¶ï¼Œå°†<code>QUEUE_CONNECTION</code>ä»<code>sync</code>æ”¹æˆ<code>redis</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">QUEUE_CONNECTION&#x3D;redis</span><br></pre></td></tr></table></figure>
<h3 id="5-11-4-ä»ªè¡¨ç›˜æƒé™éªŒè¯"><a href="#5-11-4-ä»ªè¡¨ç›˜æƒé™éªŒè¯" class="headerlink" title="5.11.4. ä»ªè¡¨ç›˜æƒé™éªŒè¯"></a>5.11.4. ä»ªè¡¨ç›˜æƒé™éªŒè¯</h3><p>ä»ªè¡¨ç›˜ä¸èƒ½é€šè¿‡æ¥å£è®¿é—®ã€‚æ‰€ä»¥æˆ‘ä»¬åšéªŒè¯çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šçš„<code>IP</code>æ‰èƒ½æ­£å¸¸é€šè¿‡è¿›å…¥ä»ªè¡¨ç›˜ã€‚<code>IP</code>å¯ä»¥å†™åœ¨<code>.env</code>æ–‡ä»¶é‡Œï¼Œå½“IPå‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>åœ¨ <code>.env</code> æœ€ååŠ ä¸Šä¸€è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HORIZON_IP&#x3D;æƒ³é€šè¿‡è®¿é—®çš„IPåœ°å€</span><br><span class="line">æ¯”å¦‚</span><br><span class="line">HORIZON_IP&#x3D;127.0.0.1</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹ <code>app/Providers/AuthServiceProvider.php</code> æ–‡ä»¶ é‡Œçš„ <code>boot</code> æ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerPolicies();</span><br><span class="line">    Horizon::auth(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(env(<span class="string">&#x27;APP_ENV&#x27;</span>,<span class="string">&#x27;local&#x27;</span>) ==<span class="string">&#x27;local&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$get_ip</span>=<span class="variable">$request</span>-&gt;getClientIp();</span><br><span class="line">            <span class="variable">$can_ip</span>=env(<span class="string">&#x27;HORIZON_IP&#x27;</span><span class="string">&#x27;127.0.0.1&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$get_ip</span> == <span class="variable">$can_ip</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-11-5-ç¼–å†™ä»»åŠ¡ç±»"><a href="#5-11-5-ç¼–å†™ä»»åŠ¡ç±»" class="headerlink" title="5.11.5. ç¼–å†™ä»»åŠ¡ç±»"></a>5.11.5. ç¼–å†™ä»»åŠ¡ç±»</h3><p>åˆ›å»ºä¸€ä¸ªä¸“é—¨è´Ÿè´£ä¿å­˜<code>last_token</code>çš„ä»»åŠ¡ç±»</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan make:job Api&#x2F;SaveLastTokenJob</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€ <code>app/Jobs/Api/SaveLastTokenJob.php</code> æ–‡ä»¶ ï¼Œå¡«å†™ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Jobs</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>\<span class="title">Queueable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">InteractsWithQueue</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queue</span>\<span class="title">ShouldQueue</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Bus</span>\<span class="title">Dispatchable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SaveLastTokenJob</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Dispatchable</span>, <span class="title">InteractsWithQueue</span>, <span class="title">Queueable</span>, <span class="title">SerializesModels</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$token</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new job instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$model</span>,<span class="variable">$token</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;model=<span class="variable">$model</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=<span class="variable">$token</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the job.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;model-&gt;last_token = <span class="keyword">$this</span>-&gt;token;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;model-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-11-6-ä½¿ç”¨ä»»åŠ¡ç±»"><a href="#5-11-6-ä½¿ç”¨ä»»åŠ¡ç±»" class="headerlink" title="5.11.6. ä½¿ç”¨ä»»åŠ¡ç±»"></a>5.11.6. ä½¿ç”¨ä»»åŠ¡ç±»</h3><p>å°†æ§åˆ¶å™¨ä¸ä¸­é—´ä»¶é‡Œçš„</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$user</span>-&gt;last_token = <span class="variable">$token</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;save();</span><br></pre></td></tr></table></figure>
<p>ç»Ÿä¸€æ›¿æ¢ä¸º</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">SaveLastTokenJob::dispatch(<span class="variable">$user</span>,<span class="variable">$token</span>);</span><br></pre></td></tr></table></figure>
<h3 id="5-11-7-è¿è¡ŒHorizon"><a href="#5-11-7-è¿è¡ŒHorizon" class="headerlink" title="5.11.7. è¿è¡ŒHorizon"></a>5.11.7. è¿è¡ŒHorizon</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php artisan horizon</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œè¿›ç¨‹å¤„äºé˜»å¡çŠ¶æ€ã€‚<br>æ‰“å¼€æµè§ˆå™¨è¾“å…¥<code>http://ä½ çš„åŸŸå/horizon</code>,å¯ä»¥çœ‹åˆ°<code>Horizon</code>ä»ªè¡¨ç›˜ã€‚</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/F8zh35QvCg.png!large" alt="file"></p>
<h3 id="5-11-8-Supervisorå®ˆæŠ¤è¿›ç¨‹"><a href="#5-11-8-Supervisorå®ˆæŠ¤è¿›ç¨‹" class="headerlink" title="5.11.8. Supervisorå®ˆæŠ¤è¿›ç¨‹"></a>5.11.8. Supervisorå®ˆæŠ¤è¿›ç¨‹</h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Supervisoræ¥å®ˆæŠ¤æˆ‘ä»¬çš„horizoné˜»å¡è¿›ç¨‹ã€‚å…·ä½“æ–¹æ³•å¯ä»¥çœ‹æˆ‘ä¹‹å‰å†™çš„æ–‡ç« :<a href="https://www.guaosi.com/2019/02/25/install-and-use-supervisor/">å®‰è£…å’Œä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹â€“Supervisor</a></p>
<h3 id="5-11-9-æµ‹è¯•"><a href="#5-11-9-æµ‹è¯•" class="headerlink" title="5.11.9. æµ‹è¯•"></a>5.11.9. æµ‹è¯•</h3><p>ç¡®è®¤<code>horizon</code>å·²ç»æ­£å¸¸å¯åŠ¨ã€‚ç„¶åæˆ‘ä»¬è®¿é—®<code>/api/v1/admin/login</code>è¿™ä¸ªç™»é™†æ¥å£ã€‚æ‰“å¼€æ•°æ®åº“å¯ä»¥å‘ç°ï¼Œ<code>last_token</code>ä¸è¿”å›ç»“æœçš„<code>token</code>ç›¸åŒã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å†æ‰“å¼€ä»ªè¡¨ç›˜ï¼Œçœ‹ä»»åŠ¡å®Œæˆæƒ…å†µ</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/22/21588/GyWOWZB1Fg.png!large" alt="file"></p>
<h3 id="5-11-10-æ³¨æ„"><a href="#5-11-10-æ³¨æ„" class="headerlink" title="5.11.10. æ³¨æ„"></a>5.11.10. æ³¨æ„</h3><p>å¦‚æœä¿®æ”¹äº†<code>job</code>ç±»çš„æºç ï¼Œéœ€è¦å°†<code>horizon</code>é‡æ–°å¯åŠ¨ï¼Œå¦åˆ™ä»£ç è¿˜æ˜¯æœªæ”¹åŠ¨å‰çš„ã€‚(åº”è¯¥æ˜¯<code>horzion</code>æ˜¯å°†æ‰€æœ‰ä»»åŠ¡ç±»å¸¸é©»å†…å­˜çš„åŸå› )</p>
<h1 id="6-æˆå“"><a href="#6-æˆå“" class="headerlink" title="6. æˆå“"></a>6. æˆå“</h1><p>åˆ°æ­¤ï¼Œæ‰€æœ‰ä¿®æ”¹å·²ç»å…¨éƒ¨å®Œæˆï¼Œå¦‚æœè¿˜æœ‰æ–°çš„æ›´æ”¹ä¹Ÿä¼šå®æ—¶æ›´æ–°ã€‚åŒæ—¶ï¼Œæœ¬æ–‡ä¸­çš„æ‰€æœ‰ä¿®æ”¹éƒ½å·²ç»åœ¨æ­£å¼é¡¹ç›®ä¸­è¿è¡Œè¿‡äº†ã€‚</p>
<p>å¦‚æœä½ å·²ç»çœ‹å®Œäº†æ•´ç¯‡æ–‡ç« ï¼ŒçŸ¥é“äº†ä¿®æ”¹çš„åŸå› ï¼Œä½†æ˜¯ä¸æƒ³å—ç´¯è‡ªå·±ä¿®æ”¹ä¸€éã€‚æˆ‘å·²ç»å°†ä¿®æ”¹åçš„ä¸Šä¼ åˆ°å…¨çƒæœ€å¤§çš„åŒæ€§äº¤å‹ç½‘ç«™äº†ï¼Œå¯ä»¥ç›´æ¥ç‚¹å‡»<a href="https://github.com/guaosi/Laravel_api_init">è¿™é‡Œ</a>ç›´æ¥æ¬èµ°ã€‚æˆ–è€…å¤åˆ¶ä¸‹æ–¹çš„é“¾æ¥æ‰“å¼€ã€‚</p>
<p>é¡¹ç›®åœ°å€: <a href="https://github.com/guaosi/Laravel_api_init">https://github.com/guaosi/Laravel_api_init</a></p>
<blockquote>
<p>æœ¬æ–‡è½¬è½½è‡ª <a href="https://www.guaosi.com/2019/02/26/laravel-api-initialization-preparation/">https://www.guaosi.com/2019/02/26/laravel-api-initialization-preparation/</a></p>
</blockquote>
]]></content>
      <categories>
        <category>Laravel</category>
      </categories>
      <tags>
        <tag>Laravel</tag>
        <tag>è½¬è½½</tag>
      </tags>
  </entry>
</search>
